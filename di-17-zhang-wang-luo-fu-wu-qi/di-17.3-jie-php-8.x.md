# 17.3 PHP 8.x

## 安装 PHP

- 使用 pkg 安装：

```sh
# pkg install php84 php84-extensions mod_php84
```

> **技巧**
>
> 不同的 PHP 模块之间可能存在冲突，这会导致 Ports 编译失败，因此不建议选择所有 PHP 插件选项。推荐使用 pkg 进行安装。

- 或者使用 ports 安装：

```sh
# cd /usr/ports/lang/php84/ && make install clean
# cd /usr/ports/lang/php84-extensions/ && make install clean
# cd /usr/ports/www/mod_php84 && make install clean
```

- 显示已安装 PHP 的版本信息：

```sh
# php -v
PHP 8.4.4 (cli) (built: Feb 15 2025 01:05:08) (NTS)
Copyright (c) The PHP Group
Zend Engine v4.4.4, Copyright (c) Zend Technologies
```

> **注意**
>
>数字 `84` 可能会随 PHP 版本变化而不同。可以使用以下命令查看当前可用的 PHP 版本后再进行安装。
>
>```sh
># pkg search -o lang/php    # 在 FreeBSD Ports/Packages 中搜索以 lang/php 开头的包
>lang/php-mode.el               PHP mode for GNU Emacs
>lang/php-mode.el               PHP mode for GNU Emacs
>lang/php-mode.el               PHP mode for GNU Emacs
>lang/php-mode.el               PHP mode for GNU Emacs
>lang/php81                     PHP Scripting Language (8.1.X branch)
>lang/php81-extensions          "meta-port" to install PHP extensions
>lang/php82                     PHP Scripting Language (8.2.X branch)
>lang/php82-extensions          "meta-port" to install PHP extensions
>lang/php83                     PHP Scripting Language (8.3.X branch)
>lang/php83-extensions          "meta-port" to install PHP extensions
>lang/php84                     PHP Scripting Language (8.4.X branch)
>lang/php84-extensions          "meta-port" to install PHP extensions (8.4.X branch)
>```


## 配置 PHP 守护进程

PHP 的示例配置文件位于 `/usr/local/etc/php.ini-production`。

将生产环境的 PHP 配置文件复制为默认配置文件，并显示复制过程：

```sh
# cp -v /usr/local/etc/php.ini-production /usr/local/etc/php.ini
/usr/local/etc/php.ini-production -> /usr/local/etc/php.ini
```

- 设置 PHP-FPM 服务开机自启：

```sh
# service php_fpm enable
php_fpm enabled in /etc/rc.conf
```

- 启动 PHP-FPM 服务：

```sh
# service php_fpm start
Performing sanity check on php-fpm configuration:
[25-Feb-2025 20:28:32] NOTICE: configuration file /usr/local/etc/php-fpm.conf test is successful
Starting php_fpm.
```

- 查看 PHP-FPM 服务当前状态：

```sh
# service php_fpm status
php_fpm is running as pid 2592.
```

- 查看安装后信息：

```sh
# pkg info -D mod_php84
mod_php84-8.4.4_1:
On install:
******************************************************************************

Consider switching to php-fpm and mod_fast_cgi as per Apache httpd project
recommendation. See https://cwiki.apache.org/confluence/display/HTTPD/PHP-FPM
建议根据 Apache httpd 项目的推荐，切换到 php-fpm 和 mod_fast_cgi。详情请见 https://cwiki.apache.org/confluence/display/HTTPD/PHP-FPM

******************************************************************************

If you are building PHP-based ports in poudriere(8) or Synth with ZTS enabled,
add WITH_MPM=event to /etc/make.conf to prevent build failures.
如果你在 poudriere(8) 或 Synth 中构建启用了 ZTS 的 PHP 基础端口，请将 WITH_MPM=event 添加到 /etc/make.conf，以防止构建失败。

******************************************************************************

Make sure index.php is part of your DirectoryIndex.
确保 index.php 是 DirectoryIndex 的一部分。

You should add the following to your Apache configuration file:
你应该将以下内容添加到你的 Apache 配置文件中：

<FilesMatch "\.php$">
    SetHandler application/x-httpd-php
</FilesMatch>
<FilesMatch "\.phps$">
    SetHandler application/x-httpd-php-source
</FilesMatch>

******************************************************************************
```

### 参考资料

- [Install PHP 8.0 on FreeBSD 13 / FreeBSD 12](https://computingforgeeks.com/how-to-install-php-8-on-freebsd-system/)
- [PHP-FPM(8)](https://man.freebsd.org/cgi/man.cgi?query=php-fpm)，man 页面
- [Apache and PHP](https://forums.freebsd.org/threads/apache-and-php.80625/)，此处提示要安装 `mod_php84`

## 面向 Apache 的 PHP 配置文件

编辑 `/usr/local/etc/apache24/Includes/php.conf` 文件，添加

```php
<FilesMatch "\.php$">                           # 匹配以 .php 结尾的文件
    SetHandler application/x-httpd-php          # 将匹配文件交由 PHP 处理
</FilesMatch>
<FilesMatch "\.phps$">                          # 匹配以 .phps 结尾的文件
    SetHandler application/x-httpd-php-source   # 将匹配文件作为 PHP 源代码显示
</FilesMatch>
```

编辑 `/usr/local/www/apache24/data/info.php`，加入：

```php
<?php
    phpinfo();
?>
```

用于输出当前 PHP 的配置信息和运行环境。

重启服务：

```sh
# service php_fpm restart   # 重启 PHP-FPM 服务
# service apache24 restart  # 重启 Apache 24 服务
```

访问 `ip/info.php`，如 `http://192.168.179.150/info.php`：

![Apache PHP8 FreeBSD](../.gitbook/assets/php1.png)

### 参考文献

- [Install PHP 8.0 on FreeBSD 13 / FreeBSD 12](https://computingforgeeks.com/how-to-install-php-8-on-freebsd-system/)，文章主体框架在此

## 面向 Nginx 的 PHP 配置文件

- 编辑 `/usr/local/etc/nginx/nginx.conf` 文件：

删除以下行中的所有注释符号 `#`：


```ini
        #location ~ \.php$ {
        #    root           html;
        #    fastcgi_pass   127.0.0.1:9000;
        #    fastcgi_index  index.php;
        #    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;
        #    include        fastcgi_params;
        #}
```

即修改如下：

```ini
location ~ \.php$ {                                 # 匹配 .php 文件请求
    root           /usr/local/www/nginx;           # 网站根目录，请根据实际路径修改
    fastcgi_pass   127.0.0.1:9000;                 # FastCGI 服务地址
    fastcgi_index  index.php;                       # 默认 FastCGI 索引文件
    fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;  # PHP 脚本完整路径，其中 $document_root 表示网站根目录
    include        fastcgi_params;                 # 引入 FastCGI 参数文件
}
```

- 编辑 `/usr/local/www/nginx/info.php` 文件，加入

```php
<?php
    phpinfo();
?>
```

用于显示当前 PHP 的配置信息及运行环境。

- 重启服务：

```sh
# service php_fpm restart    # 重启 PHP-FPM 服务以应用配置更改
Performing sanity check on php-fpm configuration:
[25-Feb-2025 20:59:12] NOTICE: configuration file /usr/local/etc/php-fpm.conf test is successful
Starting php_fpm.
# service nginx restart    # 重启 Nginx 服务以应用配置更改
Performing sanity check on nginx configuration:
nginx: the configuration file /usr/local/etc/nginx/nginx.conf syntax is ok
nginx: configuration file /usr/local/etc/nginx/nginx.conf test is successful
Stopping nginx.
Waiting for PIDS: 1153.
Performing sanity check on nginx configuration:
nginx: the configuration file /usr/local/etc/nginx/nginx.conf syntax is ok
nginx: configuration file /usr/local/etc/nginx/nginx.conf test is successful
Starting nginx.
```

访问 `IP/info.php`，如 `http://192.168.179.150/info.php`：

![Apache PHP8 FreeBSD](../.gitbook/assets/php2.png)

### 参考文献

- [How to Install PHP and PHP-FPM on FreeBSD 14.0](https://docs.vultr.com/how-to-install-php-and-php-fpm-on-freebsd-14-0)。本文主要参考本文
