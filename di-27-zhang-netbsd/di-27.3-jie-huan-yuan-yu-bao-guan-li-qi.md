# 27.3 NetBSD 换源和包管理器

NetBSD 的包管理器是 pkgsrc，同时支持二进制安装和从源代码编译安装。其二进制管理命令包括 `pkg_*`（例如 `pkg_add`）和 `pkgin`。


## 二进制软件源配置

以 NetBSD 10.1 为例换二进制源：



设置 pkgin 软件仓库为清华大学镜像源：

```sh
# echo https://mirrors.tuna.tsinghua.edu.cn/pkgsrc/packages/NetBSD/amd64/10.1/All/  > /usr/pkg/etc/pkgin/repositories.conf
```

设置 pkgin 软件仓库为南京大学开源镜像源：

```sh
# echo https://mirrors.nju.edu.cn/pkgsrc/packages/NetBSD/x86_64/10.1/All/  > /usr/pkg/etc/pkgin/repositories.conf
```

>**思考题**
>
>请读者思考为什么上述软件源路径中一个架构 `x86_64` 而另外一个却是 `amd64`？

需要注意的是 NetBSD 的软件源较为分散，有时单个源无法满足需求，需要尝试多个源。可通过搜索“包名+netbsd.org”，例如“kde4 netbsd.org”，访问类似 [https://cdn.netbsd.org/pub/pkgsrc/current/pkgsrc/print/libcups/index.html](https://cdn.netbsd.org/pub/pkgsrc/current/pkgsrc/print/libcups/index.html) 的官方域名获取相应包。

由于二进制包的构建可能存在差异，NetBSD 用户经常需要在以下源之间切换：

```sh
# echo http://mirrors.nju.edu.cn/pkgsrc/packages/NetBSD/x86_64/10.0_2024Q4/All/  > /usr/pkg/etc/pkgin/repositories.conf  # 设置 pkgin 软件仓库为南京大学镜像源，适用于 NetBSD 10.0_2024Q4
```

## 关闭 ABI 检测（可选）

使用 pkgin 安装软件时，NetBSD 默认会检测 ABI 版本。由于软件包更新可能不及时，这可能导致某些软件包无法安装，因此可以通过以下方式运行：

```sh
# echo CHECK_OSABI=no >> /etc/pkg_install.conf
```

在 `pkg_install` 配置中禁用 OSABI 检查，从而允许跨版本安装软件包。


## pkgsrc 编译安装

与 FreeBSD 相似：

```sh
# cd /usr/pkgsrc/meta-pkgs/kde  # 进入 pkgsrc 中 KDE 元包目录
# ls  # 列出该目录下的文件和子目录
CVS               Makefile          applications.mk   kf6.mk            plasma6.mk
DESCR             Makefile.common   kf5.mk            plasma5.mk
# make install clean  # 编译安装当前 pkgsrc 包并清理临时文件
===> Installing dependencies for kde-20240828
=> Tool dependency mktools-[0-9]*: NOT found
=> Verifying reinstall for ../../pkgtools/mktools
===> Installing dependencies for mktools-20250213

……以下构建过程省略……

```

## pkgsrc-wip 项目

pkgsrc-wip 包含许多尚未完成的项目，但其中的许多软件依赖这些项目。

```sh
# mkdir -p /usr/pkgsrc/                         # 如果 /usr/pkgsrc 目录不存在，则创建该目录
# cd /usr/pkgsrc/                                # 进入 /usr/pkgsrc 目录
# pkgin install git                              # 使用 pkgin 安装 Git
# git config --global http.proxy http://192.168.31.77:7890   # 设置 Git HTTP 代理（请根据实际可用代理修改）
# git config --global https.proxy http://192.168.31.77:7890  # 设置 Git HTTPS 代理（请根据实际可用代理修改）
# git clone --depth 1 https://github.com/NetBSD/pkgsrc-wip wip   # 将 pkgsrc-wip 仓库克隆到 wip 目录，仅获取最新提交
```

## 参考文献

- [pkgsrc 镜像使用帮助](https://mirrors.tuna.tsinghua.edu.cn/help/pkgsrc/)，换源方式
- [pkgsrc 与 IPS](https://nanxiao.me/pkgsrc-ang-ips/)，基本常识
- [The pkgsrc-wip project](https://pkgsrc.org/wip)，pkgsrc 官方使用说明
- [pkgsrc](https://www.pkgsrc.org/)，官方安装说明
