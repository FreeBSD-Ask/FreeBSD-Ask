# 第 30.5 节 Linux 兼容层——基于 archlinux-pacman

## 有待补充

- 使用 `pikaur` 开启 AUR 包的安装和管理
- 解析一下 FreeBSD Linuxulator 路径翻译过程当中存在的一些 magic
- 以及我们应该如何利用这一机制来提高生产力

## Arch Linux 兼容层安装步骤

1. 使用 pkg 安装 `archlinux-pacman` 软件包

```
# pkg install archlinux-pacman archlinux-keyring
```

2. 编辑 `pacman.conf` 来加入 Arch Linux 的软件仓库

```
# ee /usr/local/etc/pacman.conf

[core]
Server = https://opentuna.cn/archlinux/core/os/x86_64

[extra]
Server = https://opentuna.cn/archlinux/extra/os/x86_64
```

3. 创建软链接将 `/compat/linux` 指向 `/compat/archlinux` 并启动 linux 服务

```
# ln -s archlinux /compat/linux
# service linux enable && service linux start
```

这样做的好处在于你不需要通过手动编辑 FreeBSD 层的 `/etc/fstab` 来实现 Linux 文件系统的自动挂载，也不需要配置 `compat.linux.emul_path` 选项

> 即使是在 `/etc/sysctl.conf` 里设置了 `compat.linux.emul_path` ，也会因为 `linux` 这个服务的启动时机要早于 `sysctl.conf` 里面的设置被加载的时机，从而导致重启后各个 Linux 文件系统还是去了 `/compat/linux` 下。然后必须在系统重启完毕后手动重启 `linux` 服务才能使 `compat.linux.emul_path` 的设置生效
> 
> 因此直接做软链接是事实上最简单、有效的

4. 使用 pacman 安装 Arch Linux 基本系统

```
# pacman -Sy base
```

5. 使用 mount 将 FreeBSD 层的 `/etc/resolv.conf` 绑定至 Arch Linux 兼容层内

```
# mount -t nullfs -o ro /etc/resolv.conf /compat/archlinux/etc/resolv.conf
```

跳过这一步会导致运行在 Arch Linux 兼容层内的应用程序无法正常执行 DNS 解析，以至于 Linux 应用程序无法上网

6. 使用 mount 将 FreeBSD 层的 `/etc/passwd` 和 `/etc/group` 绑定至 Arch Linux 兼容层内

```
# mount -t nullfs -o ro /etc/passwd /compat/archlinux/etc/passwd
# mount -t nullfs -o ro /etc/group /compat/archlinux/etc/group
```

跳过这一步会导致在 Arch Linux 兼容层内的应用程序无法识别你在 FreeBSD 层的用户名，以至于部分 Linux 应用程序把你的用户名显示为 `I have no name!`

## 关于兼容层的使用

1. 理论上这个时候你已经可以在去下载一些原本只支持 Linux 的应用程序然后直接尝试在 FreeBSD 层运行了，因为这时候 FreeBSD 会自动调用 Arch Linux 兼容层里的 `glibc` 和其他动态链接库

2. 但是如果你认为你自己的确有必要使用 Arch Linux 兼容层的 chroot 环境，你也可以用 chroot 命令进入

```
# chroot /compat/archlinux bash

(chroot) # uname -srv
Linux 4.4.0 FreeBSD 13.2-RELEASE releng/13.2-n254617-525ecfdad597 GENERIC
```

3. 你可以把上面涉及到的所有绑定操作放到 FreeBSD 层的 `/etc/fstab` 中去

```
# vi /etc/fstab

# Device          Mountpoint                         FStype  Options  Dump  Pass#
/etc/resolv.conf  /compat/archlinux/etc/resolv.conf  nullfs  ro       0     0
/etc/passwd       /compat/archlinux/etc/passwd       nullfs  ro       0     0
/etc/group        /compat/archlinux/etc/group        nullfs  ro       0     0
```
