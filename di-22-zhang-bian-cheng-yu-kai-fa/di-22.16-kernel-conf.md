# 22.16 FreeBSD 内核配置选项

## 内核配置选项路径

- amd64 内核配置选项位于 [freebsd-src/main/sys/amd64/conf](https://github.com/freebsd/freebsd-src/tree/main/sys/amd64/conf)。
- Arm64 内核配置选项位于 [freebsd-src/main/sys/arm64/conf](https://github.com/freebsd/freebsd-src/tree/main/sys/arm64/conf)。
- RISC-V 内核配置选项位于 [freebsd-src/main/sys/riscv/conf](https://github.com/freebsd/freebsd-src/tree/main/sys/riscv/conf)

## amd64 内核配置文件

介绍  [freebsd-src/main/sys/amd64/conf](https://github.com/freebsd/freebsd-src/tree/main/sys/amd64/conf)：

- `DEFAULTS`：FreeBSD/amd64 的默认内核配置文件，只有不到 30 行
- `FIRECRACKER`：面向 [Firecracker](https://firecracker-microvm.github.io/) VM 的内核配置文件，参见 [amd64: Add FIRECRACKER kernel configuration](https://reviews.freebsd.org/D36672)
- `GENERIC`：FreeBSD/amd64 通用内核配置文件，所有 amd64 镜像默认基于此。350 余行。
- `GENERIC-KASAN`：调试开发用。参见 [amd64: Add MD bits for KASAN](https://reviews.freebsd.org/D29455)。用于 KASAN（Kernel Address SANitizer，内核地址清理器），参见 [kasan(9)](https://man.freebsd.org/cgi/man.cgi?query=kasan&sektion=9&format=html)，只有不到十行
- `GENERIC-KCSAN`：调试开发用。KCSAN（Kernel Concurrency Sanitizer，内核并发清理器）。30 余行，参见 [Port the NetBSD KCSAN runtime to FreeBSD](https://reviews.freebsd.org/D22315)
- `GENERIC-KMSAN`：调试开发用。不到十行。KMSAN（Kernel Memory SANitizer，内核内存清理器）参见 [KMSAN(9)](https://man.freebsd.org/cgi/man.cgi?query=kmsan&sektion=9&format=html)
- `GENERIC-MMCCAM`：调试开发用。使用 MMCCAM 代替 MMC 栈。不到二十行。参见 [MMC stack on top of CAM framework](https://reviews.freebsd.org/D4761)。
- `GENERIC-NODEBUG`：该文件仅在 [main](https://github.com/freebsd/freebsd-src/blob/main) 分支中存在，用于基准测试。三十余行。基于 GENERIC 配置文件，但是删掉了 [WITNESS (4)](https://man.freebsd.org/cgi/man.cgi?witness(4))（跟踪每个线程获取和释放的锁）和 [INVARIANTS(9)](https://man.freebsd.org/cgi/man.cgi?KASSERT(9))（内核表达式验证宏）。因为 CURRENT 的 GENERIC [默认启用](https://github.com/freebsd/freebsd-src/blob/main/UPDATING) 了上述调试功能，而它们会对系统性能产生影响——通过 `include "std.debug"` 引入，参见 [sys/amd64/conf: unify MINIMAL and GENERIC debug](https://github.com/freebsd/freebsd-src/pull/1124)、[sys/conf/std.debug](https://github.com/freebsd/freebsd-src/blob/main/sys/conf/std.debug)。
- `GENERIC.hints`：一些 [hints](https://man.freebsd.org/device.hints) 参数。二十余行。用于设置驱动的参数。
- `LINT`：LINT 文件，参见 [Eliminate building LINT makefiles](https://reviews.freebsd.org/D26540)，用于验证代码风格格式等。不到五行。
- `LINT-NOINET`：LINT 文件，不到五行，禁用了 [INET(4)](https://man.freebsd.org/cgi/man.cgi?query=inet&sektion=4&man)（IPv4）。LINT 文件，参见 [Eliminate building LINT makefiles](https://reviews.freebsd.org/D26540)。
- `LINT-NOINET6`：LINT 文件，不到五行，禁用了 [INET(6)](https://man.freebsd.org/cgi/man.cgi?query=inet6&sektion=4&man)（IPv6）。LINT 文件，参见 [Eliminate building LINT makefiles](https://reviews.freebsd.org/D26540)。
- `LINT-NOIP`：LINT 文件，不到三十行，禁用了 IP 协议相关（IPv4、IPv6、TLS 等）。LINT 文件，参见 [Eliminate building LINT makefiles](https://reviews.freebsd.org/D26540)。
- `LINT-NOVIMAGE`：调试开发用。LINT 文件，不到五行，禁用了 [VIMAGE (9)](https://man.freebsd.org/cgi/man.cgi?query=vimage&sektion=9)（实际上是 VNET(9) 的别名，网络子系统虚拟化基础设施）。参见 [sys: add LINT-NOVIMAGE](https://reviews.freebsd.org/D50780)
- `MINIMAL`：FreeBSD/amd64 中最常用的最简内核配置选项。160 余行。
- `MINIMAL-NODEBUG`：等同于 GENERIC-NODEBUG，只不过是 `MINIMAL` 版本的。不到 15 行。

## 内核选项说明文件

- [freebsd-src/main/sys/amd64/conf/NOTES](https://github.com/freebsd/freebsd-src/blob/main/sys/amd64/conf/NOTES)：amd64 机器相关的内核配置说明文件。不到 200 行。
- [freebsd-src/main/sys/x86/conf/NOTES](https://github.com/freebsd/freebsd-src/blob/main/sys/x86/conf/NOTES)：i386 和 amd64 共用的机器相关配置。650 余行。
- [freebsd-src/main/sys/conf/NOTES](https://github.com/freebsd/freebsd-src/blob/main//sys/conf/NOTES)：机器无关的说明，近 2900 行。

## amd64 机器相关的内核配置选项

原文：[freebsd-src/main/sys/amd64/conf/NOTES](https://github.com/freebsd/freebsd-src/blob/main/sys/amd64/conf/NOTES)，版本 [mpi3mr: Broadcom's MPT-Fusion version 4 is amd64 and aarch64 only](https://github.com/freebsd/freebsd-src/commit/2f721943bf20e53b0ba7b5032a2900d0beb67413)。

>**技巧**
>
>可直接剪切/粘贴内核和 hints 条目到内核配置文件中。


### GCOV (生成覆盖率信息)

```sh
options 	LINDEBUGFS # ①
options 	GCOV # ②
```

- ① 用于调试的 Linux 文件系统，参见 [lindebugfs(5)](https://man.freebsd.org/cgi/man.cgi?query=lindebugfs&sektion=5)
- ② GCOV 实际上是 llvm-cov，参见 [gcov(1)](https://man.freebsd.org/cgi/man.cgi?query=gcov&sektion=1)


### SMP

可选设备：

```sh
device		atpic			# 可选兼容 pic 可编程中断控制器，ISA 相关
device		mptable			# 可选的 MPSPEC 多处理器表 ①
```

- ①：显示多处理器配置表，参见 [mptable(1)](https://man.freebsd.org/cgi/man.cgi?query=mptable&sektion=1)



### CPU

>**技巧**
>
>你必须至少指定一款 CPU（即你打算运行的那款 CPU）；删除那些你不打算使用的 CPU 的配置可能会让系统中的某些部分运行得更快。

```sh
cpu		HAMMER			# HAMMER 是 AMD K8 研发代号，即 Opteron（皓龙）& Athlon64（速龙）
```

### 硬件设备配置


可选设备：

```sh
device		vt_efifb	# EFI framebuffer（帧缓冲）①
```

- ① vt(4) 驱动。参见 [vt(4)](https://man.freebsd.org/cgi/man.cgi?query=vt%284%29&apropos=0&sektion=5)


```sh
device		tdfx			# 启用 3Dfx Voodoo
```

3Dfx Voodoo Graphics、Voodoo II 的 /dev/3dfx 字符设备支持（1990 年代的产品）。将创建设备 `/dev/3dfx0` ，以便与 Glide 实现一起使用。该设备应链接到 `/dev/3dfx` 和 `/dev/voodoo`。请注意，这与 XFree86 的 tdfx DRI 模块不同，完全无关。


#### RAID 适配器

```sh
#device	pst
```

Promise Supertrak SX6000 的设备驱动程序

```sh
device		smartpqi
```

Microsemi smartpqi 控制器。这些控制器有类似 SCSI 的接口，并且需要 CAM 基础设施。


```sh
device		mpi3mr			# LSI-Logic MPT-Fusion 4
```

Broadcom MPT Fusion，第 4 版，仅支持 64 位。

#### 网络接口

```sh
device		axp	    # AMD EPYC 集成网卡，依赖 miibus 模块
device		ixl	    # Intel 700 Series Physical Function，依赖 ice_ddp 模块
device		iavf 	  # Intel Adaptive Virtual Function
device		ice		  # Intel 800 Series Physical Function
device		ice_ddp	# Intel 800 Series DDP Package
device		irdma		# Intel 800 Series RDMA 驱动，依赖 ice 模块
device		qlxgb		# QLogic 3200/8200 10Gb 以太网 & CNA 适配器
device		qlxgbe	# QLogic 8300 10Gb 以太网 & CNA 适配器
device		qlxge		# QLogic 8100 系列 10Gb 以太网 & CNA 适配器
device		qlnxe		# QLogic 41000/45000 以太网系列 10/25/40/100 GbE 以太网与 CNA 适配器
device		sfxge		# Solarflare SFC9000 系列 10Gb 以太网
```

#### 其他硬件

```sh
device		ioat		# Intel I/OAT DMA 引擎
```

Intel I/O 加速技术支持

```sh
options 	EFIRT
```

EFI 运行时服务支持

```sh
device		efidev
```

EFI 伪设备

```sh
device		efirtc
```

EFI RTC（实时时钟）

```sh
device		qat_c2xxx
```

带 OpenCrypto 支持的 Intel QuickAssist 驱动，仅支持 Atom C2XXX 芯片组。

```sh
options 	XENHVM		# Xen HVM 内核基础设施
device		xenefi		# Xen EFI 定时器驱动
device 		xenpci		# Xen HVM Hypervisor 服务驱动
device		xentimer	# Xen x86 PV 定时器驱动
```

Xen HVM 虚拟机优化。

### ABI 仿真

```sh
options 	COMPAT_FREEBSD32
```

启用 FreeBSD / i386 二进制文件的 32-bit 运行时支持。

```sh
options 	COMPAT_AOUT
```

启用 （32-bit） a.out 二进制文件支持。


### ZFS

>**注意**
>
>这取决于 crypto、cryptodev 和 ZSTDIO。

```sh
options 	ZFS
```

### VM

```sh
options 	NKPT=31
```

用于早期引导的初始内核页表页数量。这个数量应包含足够的页，以映射内核以及加载器随内核加载的任何模块或其他数据。每个页表页映射 2 MB。

```sh
options 	KSTACK_PAGES=5
```

KSTACK_PAGES 是为每个线程的内核栈分配的内存页数量。


```sh
options 	PV_STATS
```

启用 PV entry 分配器的详细记账功能。

### 内核清理器（sanitizers）

```sh
#options	COVERAGE	# 通用内核覆盖率。KCOV 会依赖此选项
#options	KCOV			# 内核覆盖率清理器
#options	KUBSAN		# 内核未定义行为清理器 ①
#options	KCSAN			# 内核并发清理器
#options	KASAN			# 内核地址清理器
#options	KCSAN			# 内核并发清理器
#options	KMSAN			# 内核内存清理器
```

- ① 警告：KUBSAN 可能会导致内核过大，以至于 loader 无法加载。

## i386 和 amd64 共用的机器相关内核选项

原文 [freebsd-src/main/sys/x86/conf/NOTES](https://github.com/freebsd/freebsd-src/blob/main/sys/x86/conf/NOTES)，版本 [NOTES: Add iwm and iwx](https://github.com/freebsd/freebsd-src/commit/b1039bbe185bbadea24207b600f4bea065a2dbee)。

>**技巧**
>
>可直接剪切/粘贴内核和 hints 条目到内核配置文件中。


### DTrace

```sh
#options 	KDTRACE_HOOKS
```

启用内核 DTrace hooks，DTrace 模块依赖此选项。

```sh
#device		dtrace
```

DTrace 核心。

>**注意**
>
>这将会把 CDDL 许可下的组件（DTrace）引入内核。


```sh
#device		dtrace_profile
#device		dtrace_sdt
#device		dtrace_fbt
#device		dtrace_systrace
#device		dtrace_prototype
#device		dtnfscl
#device		dtmalloc
```

各种 DTrace 模块。

```sh
#device		dtraceall
```

可选项，加载以上所有 DTrace 模块。


### SMP

```sh
options 	IPI_PREEMPTION
```

可选项。

>**注意**
>
>`IPI_PREEMPTION` 指示内核在需要时抢占其他 CPU 上运行的线程。该功能依赖 `PREEMPTION`。

```sh
options 	COUNT_XINVLTLB_HITS	# TLB 事件计数器
options 	COUNT_IPIS		# 每 CPU IPI 中断计数器
```

调试选项。


### 兼容性


```sh
options 	COMPAT_43
```

实现与 4.3BSD、FreeBSD 1.x 及 2.x 的 a.out 二进制文件兼容的系统调用。ELF 二进制文件或更新的 a.out 二进制文件无需此功能。

### 网络支持

```sh
options 	DEVICE_POLLING
```

`DEVICE_POLLING` 为网络设备驱动程序添加了中断与轮询混合处理支持，该功能在应对过载的健壮性、系统响应性以及在内核网络处理与其他活动之间实现精确的 CPU 时间调度方面具有显著优势。其缺点在于响应时间可能适度增加（最多可达 1/HZ 秒）。

强烈建议在使用 DEVICE_POLLING 时将 HZ 设置为 1000 或 2000 以获得更平滑的运行表现。此外，您可以在运行时通过 ifconfig(8) 工具启用/禁用轮询功能，并通过 sysctl 变量 `kern.polling.user_frac`（默认值 50，范围 0 到 100）调整保留给用户空间的 CPU 时间比例。需要注意的是，在本文撰写时，并非所有设备驱动程序都支持此工作模式。更多详细信息请参阅 polling(4)。

```sh
options 	BPF_JITTER
```

`BPF_JITTER` 为 BPF 添加了即时编译器支持。


### 时钟

```sh
device		nvram		# 通过 /dev/nvram 访问 rtc cmos
```

提供对时钟芯片内存的读写访问。


### 其他杂项设备与选项

```sh
device		speaker	
envvar		hint.speaker.0.at="isa"
envvar		hint.speaker.0.port="0x61"
```

通过扬声器播放 IBM BASIC 风格的提示音。

#### 硬件总线配置

```sh
options 	IOMMU			
```

启用 IOMMU。

```sh
device		isa
```

启用 ISA 总线。

```sh
options 	AUTO_EOI_1
#options 	AUTO_EOI_2

options 	MAXMEM=(128*1024)
#options 	BROKEN_KEYBOARD_RESET
```

ISA 总线选项。

`AUTO_EOI_1` 为主 8259A 中断控制器启用“自动 EOI”功能。每次中断可节省约 0.7-1.25 微秒。此选项会破坏部分便携式设备的挂起/恢复功能。

`AUTO_EOI_2` 为从 8259A 中断控制器启用“自动 EOI”功能。每次中断可节省约 0.7-1.25 微秒。文档记载自动 EOI 在原始 i8259A 芯片的从控制器上无效，但部分克隆芯片和集成版本可正常使用。

`MAXMEM` 用于指定机器内存容量。若未指定该参数，FreeBSD 将首先从 CMOS RAM 读取内存容量，此时初始内存将被限制在 64MB 或 16MB（具体取决于 BIOS）。若 BIOS 报告 64MB，系统将通过内存探测尝试检测实际安装的内存容量。若探测失败且内存大于 64MB，则必须使用 `MAXMEM` 参数。容量值以千字节为单位，例如 128MB 内存需设置为 131072（128 * 1024）。

`BROKEN_KEYBOARD_RESET` 可禁用通过键盘控制器执行 CPU 复位重启的功能。此选项适用于键盘控制器存在故障的系统。

```sh
device		agp
```

AGP GART 支持。


```sh
options 	AGP_DEBUG
```

AGP 调试。

#### ACPI

```sh
device		acpi
options 	ACPI_DEBUG
```

ACPI 支持（基于英特尔 ACPI 组件架构参考实现）

`ACPI_DEBUG` 可通过内核环境变量 `debug.acpi.level` 与 `debug.acpi.layer` 来设置英特尔 ACPICA 代码的初始调试级别（注意：此功能需在英特尔代码编译时启用选项 `USE_DEBUGGER`）


```sh
device		acpi_wmi
```

ACPI WMI 映射驱动程序


```sh
device		acpi_asus
```

面向华硕的 ACPI 扩展功能（LCD 背光/亮度、视频输出等）

```sh
device		acpi_fujitsu
```

面向富士通的 ACPI 扩展功能（按键）

```sh
device		acpi_hp
```

面向惠普笔记本的 ACPI 扩展驱动

```sh
device		acpi_ibm
```

面向 IBM 笔记本（ThinkPad）的 ACPI 扩展驱动

```sh
device		acpi_panasonic
```

面向松下的 ACPI 扩展功能（LCD 背光/亮度、视频输出等）

```sh
device		acpi_sbl_wmi
```

ACPI SBL 固件更新

```sh
device		acpi_sony
```

面向索尼的 ACPI 扩展功能（LCD 亮度调节）

```sh
device		acpi_toshiba
```

面向东芝的 ACPI 扩展功能（LCD 背光/亮度、视频输出等）

```sh
device		acpi_video
```

ACPI 视频扩展功能（LCD 背光/亮度、视频输出等）

```sh
device		acpi_dock
```

ACPI 扩展坞支持

```sh
device		aibs
```

ACPI ASOC ATK0110 华硕 AI Booster（电压、温度与风扇传感器）

#### 硬件设备配置

##### 可选设备

```sh
device		sc
envvar		hint.sc.0.at="isa"
options 	MAXCONS=16		# 虚拟控制台数量
options 	SC_ALT_MOUSE_IMAGE	# 文本模式下的简化鼠标光标
options 	SC_DFLT_FONT		# 编译内置字体
makeoptions	SC_DFLT_FONT=cp850
options 	SC_DFLT_TERM=\"sc\"	# 默认的终端模拟器
options 	SC_DISABLE_KDBKEY	# 禁用 `debug' 调试键
options 	SC_DISABLE_REBOOT	# 禁用重启快捷键
options 	SC_HISTORY_SIZE=200	# 历史缓冲区行数
options 	SC_MOUSE_CHAR=0x3	# 文本模式鼠标光标字符代码
options 	SC_PIXEL_MODE		# 添加对光栅文本模式的支持
```

syscons 控制台驱动程序（兼容 SCO 彩色控制台）。

```sh
options 	SC_NORM_ATTR=(FG_GREEN|BG_BLACK)
options 	SC_NORM_REV_ATTR=(FG_YELLOW|BG_GREEN)
options 	SC_KERNEL_CONS_ATTR=(FG_RED|BG_BLACK)
options 	SC_KERNEL_CONS_ATTRS=\"\x0c\x0d\x0e\x0f\x02\x09\x0a\x0b\"
options 	SC_KERNEL_CONS_REV_ATTR=(FG_BLACK|BG_RED)
```

以上选项可用于调整 syscons 的默认颜色配置。

sc 的 `flags` 参数：

- `0x80` 将显卡设置为 VESA 800x600 点阵 16 色模式
- `0x100` 若未检测到键盘设备则进行周期性探测

```sh
options 	SC_CUT_SPACES2TABS	# 将前导空格转换为制表符
options 	SC_CUT_SEPCHARS=\"x09\"	# 单词分隔符字符集（默认为单个空格 - "x20"）
```

以上选项可用于修改剪切粘贴功能的默认行为。

```sh
options 	SC_TWOBUTTON_MOUSE
```

若使用双键鼠标，可添加以上选项来启用鼠标右键粘贴文本的功能。

```sh
options 	SC_NO_CUTPASTE
options 	SC_NO_FONT_LOADING
options 	SC_NO_HISTORY
options 	SC_NO_MODE_CHANGE
options 	SC_NO_SYSMOUSE
options 	SC_NO_SUSPEND_VTYSWITCH
#!options 	SC_NO_TERM_DUMB
#!options 	SC_NO_TERM_SC
#!options 	SC_NO_TERM_SCTEKEN
```

可选择性禁用 syscons 中的功能模块。

```sh
device		splash
```

启动画面与屏幕保护程序。


```sh
device		blank_saver
device		daemon_saver
device		dragon_saver
device		fade_saver
device		fire_saver
device		green_saver
device		logo_saver
device		rain_saver
device		snake_saver
device		star_saver
device		warp_saver
```

多种屏幕保护程序。

```sh
options 	VESA
```

VGA VESA 显示模式。

```sh
options 	VESA_DEBUG
```

启用针对 VESA 支持的额外调试检查与输出。

```sh
device		dpms		
```

通过 VESA BIOS 实现 DPMS（VESA 显示电源管理信号）挂起与恢复功能。

```sh
options 	X86BIOS
```

x86 实模式 BIOS 模拟器（atkbdc/dpms/vesa 功能依赖于此）。


```sh
device		psm
envvar		hint.psm.0.at="atkbdc"
envvar		hint.psm.0.irq="12"
```

PS/2 鼠标。


```sh
options 	PSM_HOOKRESUME		
```

psm 选项。

在系统恢复事件时重置设备（对部分笔记本电脑特别有用）。


```sh
device		atkbdc
envvar		hint.atkbdc.0.at="isa"
envvar		hint.atkbdc.0.port="0x060"
```

键盘控制器：该组件负责控制键盘与 PS/2 鼠标。

```sh
device		atkbd
envvar		hint.atkbd.0.at="atkbdc"
envvar		hint.atkbd.0.irq="1"
```

AT 键盘。


```sh
options 	ATKBD_DFLT_KEYMAP	# 指定内置键盘布局
makeoptions	ATKBD_DFLT_KEYMAP=fr.dvorak
```

atkbd 驱动选项。

atkbd 的 flags 参数：

- `0x01` 强制检测键盘（默认始终假设存在键盘）
- `0x02` 禁止重置键盘（适用于部分新型 ThinkPad）
- `0x03` 强制检测且避免重置（可能有助于特定扩展坞兼容性）
- `0x04` 启用旧式（XT）键盘支持（适用于旧款 ThinkPad）

```sh
device		vga
envvar		hint.vga.0.at="isa"
```

VGA 适配器显卡驱动程序

```sh
options 	VGA_ALT_SEQACCESS
```

vga 驱动选项：若鼠标指针显示异常或字体加载不正确，可尝试以上选项（可能在某些系统上引发屏幕闪烁）。

.

```sh
#options 	VGA_NO_FONT_LOADING	# 不保存/不加载字体
#options 	VGA_NO_MODE_CHANGE	# 不更改显示模式
```

若需节省内存空间，可通过以上选项禁用部分 vga 驱动程序功能。

```sh
options 	VGA_SLOW_IOACCESS	# 
```

对 TS 与 GDC 寄存器执行字节宽度 I/O 操作。较旧的显卡可能需要此选项以确保正常运行。

```sh
options 	VGA_WIDTH90
```

支持 90 列模式。以上选项可能不适用于 LCD 显示屏。

```sh
options 	VGA_DEBUG
```

调试器。

```sh
device		vt_vga		# VGA
device		vt_vbefb	# VBE framebuffer
```

vt(4) 驱动。

```sh
device		s3pci
```

基于 VESA 的 S3 VESA 1.2 显卡线性帧缓冲驱动程序


#### RAID 适配器

```sh
device		arcmsr		# Areca SATA II RAID
```

Areca 11xx 与 12xx 系列 SATA II RAID 控制器（需启用 CAM 子系统）。


```sh
device		aac
device		aacp	# SCSI 直通接口（可选功能，需启用 CAM 子系统）
```

Adaptec FSA RAID 控制器系列，包含戴尔集成控制器、戴尔 PERC 2/QC 及惠普 NetRAID-4M。

```sh
# Highpoint RocketRAID 27xx
device		hpt27xx

# Highpoint RocketRAID 182x
device		hptmv

# Highpoint DC7280 和 R750
device		hptnr

# Highpoint RocketRAID.  支持 RR172x, RR222x, RR2240, RR232x, RR2340, RR2210, RR174x, RR2522, RR231x, RR230x
device		hptrr

# Highpoint RocketRaid 3xxx 系列 SATA RAID
device		hptiop
```

Highpoint 相关设备。

```sh
device		ips
```

IBM (now Adaptec) ServeRAID 控制器


```sh
device		isci
options 	ISCI_LOGGING	# 在 isci HAL 中启用调试功能
```

英特尔 C600（Patsburg）集成 SAS 控制器

```sh
device		vmd
```

英特尔卷管理设备 (VMD) 支持。

```sh
device		pmspcv
```

PMC-Sierra SAS/SATA 控制器。

#### 软盘

```sh
device		fdc
envvar		hint.fdc.0.at="isa"
envvar		hint.fdc.0.port="0x3F0"
envvar		hint.fdc.0.irq="6"
envvar		hint.fdc.0.drq="2"
```

标准软盘控制器与软盘磁带驱动器，支持 Y-E DATA 外置 FDD（PC 卡）。

```sh
options 	FDC_DEBUG
```

FDC_DEBUG 可启用软盘调试功能。由于调试输出量极大，需通过 DDB 设置 fd_debug 变量方可激活。

```sh
#hint.fdc.0.flags="1"
```

若您使用 Insight 的软盘磁带设备，请激活此配置项。由于仅配置软盘的用户进行设备探测存在风险，此功能已通过标志位进行隔离保护。

```sh
envvar		hint.fd.0.at="fdc0"
envvar		hint.fd.0.drive="0"
envvar		hint.fd.1.at="fdc0"
envvar		hint.fd.1.drive="1"
```

指定软盘设备

#### CPU 频率控制

```sh
device		cpufreq
```

cpufreq(4) 驱动程序提供了对非 ACPI CPU 频率控制的支持。

#### 网卡

```sh
device		bxe		# 博通 NetXtreme II BCM5771X/BCM578XX 10GbE 以太网卡
device		gve		# 谷歌虚拟网卡 (gVNIC)
device		igc		# Intel I225 2.5G Ethernet
device		ipw		# Intel 2100 无线网卡（Intel PRO/Wireless 2100 IEEE 802.11 适配器），依赖 ipw 固件
device		iwi		# Intel 2200BG/2225BG/2915ABG 无线网卡（Intel PRO/Wireless 2200BG/2225BG/2915ABG IEEE 802.11 适配器），依赖 iwi 固件
device		iwm		# Intel IEEE 802.11ac 无线网卡（Intel Wireless WiFi Link 1000/105/135/2000/4965/5000/6000/6050 abgn 802.11 网络适配器），依赖 iwm 固件
device		iwn		# Intel 4965/1000/5000/6000 无线网卡
device		iwx		# Intel IEEE 802.11ax 无线网卡
device  	mthca		# Mellanox HCA InfiniBand
device  	mlx4		# InfiniBand 与以太网共用的代码模块
device  	mlx4ib		# Mellanox ConnectX HCA InfiniBand
device  	mlx4en		# Mellanox ConnectX HCA Ethernet
device		nfe		# 英伟达 nForce MCP 板载以太网（以 BSD 开源）
device		vmx		# VMware VMXNET3 以太网（以 BSD 开源）
device		wpi		# Intel 3945ABG 无线网卡（Intel 3945ABG 无线局域网控制器），依赖 wpi 固件
```

#### IEEE 802.11 适配器固件


```sh
device		iwifw
device		iwibssfw
device		iwiibssfw
device		iwimonitorfw
device		ipwfw
device		ipwbssfw
device		ipwibssfw
device		ipwmonitorfw
device		iwnfw
device		iwn1000fw
device		iwn105fw
device		iwn135fw
device		iwn2000fw
device		iwn2030fw
device		iwn4965fw
device		iwn5000fw
device		iwn5150fw
device		iwn6000fw
device		iwn6000g2afw
device		iwn6000g2bfw
device		iwn6050fw
device		wpifw
```

Intel PRO/Wireless 2100 固件：

- ipwfw - 支持 BSS/IBSS/监听模式的全功能固件
- ipwbssfw - 仅支持 BSS 模式固件
- ipwibssfw - 仅支持 IBSS 模式固件
- ipwmonitorfw - 仅支持监听模式固件

Intel PRO/Wireless 2200BG/2225BG/2915ABG 固件：

- iwifw - 支持 BSS/IBSS/监听模式的全功能固件
- iwibssfw - 仅支持 BSS 模式固件
- iwiibssfw - 仅支持 IBSS 模式固件
- iwimonitorfw - 仅支持监听模式固件

Intel Wireless WiFi Link 4965/1000/5000/6000 系列固件：

- iwnfw - 支持所有该系列设备的单一模块
- iwn1000fw - 仅适用于 1000 的特定模块
- iwn105fw - 仅适用于 105 的特定模块
- iwn135fw - 仅适用于 135 的特定模块
- iwn2000fw - 仅适用于 2000 的特定模块
- iwn2030fw - 仅适用于 2030 的特定模块
- iwn4965fw - 仅适用于 4965 的特定模块
- iwn5000fw - 仅适用于 5000 的特定模块
- iwn5150fw - 仅适用于 5150 的特定模块
- iwn6000fw - 仅适用于 6000 的特定模块
- iwn6000g2afw - 仅适用于 6000g2a 的特定模块
- iwn6000g2bfw - 仅适用于 6000g2b 的特定模块
- iwn6050fw - 仅适用于 6050 的特定模块

其他：

- wpifw - Intel 3945ABG 无线局域网控制器固件


#### 非透明桥 (NTB) 驱动程序

```sh
device		if_ntb		# 虚拟 NTB 网卡
device		ntb_transport	# NTB 数据包传输驱动程序
device		ntb		# NTB 硬件接口
device		ntb_hw_amd	# AMD NTB 硬件驱动
device		ntb_hw_intel	# Intel NTB 硬件驱动
device		ntb_hw_plx	# PLX NTB 硬件驱动
```

#### 其他硬件


```sh
device		ipmi    # 智能平台管理接口
device		pbio    # 并行（8255 PPI）基本 I/O（模式 0）端口（例如 Advantech PCL-724）
envvar		hint.pbio.0.at="isa"
envvar		hint.pbio.0.port="0x360"
device		smbios  # DMI/SMBIOS 入口点（需启用 EFIRT 选项）
device		vpd # 重要产品数据内核接口
device		asmc    # 苹果系统管理控制器
device		tpm # 可信平台模块
device		rdrand_rng	# 英特尔 Bull Mountain 随机数生成器
device		aesni		# AES-NI OpenCrypto 模块
device		ossl		# OpenSSL OpenCrypto 模块
```

Specialix SI/XIO 驱动程序注意事项：

- 主机卡采用内存映射（非 I/O 映射）
- Rev 1 主机卡使用 64K 内存块，对齐边界为 32K
- Rev 2 主机卡使用 32K 内存块，对齐边界为 32K
- 该系列卡支持使用 IRQ 11、12 或 15

```sh
device		kvm_clock	# KVM 半虚拟化时钟驱动程序
```

Linux KVM 半虚拟化支持。


```sh
device 		hyperv		# Hyper-V 驱动
device		hvhid		# Hyper-V HID 驱动

微软 Hyper-V 增强支持

```sh
device		pvscsi		# 半虚拟化 SCSI 驱动程序
device		vmci		# 虚拟机通信接口（VMCI）
device		vmware_guestrpc	# GuestRPC 接口
```

VMware 虚拟机监控程序支持。

```sh
device backlight
```

笔记本电脑专用选项。背光亮度调节。

```sh
device		imcsmb
```

系统管理总线（SMB）。

支持的 SMBus 接口：

- imcsmb：集成内存控制器 (iMC) SMBus 控制器。
- 支持平台：Sandy Bridge-至强、Ivy Bridge-至强、Haswell-至强、Broadwell-至强处理器

```sh
device		iichid		# HID-over-I²C 支持
options 	IICHID_DEBUG	# 启用 HID-over-I²C 调试信息
options 	IICHID_SAMPLING	# 针对缺失 GPIO 中断支持的变通方案
```

HID-over-I²C 支持。

```sh
device		amdsmn
```

AMD 系统管理网络（AMD System Management Network, SMN）

```sh
device		ichwd   # 英特尔 ICH 看门狗定时器
device		amdsbwd # AMD SB7xx 看门狗定时器
device		viawd   # VIA 南桥看门狗定时器
device		wbwd    # Winbond 看门狗定时器
device		itwd    # ITE Super I/O 看门狗定时器
```

硬件看门狗定时器。

```sh
device		coretemp
device		amdtemp
```

温度传感器：

- `coretemp`：英特尔酷睿及更新架构处理器晶圆的内置传感器
- `amdtemp`：AMD K8/K10/K11 系列处理器晶圆的内置传感器

```sh
device		cpuctl
```

CPU 控制伪设备。提供了对 MSR（模型特定寄存器）、CPUID 信息及微代码更新功能的访问。


```sh
device		superio
```

SuperIO 驱动。

```sh
options 	KBDIO_DEBUG=2
options 	KBD_MAXRETRY=4
options 	KBD_MAXWAIT=6
options 	KBD_RESETDELAY=201

options 	PSM_DEBUG=1

options 	TIMER_FREQ=((14318182+6)/12)

options 	VM_KMEM_SIZE
options 	VM_KMEM_SIZE_MAX
options 	VM_KMEM_SIZE_SCALE
```

许多用于代码检查的未公开选项。

>**注意**
>
>对此类选项进行的文档编写并不被视为不当行为。


## 机器无关的内核选项

原文：[freebsd-src/main/sys/conf/NOTES](https://github.com/freebsd/freebsd-src/blob/main/sys/conf/NOTES)，版本 [random: allow disabling of entropy harvesting from keyboard & mice](https://github.com/freebsd/freebsd-src/commit/d6f10a5d013fdcc92847644ffbaf65cbf491bb39)。


>**技巧**
>
>可直接剪切/粘贴下面的条目到内核配置文件中。
>
>
>>以 `device`、`options`、`machine`、`ident`、`maxusers`、`makeoptions`、`hints` 等开头的行放入要运行 [config(8)](https://man.freebsd.org/cgi/man.cgi?config(8)) 的内核配置中。
>>
>>以 `envvar hint.` 开头的行应放入你的 hints 文件中。参见 `/boot/device.hints`，[config(8)](https://man.freebsd.org/cgi/man.cgi?config(8)) 中的 `hints` 指令。
>>
>>如果你想进行内核测试构建，请使用 `make LINT` 创建旧式 LINT 文件。
>>
>>此文件是机器无关的内核配置说明。机器相关的说明，请参见 `/sys/架构/conf/NOTES`。

>**技巧**
>
>NOTES 约定和风格指南：
>
>大段注释应以仅包含注释字符的一行开始和结束。
>
>描述特定对象时，如果存在块注释，应先写块注释。接下来按顺序写 device、options 和 hints 条目。所有 device 和 option 行都必须有注释，且注释不能只是重复 device 或 option 名称。如可能，仅在同一行使用简明注释。设备和子系统的详细说明应放在 man 页中。
>
>options 与选项名之间用一个空格加一个制表符分隔。device 与设备名之间用两个空格加一个制表符分隔。option 或 device 后的注释应在注释字符后加一个空格。要注释掉禁用代码的负选项（因此不应在 LINT 构建中启用），在 `options` 前加 `#!`。

```sh
ident		LINT
```

这是内核的“标识”。通常应与内核的名称相同。

```sh
maxusers	10
```

参数 `maxusers` 可通过 `subr_param.c` 中定义的公式控制多个内部系统表的静态大小。

省略此参数或将其设置为 `0`，系统将根据物理内存自动调整大小。

```sh
#hints		"LINT.hints"		# 查找设备的默认位置
```

静态编译设备连接，而不是使用 `/boot/device.hints`。

```sh
#env		"LINT.env"
```

使用以上方法将值编译进内核，以便内核可以通过 `getenv()`（或者用户空间的 `kenv(1)`）访问。文件格式为 `variable=value`，详见 [kenv(1)](https://man.freebsd.org/kenv(1))。

```sh
makeoptions	CONF_CFLAGS=-fno-builtin  # ①② 不允许使用 memcmp 等函数
#makeoptions	DEBUG=-g		# ③ 为内核构建包含 gdb(1) 调试符号的版本
#makeoptions	KERNEL=foo		# ④ 构建内核 "foo" 并安装到 "/foo"
#makeoptions	MODULES_OVERRIDE="ext2fs sound/sound sound/driver/maestro3" # ⑤ 只构建 ext2fs 模块以及我需要的声音系统部分。
makeoptions	DESTDIR=/tmp # 将目标安装目录临时设置为 /tmp
```

- ①：`makeoptions` 参数可将变量传递给构建区域生成的 Makefile。

- ②：`CONF_CFLAGS` 提供了一些额外的编译器标志，这些标志会在大多数其他标志之后添加到 `${CFLAGS}` 中。在这里，我们使用它来禁止使用非最优的 gcc 内建函数（例如 `memcmp`）。

- ③：`DEBUG` 是个特殊标志。

下面的做法等同于执行 `config -g KERNELNAME`，会生成 `kernel.debug`，该内核带有调试信息 `-g`，同时还会生成一个普通的 `kernel`。使用 `make install.debug` 可以安装调试内核，但通常没有必要，因为调试符号不会被内核加载，在内核中也没有用处。

- ④：重命名 `KERNEL`，以便于让你更改内核的默认名称。

- ⑤：`MODULES_OVERRIDE` 可以用来限制构建的模块列表，仅编译指定的模块。

```sh
options 	MAXDSIZ=(1024UL*1024*1024)
options 	MAXSSIZ=(128UL*1024*1024)
options 	DFLDSIZ=(1024UL*1024*1024)
```

FreeBSD 进程在使用系统资源时会受到一定限制。更多细节，请参见 [getrlimit(2)](https://man.freebsd.org/getrlimit(2))。每个资源限制都有两个值：“软限制（soft limit）”和“硬限制（hard limit）”。

可以在系统正常运行时修改软限制，而硬限制只能在启动时设定。它们的默认值定义在 `sys/架构/include/vmparam.h` 中。有两种方式可以修改上述限制：

1. 在内核编译时设置值。下面的选项是一种将该限制提高到 1GB 的方法。通过修改相关参数，还可以进一步提高这些值。
2. 在 `/boot/loader.conf` 中设置可调节参数：`kern.maxswzone`、`kern.maxbcache`、`kern.maxtsiz`、`kern.dfldsiz`、`kern.maxdsiz`、`kern.dflssiz`、`kern.maxssiz` 和 `kern.sgrowsiz`。

`/boot/loader.conf` 中的设置会覆盖内核配置文件中的任何值。有关更多细节，请参见 `sys/kern/subr_param.c` 中的函数 `init_param1`。


```sh
options 	BLKDEV_IOSIZE=8192
```

`BLKDEV_IOSIZE` 可设置用户块设备 I/O 使用的默认块大小。

>**注意**
>
>当通过带有非零分区块大小的标签指定块设备时，该值会被标签覆盖。默认值为 `PAGE_SIZE`。

```sh
options 	DFLTPHYS=(64*1024) # DFLTPHYS 表示原始（raw）I/O 块设备访问的安全大小，默认值 64K
options 	MAXPHYS=(128*1024) # MAXPHYS 表示原始（raw）I/O 块设备访问的最大大小，默认值 128K
```

对于已知可靠的设备，读写操作会被分割成 MAXPHYS 大小的块；对于其他设备，则使用 DFLTPHYS 大小的块。某些应用在使用较大原始 I/O 访问块时性能更好。

>**注意**
>
>某些虚拟内存（VM）参数是从这些值推导出来的，将它们设置得过大可能会导致内核无法启动。

```sh
options 	INCLUDE_CONFIG_FILE     # 将此文件内置进内核
```

你可将此配置文件实际存储到内核二进制文件中。详见 config(8)。


```sh
options 	BOOTVERBOSE=1
options 	BOOTHOWTO=RB_MULTIPLE
```

各种启动参数的编译时默认值


```sh
options 	BOOT_TAG=\"\"
```

dmesg 启动标签的编译时默认值

默认启动标签；可以使用 loader 可调参数 `kern.boot_tag` 来覆盖。当前启动的标签也通过 sysctl `kern.boot_tag` 暴露。


```sh
options 	BOOT_TAG_SZ=32
```

内核静态缓冲区应容纳的最大启动标签大小。BOOT_TAG 及其相关可调参数的最大尺寸。


```sh
options 	GEOM_CACHE		# 磁盘缓存
options 	GEOM_CONCAT		# 磁盘串联
options 	GEOM_ELI		# 磁盘加密
options 	GEOM_GATE		# 用户态服务
options 	GEOM_JOURNAL		# 日志功能
options 	GEOM_LABEL		# 提供者标签化
options 	GEOM_LINUX_LVM		# Linux LVM2 卷
options 	GEOM_MAP		# 基于映射的分区
options 	GEOM_MIRROR		# 磁盘镜像
options 	GEOM_MULTIPATH		# 磁盘多路径
options 	GEOM_NOP		# 测试类
options 	GEOM_PART_APM		# Apple 分区
options 	GEOM_PART_BSD		# BSD 磁盘标签
options 	GEOM_PART_BSD64		# BSD 磁盘标签 64
options 	GEOM_PART_EBR		# 扩展启动记录
options 	GEOM_PART_GPT		# GPT 分区
options 	GEOM_PART_LDM		# 逻辑磁盘管理器
options 	GEOM_PART_MBR		# MBR 分区
options 	GEOM_RAID		# 软件 RAID 功能
options 	GEOM_RAID3		# RAID3 功能
options 	GEOM_SHSEC		# 共享密钥
options 	GEOM_STRIPE		# 磁盘条带化
options 	GEOM_UZIP		# 只读压缩磁盘
options 	GEOM_VIRSTOR		# 虚拟存储
options 	GEOM_ZERO		# 性能测试辅助工具
```

GEOM 相关。


```sh
options 	ROOTDEVNAME=\"ufs:da0s2e\"
```

可以在编译时指定根设备和文件系统类型；如果引导程序无法正确识别根设备，此处提供了备用方案；或在启动内核时指定 `RB_DFLTROOT` 标志（`-r`）时来覆盖选项。

### 调度器

```sh
options 	SCHED_4BSD # 历史悠久、久经考验的 BSD 调度器
options 	SCHED_STATS # 统计信息
#options 	SCHED_ULE # 默认的 ULE 调度器
```

`SCHED_4BSD` 和 `SCHED_ULE` 必选其一。这些选项用于选择要编译进内核的调度器。

说明：

- `SCHED_4BSD` 使用全局运行队列且没有 CPU 亲和性，这在 SMP 系统中表现不佳。但它具有非常好的交互性和优先级选择能力。
- `SCHED_ULE` 在许多 SMP 机器上的工作负载下，相比 4BSD 提供了显著的性能优势。它支持 CPU 亲和性、每 CPU 的运行队列和调度器锁。它还对交互性有更强的支持，即使在单处理器机器上也能提供更好的响应能力。
- `SCHED_STATS` 会在 sysctl `kern.sched.stats` 下保存一些统计信息，有助于调试调度决策。

### SMP


```sh
options 	SMP			# Symmetric MultiProcessor Kernel，SMP，对称多处理器
```

SMP 可构建对称多处理器内核。必须指定。

```sh
options 	EARLY_AP_STARTUP
```

`EARLY_AP_STARTUP` 可在内核启动过程中更早地释放应用处理器（在设备探测之前），而不是在启动尽头。这个选项是从晚期到早期 AP 启动过渡期间的临时选项。

```sh
options 	MAXCPU=32
```

`MAXCPU` 定义了系统中能启动的最大 CPU 数量。每种架构通常已经有默认值。

```sh
options 	NUMA
```

NUMA 可启用内核各子系统中对非一致性内存访问（Non-Uniform Memory Access）策略的支持。

```sh
options 	MAXMEMDOM=2
```

`MAXMEMDOM` 定义了系统中可启动的最大内存域数量。每种架构通常已有默认值。


```sh
options 	NO_ADAPTIVE_MUTEXES
```

`ADAPTIVE_MUTEXES` 可改变阻塞互斥锁的行为：如果当前持有互斥锁的线程在另一 CPU 上执行，则互斥锁会自旋。此行为默认启用，该选项可用于禁用上述行为。

```sh
options 	NO_ADAPTIVE_RWLOCKS
```

`ADAPTIVE_RWLOCKS` 会改变读写锁的行为：如果当前持有读写锁的线程在另一 CPU 上执行，则锁会自旋。此行为默认启用，该选项可用于禁用上述行为。


```sh
options 	NO_ADAPTIVE_SX
```

`ADAPTIVE_SX` 可改变 sx 锁的行为：如果当前持有 sx 锁的线程在另一 CPU 上执行，则锁会自旋。此行为默认启用，该选项可用于禁用上述行为。

```sh
options 	MUTEX_NOINLINE
```

`MUTEX_NOINLINE` 可强制互斥操作通过调用函数来执行每个操作，而不是对简单情况进行内联。可用于减小内核文本段的大小。

>**注意**
>
>这种行为已被选项 `INVARIANT_SUPPORT`、`INVARIANTS`、`KTR`、`LOCK_PROFILING` 和 `WITNESS` 隐式启用。

```sh
options 	RWLOCK_NOINLINE
```

`RWLOCK_NOINLINE` 可强制读写锁操作通过调用函数来执行每个操作，而不是对简单情况进行内联。可用于减小内核文本段的大小。

>**注意**
>
>这种行为已被选项 `INVARIANT_SUPPORT`、`INVARIANTS`、`KTR`、`LOCK_PROFILING` 和 `WITNESS` 隐式启用。

```sh
options 	SX_NOINLINE
```

`SX_NOINLINE` 可强制 sx 锁操作通过调用函数来执行每个操作，而不是对简单情况进行内联。这可以用于减小内核文本段的大小。

>**注意**
>
>这种行为已被选项 `INVARIANT_SUPPORT`、`INVARIANTS`、`KTR`、`LOCK_PROFILING` 和 `WITNESS` 隐式启用。

#### SMP 调试选项

```sh
options 	PREEMPTION
options 	FULL_PREEMPTION
options 	WITNESS
options 	WITNESS_KDB
options 	WITNESS_SKIPSPIN
```

- `CALLOUT_PROFILING`：启用对 [callout(9)](https://man.freebsd.org/callout(9)) 后端使用的 callwheel 数据结构的基础分析。
- `PREEMPTION`：允许内核中的线程被优先级更高的[中断]线程抢占。提高交互性，使中断线程能更快运行，而不是等待。
- `FULL_PREEMPTION`：指示内核抢占非实时内核线程。主要用于在开发阶段暴露竞态条件和其他 bug。启用会降低性能并增加内核 panic 频率。依赖 `PREEMPTION` 选项，不建议开启。
- `SLEEPQUEUE_PROFILING`：对保存活动睡眠队列的哈希表及睡眠等待消息频率进行基础分析。
- `TURNSTILE_PROFILING`：对保存活动锁队列的哈希表进行基础分析。
- `UMTX_PROFILING`：对保存活动锁队列的哈希表进行基础分析。
- `WITNESS`：启用 witness 代码，用于检测锁操作期间的死锁和循环。
- WITNESS_KDB：当发生锁层次违规或线程在休眠前持锁时，进入内核调试器。
- WITNESS_SKIPSPIN：禁用对自旋互斥锁的 witness 检查。

```sh
options 	LOCK_PROFILING
```

LOCK_PROFILING — 锁分析。详情见 [LOCK_PROFILING(9)](https://man.freebsd.org/cgi/man.cgi?LOCK_PROFILING)。

```sh
options 	MPROF_BUFFERS="1536" # 设置缓冲区数量
options 	MPROF_HASH_SIZE="1543"# 设置缓冲区哈希表大小
```

`MPROF_HASH_SIZE` 哈希表大小必须大于缓冲区数量 `MPROF_BUFFERS`，且应为素数。

```sh
options 	CALLOUT_PROFILING
```

为 [callout(9)](https://man.freebsd.org/callout(9)) 后端进行分析。

```sh
options 	SLEEPQUEUE_PROFILING
options 	TURNSTILE_PROFILING
options 	UMTX_PROFILING
```

对内部哈希表进行分析。

```sh
options 	EPOCH_TRACE
```

针对 [epoch(9)](https://man.freebsd.org/epoch(9)) 的误用进行调试跟踪。

### 兼容性

```sh
options 	COMPAT_43TTY
```

旧款 TTY 接口

```sh
options 	COMPAT_FREEBSD4
```

启用 FreeBSD4 兼容性系统调用。

>**注意**
>
>在通常情况下，`COMPAT_FREEBSD<n>` 依赖 `COMPAT_FREEBSD<n+1>`、`COMPAT_FREEBSD<n+2>` 等。

```sh
options 	COMPAT_FREEBSD5
```

启用 FreeBSD 5 兼容性系统调用。

```sh
options 	COMPAT_FREEBSD6
```

启用 FreeBSD 6 兼容性系统调用。

```sh
options 	COMPAT_FREEBSD7
```

启用 FreeBSD 7 兼容性系统调用。

```sh
options 	COMPAT_FREEBSD8
```

启用 FreeBSD 8 兼容性系统调用。


```sh
options 	COMPAT_FREEBSD9
```

启用 FreeBSD 9 兼容性系统调用。

```sh
options 	COMPAT_FREEBSD10
```

启用 FreeBSD 10 兼容性系统调用。

```sh
options 	COMPAT_FREEBSD11
```

启用 FreeBSD 11 兼容性系统调用。

```sh
options 	COMPAT_FREEBSD12
```

启用 FreeBSD 12 兼容性系统调用。

```sh
options 	COMPAT_FREEBSD13
```

启用 FreeBSD 13 兼容性系统调用。

```sh
options 	COMPAT_FREEBSD14
```

启用 FreeBSD 14 兼容性系统调用。

```sh
options 	COMPAT_LINUXKPI
```

启用 Linux 内核编程接口。


```sh
options 	SYSVSHM
options 	SYSVSEM
options 	SYSVMSG
```

- `SYSVSHM`：启用 System V 风格的共享内存支持。
- `SYSVSEM`：启用 System V 风格的信号量支持。
- `SYSVMSG`：启用 System V 风格的消息队列支持。


### 调试

```sh
options 	KDB
```

编译时包含内核调试器相关代码。

```sh
options 	KDB_TRACE
```

在系统发生 panic 时，在控制台打印当前线程的调用栈跟踪。

```sh
options 	KDB_UNATTENDED
```

在发生 panic 时不进入调试器。适用于无人值守的操作环境，你可能想通过控制台手动进入调试器，但仍希望系统能够在 panic 后自行恢复。


```sh
options 	DDB
```

启用 ddb 调试器后端。

```sh
options 	DDB_NUMSYM
```

除了符号表示外，还打印符号的数值。

```sh
options 	GDB
```

启用远程 gdb 调试器后端。

```sh
options 	QUEUE_MACRO_DEBUG_TRASH
```

在列表指针变为无效时（即元素从列表中移除）将其清空。启用成本相对较低。

```sh
#options 	QUEUE_MACRO_DEBUG_TRACE
```

在列表对象中存储最后一个修改列表对象的调用者的信息。需要额外的内存开销。

```sh
options 	SYSCTL_DEBUG
```

SYSCTL_DEBUG 启用将启用一 sysctl 调试树，可用于在控制台上转储已注册 sysctl 节点的内容。因为它会生成过于冗长的控制台输出，可能干扰串行控制台操作，所以默认情况下禁用。

```sh
options 	TEXTDUMP_PREFERRED
```

默认启用 textdump，将禁用内核核心转储。

```sh
options 	TEXTDUMP_VERBOSE
```

在执行 textdump 时启用额外的调试信息。

```sh
options 	NO_SYSCTL_DESCR
```

`NO_SYSCTL_DESCR` 会省略 sysctl 节点描述，以节省生成内核的空间。

```sh
options 	MALLOC_DEBUG_MAXZONES=8
```

`MALLOC_DEBUG_MAXZONES` 可为小于一页的 [malloc(9)](https://man.freebsd.org/malloc(9)) 分配启用多个 uma 区域。其目的是将不同的 malloc 类型隔离到哈希类别中，这样所有缓冲区溢出和释放后使用（UAF）问题通常只会影响该哈希类别中的 malloc 类型的内存。这纯粹是一款调试工具；通过改变哈希函数并追踪哪个哈希类别被破坏，每个实例的哈希类别交集将指向被滥用的单个 malloc 类型。此时可以使用检查或 [memguard(9)](https://man.freebsd.org/cgi/man.cgi?query=memguard&sektion=9&format=html) 来捕获问题代码。


```sh
options 	DEBUG_MEMGUARD
```

`DEBUG_MEMGUARD` 构建并启用 [memguard(9)](https://man.freebsd.org/cgi/man.cgi?query=memguard&sektion=9&format=html)，这是内核的替代分配器，用于检测释放后修改（modify-after-free）场景。有关使用的更多信息，请参见 [memguard(9)](https://man.freebsd.org/cgi/man.cgi?query=memguard&sektion=9&format=html) 手册页。

```sh
options 	DEBUG_REDZONE
```

`DEBUG_REDZONE` 为 [malloc(9)](https://man.freebsd.org/malloc(9)) 启用缓冲区下溢和缓冲区上溢的检测。

```sh
#options 	EARLY_PRINTF
```

`EARLY_PRINTF` 可在内核非常早期（在调用 `cn_init()` 之前）使用一种特殊的 `printf`（`eprintf`）。这通常仅用于启动早期调试。通常情况下，它未被定义。这里被注释掉是因为该功能通常不可用，而且所需的 `eputc()` 也未定义。

```sh
options 	KTRACE			# 内核跟踪
options 	KTRACE_REQUEST_POOL=101
```

`KTRACE` 启用系统调用跟踪功能 [ktrace(2)](https://man.freebsd.org/ktrace(2))。为了更好地支持 SMP，KTRACE 使用一个工作线程来异步处理大多数跟踪事件，而不是由生成事件的线程直接处理。这需要预先分配一个用于存储跟踪事件对象的池。选项`KTRACE_REQUEST_POOL` 指定该池的初始大小。可以在启动时/运行时通过可调参数和 sysctl `kern.ktrace_request_pool`  调整该池的大小。


```sh
options 	KTR
options 	KTR_BOOT_ENTRIES=1024
options 	KTR_ENTRIES=(128*1024)
options 	KTR_COMPILE=(KTR_ALL)
options 	KTR_MASK=KTR_INTR
options 	KTR_CPUMASK=0x3
options 	KTR_VERBOSE
```

KTR 是一款从 BSD/OS 引入的内核跟踪设施。通过选项 `KTR` 启用。

- `KTR_ENTRIES` 定义了循环跟踪缓冲区中的条目数量，可以是任意数字。
- `KTR_BOOT_ENTRIES` 定义了早期启动期间的条目数量，在 [malloc(9)](https://man.freebsd.org/malloc(9)) 可用之前使用。
- `KTR_COMPILE` 定义了要编译到内核中的事件掩码，由 `<sys/ktr.h>` 中的常量 `KTR_*` 定义。
- `KTR_MASK` 定义了变量 `ktr_mask` 的初始值，该变量在运行时决定要跟踪哪些事件。
- `KTR_CPUMASK` 决定哪些 CPU 记录事件，位 X 对应 CPU X。作为 KTR_CPUMASK 传入的字符串布局必须匹配一系列位掩码，每个掩码用 `,` 分隔（例如：`KTR_CPUMASK=0xAF,0xFFFFFFFFFFFFFFFF`）。
- `KTR_VERBOSE` 默认启用将 KTR 事件输出到控制台。此功能可以通过 sysctl `debug.ktr_verbose` 调整，如果未定义 `KTR_VERBOSE`，则默认关闭。

详情请参见 [ktr(4)](https://man.freebsd.org/cgi/man.cgi?query=ktr&sektion=4) 和 [ktrdump(8)](https://man.freebsd.org/cgi/man.cgi?query=ktrdump&sektion=8&format=html)。


```sh
options 	ALQ
options 	KTR_ALQ
```

- [ALQ(9)](https://man.freebsd.org/cgi/man.cgi?query=alq&sektion=9) 是一款用于将内核记录异步排队到 vnode 的机制。
- [ktr(4)](https://man.freebsd.org/cgi/man.cgi?query=ktr&sektion=4) 等服务使用它根据内核事件流生成跟踪文件。记录由工作线程异步写入。


```sh
options 	INVARIANTS
```

选项 `INVARIANTS` 在多个源文件中用于启用对内部结构的额外完整性检查。在默认情况下禁用，因为检查这些条件会额外消耗时间，而这些问题通常仅由编程错误引起。

```sh
options 	INVARIANT_SUPPORT
```

选项 `INVARIANT_SUPPORT` 能让我们在编译时加入对部分内部结构的验证支持。`INVARIANT_SUPPORT` 是启用 `INVARIANTS` 的前提，因为启用 `INVARIANTS` 会调用这些函数。其目的是，如果启用了 `INVARIANT_SUPPORT`，你可以为单个源文件设置 `INVARIANTS`（通过修改源文件或在命令行指定）。此外，如果你希望构建带有 `INVARIANTS` 的内核模块，将 `INVARIANT_SUPPORT` 添加到内核中可以提供所有必要的基础设施，且不会增加额外开销。


```sh
options 	KASSERT_PANIC_OPTIONAL
```

选项 `KASSERT_PANIC_OPTIONAL` 能在 kasserts 被触发时不一定引起 panic。panic 是默认行为，但运行时选项可以将其完全关闭，或者在设定限制下关闭。


```sh
options 	DIAGNOSTIC
```

选项 `DIAGNOSTIC` 用于启用额外的调试信息和完整性检查。由于这些额外检查对 `INVARIANTS` 内核来说开销过大或过于冗杂，因此默认情况下禁用。通常，配置了 `DIAGNOSTIC` 的内核也会启用 `INVARIANTS` 选项。

```sh
options 	REGRESSION
```

`REGRESSION` 将启用仅在回归测试中需要的可选内核接口。启用这些接口可能构成安全风险，因为它们允许进程轻松修改运行时环境的某些方面，会重现不太可能或异常（可能通常不可能出现）的场景。

```sh
options 	COMPILING_LINT
```

此选项能让某些在运行系统中无法共存的驱动程序共存。它用于能够一次性编译所有内核代码以进行质量保证（例如本文件，其名称即来源于该选项）。

```sh
options 	STACK
```

STACK 将启用 [stack(9)](https://man.freebsd.org/cgi/man.cgi?query=stack&sektion=9) 功能，可捕获内核栈。若内核编译中包含 [DDB(4)](https://man.freebsd.org/cgi/man.cgi?ddb(4))，[stack(9)](https://man.freebsd.org/cgi/man.cgi?query=stack&sektion=9) 也会被自动编译进内核。

```sh
options 	NUM_CORE_FILES=5
```

选项 `NUM_CORE_FILES` 指定了特定进程生成核心文件的数量上限，当核心文件格式说明符包含 `%I` 模式时。由于格式字符串中核心计数只有 `1` 个字符，可表示的范围为 0-9，因此该选项允许的最大值为 `10`。该核心文件数量限制可在运行时通过 sysctl `debug.ncores` 进行调整。

```sh
options 	TSLOG
options 	TSLOGSIZE=262144
```

`TSLOG` 选项可启用事件的时间戳记录，特别是函数的进/出，以便跟踪内核消耗的时间。尤其在早期启动过程中非常有用，因为此时还无法使用 DTrace 等更高级的工具。

- `TSLOGSIZE` 选项控制用于存储这些事件的（预分配、固定长度）缓冲区大小（默认：`262144` 条记录）。
- `TSLOG_PAGEZERO` 选项可启用对 `pmap_zero_page` 的 TSLOG；由于它通常会生成过多记录而不太实用，因此必须单独启用。

出于安全考虑，TSLOG 不应在用于生产的系统上启用。


### 性能监控

```sh
device		hwpmc			# 驱动程序（也可作为可加载模块）
options 	HWPMC_DEBUG
options 	HWPMC_HOOKS		# 其他必要的内核钩子
```

驱动程序 `hwpmc` 可使用 CPU 内置的性能监控计数器进行性能监控。基础内核需要通过 `options` 条目进行配置，可将 hwpmc 设备编译进内核或作为可加载内核模块来加载。

在特定架构上可能需要额外的配置选项，请参见 [hwpmc(4)](https://man.freebsd.org/hwpmc(4))。


### 网络接口

#### 协议栈

```
options 	INET			# 互联网通信协议（IPv4）
options 	INET6			# 互联网通信协议（IPv6）
```

```sh
options 	CC_CDG # CAIA Delay‑Gradient 算法
options 	CC_CHD # CAIA Hamilton‑Delay 算法
options 	CC_CUBIC # Cubic 算法
options 	CC_DCTCP # DCTCP 算法
options 	CC_HD # Hamilton Delay 算法
options 	CC_HTCP # H‑TCP 算法
options 	CC_NEWRENO # NewReno 算法
options 	CC_VEGAS # Vegas 算法
options 	CC_DEFAULT=\"cubic\" # 将 Cubic 指定为默认的拥塞控制算法
options 	RATELIMIT		# 传输速率限制支持

options 	ROUTETABLES=2		# 分配的 FIB 最多可达 65536。默认值为 1，但这不是个好主意，因为它们占用空间很大

options 	TCP_OFFLOAD		# TCP 卸载（offload）
options  	TCP_RFC7413		# TCP 快速打开（TCP Fast Open）

options  	TCPHPTS # 在启动时将 TCP 堆栈作为模块加载
#options 	TCP_HPTS_KTEST		# 为 HPTS 添加 KTEST 支持
```

>**注意**
>
>如果你使用了选项 `INET`、`INET6` 或同时指定了两者，**必须**至少指定一个拥塞控制选项，否则将编译失败。`GENERIC` 定义了 `CC_CUBIC`。如果编译了多款拥塞控制，你可能需要指定一个默认值。

`default` 中的字符串是 `cc` 模块的名称，在 sysctl 中用于设置默认值。代码将 `CUBIC` 定义为默认值，或者如果只编译了一个 `cc_module`，则使用该模块。

```sh
options 	IPSEC			# IPsec（需要设备加密支持）
```

IPsec（IP 安全）。要启用 `IPSEC`，**必须**在内核配置中同时指定设备加密支持。

```sh
options 	IPSEC_SUPPORT
#options 	IPSEC_DEBUG		# IPsec 调试
```

`IPSEC_SUPPORT` 选项并不会直接启用 IPsec，但它能将 IPsec 作为内核模块加载。你仍然 **必须** 在内核配置中添加设备加密支持。

```sh
options 	TCP_BBR # BBR（Bottleneck Bandwidth and Round-trip propagation time）
options 	TCP_RACK # RACK 栈，Recent ACKnowledgment
```

可选的 TCP 堆栈。


```sh
options 	KERN_TLS		# TLS 发送与接收卸载
```

TLS 用于通过 TCP 套接字对数据进行帧封装以及加/解密。

```sh
options 	NETLINK
```

Netlink 内核/用户 <-> 内核/用户 消息传递接口

```sh
options 	NETSMB			# SMB/CIFS 请求器（requester）
```

SMB/CIFS 请求器。NETSMB 启用了对 SMB 协议的支持，它需要选项 `LIBMCHAIN` 和 `LIBICONV`。

```sh
options 	LIBMCHAIN
```

mchain 库。它可以作为 KLD（可加载内核模块）加载，也可以编译进内核。

```sh
options 	LIBALIAS
```

libalias 库，用于执行 NAT（网络地址转换）。

```sh
options 	SCTP
options 	SCTP_SUPPORT
```

SCTP 是一种新型传输协议，由 RFC2960 定义，并由 RFC3309 和 RFC3758 更新，很快还会有新的基础 RFC 和更多扩展。本版本支持所有扩展，包括许多草案（大部分即将成为 RFC）。它是 SCTP 的参考实现，经过了充分测试。

>**注意**
>
>**必须同时定义 INET 和 INET6**。不必启用 IPv6，但 SCTP 是双栈协议，目前我们还没有拆分 IPv6 和 IPv4，因为一个关联（association）可以同时跨越 IPv6 和 IPv4 地址。

选项 `SCTP_SUPPORT` 并不会直接启用 SCTP，而是提供将 SCTP 作为可加载内核模块加载所需的支持。

```sh
options 	SCTP_DEBUG
```

有很多选项：

这个选项可开启各种详细打印功能。它由一个位掩码控制（可以通过 socket 选项和 sysctl 设置）。包含该选项本身不会立即产生日志，必须先设置相应的位。但打印信息可能非常冗长。因此，若未启用该选项，代码就不会进行位检测和打印，这样可以提高运行速度。如果你不是在调试，请不要使用。

```sh
options 	SCTP_LOCK_LOGGING
options 	SCTP_MBUF_LOGGING
options 	SCTP_MBCNT_LOGGING
options 	SCTP_PACKET_LOGGING
options 	SCTP_LTRACE_CHUNKS
options 	SCTP_LTRACE_ERRORS
```

上面的所有选项用于开启特定类型的日志记录。你可以监控拥塞窗口（CWND）增长、飞行数据量（flight size）以及各种其他指标。可以查看代码了解更多。我曾用这些日志生成过有趣的图表和曲线 :->

我还没有提交获取和打印日志的工具，但最终会完成。在那之前，如果你需要日志，可以发邮件给我 [rrs@freebsd.org](mailto:rrs@freebsd.org)。

基本上，你必须启用 [ktr(4)](https://man.freebsd.org/cgi/man.cgi?query=ktr&sektion=4) 来使用这些功能，然后通过 sysctl 设置打开或关闭各种日志位。使用 [ktrdump(8)](https://man.freebsd.org/cgi/man.cgi?query=ktrdump&sektion=8&format=html) 提取日志，再通过显示程序处理，就能生成图表等可视化内容。

```sh
options 	OFED
options 	OFED_DEBUG_INIT
```

OpenFabrics 企业版分发（InfiniBand）。

```sh
options 	SDP
options 	SDP_DEBUG
```

套接字直接协议（SDP）。


```sh
options 	IPOIB # Infiniband 协议栈及其支持
options 	IPOIB_DEBUG
options 	IPOIB_CM # 使用连接模式（connected mode）的 IPoIB
```

IP over Infiniband (IPoIB)，基于 InfiniBand 的互联网协议，参见 [wiki/Infiniband](https://wiki.freebsd.org/InfiniBand)。

```sh
options 	ALTQ # 交错队列，Alternate Queuing
options 	ALTQ_CBQ	# 基于类的排队
options 	ALTQ_RED	# 随机早期检测
options 	ALTQ_RIO	# RED 输入/输出
options 	ALTQ_CODEL	# CoDel 主动队列管理
options 	ALTQ_HFSC	# 分层服务曲线调度器
options 	ALTQ_FAIRQ	# 公平包调度器
options 	ALTQ_CDNR	# 流量调节器
options 	ALTQ_PRIQ	# 优先级队列
options 	ALTQ_NOPCC	# TSC 不可用时则必需
options 	ALTQ_DEBUG	# 启用 ALTQ 调试
```

[altq(9)](https://man.freebsd.org/cgi/man.cgi?query=altq&sektion=9)。通过选项 `ALTQ` 启用钩子的基础部分。各个调度策略必须编译进基本系统，不能在此阶段作为模块加载。ALTQ 需要稳定的 TSC，如果你的 TSC 不稳定或在 CPU 节流时发生变化，则必须同时启用选项 `ALTQ_NOPCC`。

```sh
options 	NETGRAPH		# netgraph(4) 系统 ①
options 	NETGRAPH_DEBUG		# 启用额外调试，这会影响 netgraph(4) 及其节点。
```

- ①：[netgraph(4)](https://man.freebsd.org/cgi/man.cgi?netgraph(4)) 系统，是一款网络工具包。使用选项 `NETGRAPH` 启用 netgraph 核心代码。

可以通过下列对应的选项启用各个节点类型；不过这并非严格必要，因为如果节点类型尚未编译进内核，netgraph 会自动加载对应的 KLD 模块。下面的每种类型都有对应的手册页，例如 [ng_async(4)](https://man.freebsd.org/cgi/man.cgi?query=ng_async&apropos=0&sektion=4)。

```sh
options 	NETGRAPH_ASYNC # ng_async(4)
options 	NETGRAPH_BLUETOOTH		# ng_bluetooth(4)
options 	NETGRAPH_BLUETOOTH_HCI		# ng_hci(4)
options 	NETGRAPH_BLUETOOTH_L2CAP	# ng_l2cap(4)
options 	NETGRAPH_BLUETOOTH_SOCKET	# ng_btsocket(4)
options 	NETGRAPH_BLUETOOTH_UBT		# ng_ubt(4)
options 	NETGRAPH_BLUETOOTH_UBTBCMFW	# ubtbcmfw(4)
options 	NETGRAPH_BPF # ng_bpf(4)
options 	NETGRAPH_BRIDGE # ng_bridge(4)
options 	NETGRAPH_CAR # ng_car(4)
options 	NETGRAPH_CHECKSUM # ng_checksum(4)
options 	NETGRAPH_CISCO # ng_cisco(4)
options 	NETGRAPH_DEFLATE # ng_deflate(4)
options 	NETGRAPH_DEVICE # ng_device(4)
options 	NETGRAPH_ECHO # ng_echo(4)
options 	NETGRAPH_EIFACE # ng_eiface(4)
options 	NETGRAPH_ETHER # ng_ether(4)
options 	NETGRAPH_FRAME_RELAY # ng_frame_relay(4)
options 	NETGRAPH_GIF # ng_gif(4)
options 	NETGRAPH_GIF_DEMUX # ng_gif_demux(4)
options 	NETGRAPH_HOLE # ng_hole(4)
options 	NETGRAPH_IFACE # ng_iface(4)
options 	NETGRAPH_IP_INPUT # ng_ip_input(4)
options 	NETGRAPH_IPFW # ng_ipfw(4)
options 	NETGRAPH_KSOCKET # ng_ksocket(4)
options 	NETGRAPH_L2TP # ng_l2tp(4)
options 	NETGRAPH_LMI # ng_lmi(4)
options 	NETGRAPH_MPPC_COMPRESSION # ng_mppc(4)
options 	NETGRAPH_MPPC_ENCRYPTION # ng_mppc(4)
options 	NETGRAPH_NETFLOW # ng_netflow(4)
options 	NETGRAPH_NAT # ng_nat(4)
options 	NETGRAPH_ONE2MANY # ng_one2many(4)
options 	NETGRAPH_PATCH # ng_patch(4)
options 	NETGRAPH_PIPE # ng_pipe(4)
options 	NETGRAPH_PPP # ng_ppp(4)
options 	NETGRAPH_PPPOE # ng_pppoe(4)
options 	NETGRAPH_PPTPGRE # ng_pptpgre(4)
options 	NETGRAPH_PRED1 # ng_pred1(4)
options 	NETGRAPH_RFC1490 # ng_rfc1490(4)
options 	NETGRAPH_SOCKET # ng_socket(4)
options 	NETGRAPH_SPLIT # ng_split(4)
options 	NETGRAPH_TAG # ng_tag(4)
options 	NETGRAPH_TCPMSS # ng_tcpmss(4)
options 	NETGRAPH_TEE # ng_tee(4)
options 	NETGRAPH_UI # ng_UI(4)
options 	NETGRAPH_VJC # ng_vjc(4)
options 	NETGRAPH_VLAN # ng_vlan(4)
```

netgraph 节点类型：

- NETGRAPH_ASYNC —— [ng_async(4)](https://man.freebsd.org/cgi/man.cgi?query=ng_async&apropos=0&sektion=4)
- NETGRAPH_BLUETOOTH —— [ng_bluetooth(4)](https://man.freebsd.org/cgi/man.cgi?query=ng_bluetooth%284%29&apropos=0&sektion=4)
- NETGRAPH_BLUETOOTH_HCI —— [ng_hci(4)](https://man.freebsd.org/cgi/man.cgi?query=ng_hci%284%29&apropos=0&sektion=4)
- NETGRAPH_BLUETOOTH_L2CAP —— [ng_l2cap(4)](https://man.freebsd.org/cgi/man.cgi?query=ng_l2cap%284%29&apropos=0&sektion=4)
- NETGRAPH_BLUETOOTH_SOCKET —— [ng_btsocket(4)](https://man.freebsd.org/cgi/man.cgi?query=ng_btsocket%284%29&apropos=0&sektion=4)
- NETGRAPH_BLUETOOTH_UBT —— [ng_ubt(4)](https://man.freebsd.org/cgi/man.cgi?query=ng_ubt%284%29&apropos=0&sektion=4)
- NETGRAPH_BLUETOOTH_UBTBCMFW —— [ubtbcmfw(4)](https://man.freebsd.org/cgi/man.cgi?query=ubtbcmfw%284%29&apropos=0&sektion=4)
- NETGRAPH_BPF —— [ng_bpf(4)](https://man.freebsd.org/cgi/man.cgi?query=ng_bpf&sektion=4)
- NETGRAPH_BRIDGE —— [ng_bridge(4)](https://man.freebsd.org/cgi/man.cgi?query=ng_bridge&sektion=4&format=html)
- NETGRAPH_CAR —— [ng_car(4)](https://man.freebsd.org/cgi/man.cgi?query=ng_car&sektion=4)
- NETGRAPH_CHECKSUM —— [ng_checksum(4)](https://man.freebsd.org/cgi/man.cgi?query=ng_checksum&sektion=4)
- NETGRAPH_CISCO —— [ng_cisco(4)](https://man.freebsd.org/cgi/man.cgi?query=ng_cisco&sektion=4)
- NETGRAPH_DEFLATE —— [ng_deflate(4)](https://man.freebsd.org/cgi/man.cgi?query=ng_deflate&sektion=4)
- NETGRAPH_DEVICE —— [ng_device(4)](https://man.freebsd.org/cgi/man.cgi?query=ng_device&sektion=4)
- NETGRAPH_ECHO —— [ng_echo(4)](https://man.freebsd.org/cgi/man.cgi?query=ng_echo&sektion=4)
- NETGRAPH_EIFACE —— [ng_eiface(4)](https://man.freebsd.org/cgi/man.cgi?query=ng_eiface&sektion=4)
- NETGRAPH_ETHER —— [ng_ether(4)](https://man.freebsd.org/cgi/man.cgi?query=ng_ether&sektion=4)
- NETGRAPH_FRAME_RELAY —— [ng_frame_relay(4)](https://man.freebsd.org/cgi/man.cgi?query=ng_frame_relay&sektion=4)
- NETGRAPH_GIF —— [ng_gif(4)](https://man.freebsd.org/cgi/man.cgi?query=ng_gif&sektion=4)
- NETGRAPH_GIF_DEMUX —— [ng_gif_demux(4)](https://man.freebsd.org/cgi/man.cgi?query=ng_gif_demux&sektion=4)
- NETGRAPH_HOLE —— [ng_hole(4)](https://man.freebsd.org/cgi/man.cgi?query=ng_hole&sektion=4)
- NETGRAPH_IFACE —— [ng_iface(4)](https://man.freebsd.org/cgi/man.cgi?query=ng_iface&sektion=4)
- NETGRAPH_IP_INPUT —— [ng_ip_input(4)](https://man.freebsd.org/cgi/man.cgi?query=ng_ip_input&sektion=4)
- NETGRAPH_IPFW —— [ng_ipfw(4)](https://man.freebsd.org/cgi/man.cgi?query=ng_ipfw&sektion=4)
- NETGRAPH_KSOCKET —— [ng_ksocket(4)](https://man.freebsd.org/cgi/man.cgi?query=ng_ksocket&sektion=4)
- NETGRAPH_L2TP —— [ng_l2tp(4)](https://man.freebsd.org/cgi/man.cgi?query=ng_l2tp&sektion=4)
- NETGRAPH_LMI —— [ng_lmi(4)](https://man.freebsd.org/cgi/man.cgi?query=ng_lmi&sektion=4)
- NETGRAPH_MPPC_COMPRESSION —— [ng_mppc(4)](https://man.freebsd.org/cgi/man.cgi?query=ng_mppc&sektion=4)
- NETGRAPH_MPPC_ENCRYPTION —— [ng_mppc(4)](https://man.freebsd.org/cgi/man.cgi?query=ng_mppc&sektion=4)
- NETGRAPH_NETFLOW —— [ng_netflow(4)](https://man.freebsd.org/cgi/man.cgi?query=ng_netflow&sektion=4)
- NETGRAPH_NAT —— [ng_nat(4)](https://man.freebsd.org/ng_nat(4))
- NETGRAPH_ONE2MANY —— [ng_one2many(4)](https://man.freebsd.org/cgi/man.cgi?query=ng_one2many)
- NETGRAPH_PATCH —— [ng_patch(4)](https://man.freebsd.org/cgi/man.cgi?query=ng_patch&sektion=4)
- NETGRAPH_PIPE —— [ng_pipe(4)](https://man.freebsd.org/cgi/man.cgi?query=ng_pipe&apropos=0&sektion=4)
- NETGRAPH_PPP —— [ng_ppp(4)](https://man.freebsd.org/cgi/man.cgi?query=ng_ppp&sektion=4)
- NETGRAPH_PPPOE —— [ng_pppoe(4)](https://man.freebsd.org/cgi/man.cgi?query=ng_pppoe)
- NETGRAPH_PPTPGRE —— [ng_pptpgre(4)](https://man.freebsd.org/cgi/man.cgi?query=ng_pptpgre&sektion=4)
- NETGRAPH_PRED1 —— [ng_pred1(4)](https://man.freebsd.org/cgi/man.cgi?query=ng_pred1&sektion=4)
- NETGRAPH_RFC1490 —— [ng_rfc1490(4)](https://man.freebsd.org/cgi/man.cgi?query=ng_rfc1490&sektion=4)
- NETGRAPH_SOCKET —— [ng_socket(4)](https://man.freebsd.org/cgi/man.cgi?query=ng_socket&sektion=4)
- NETGRAPH_SPLIT —— [ng_split(4)](https://man.freebsd.org/cgi/man.cgi?query=ng_split&sektion=4)
- NETGRAPH_TAG —— [ng_tag(4)](https://man.freebsd.org/cgi/man.cgi?query=ng_tag)
- NETGRAPH_TCPMSS —— [ng_tcpmss(4)](https://man.freebsd.org/cgi/man.cgi?query=ng_tcpmss&sektion=4)
- NETGRAPH_TEE —— [ng_tee(4)](https://man.freebsd.org/cgi/man.cgi?query=ng_tee)
- NETGRAPH_UI —— [ng_UI(4)](https://man.freebsd.org/cgi/man.cgi?query=ng_UI&sektion=4)
- NETGRAPH_VJC —— [ng_vjc(4)](https://man.freebsd.org/cgi/man.cgi?query=ng_vjc&sektion=4)
- NETGRAPH_VLAN —— [ng_vlan(4)](https://man.freebsd.org/cgi/man.cgi?query=ng_vlan)

```sh
options 	VIMAGE
options 	VNET_DEBUG	# VIMAGE 调试用
```

[vimage(9)](https://man.freebsd.org/cgi/man.cgi?query=vimage&sektion=9)（即 VNET(9) 的别名），用于网络栈虚拟化。

#### 网络接口

```sh
device		loop
```

当启用网络功能时，[loop(4)](https://man.freebsd.org/cgi/man.cgi?query=loop&apropos=0&sektion=4) 设备是 **必需的**。

```sh
device		ether
```

`ether` 设备提供了用于处理以太网的通用代码；当需要配置以太网设备驱动时，它是 **必需的**。

```sh
device		vlan
```

[vlan(4)](https://man.freebsd.org/cgi/man.cgi?query=vlan&apropos=0&sektion=4) 设备可根据 IEEE 802.1Q 实现以太网帧的 VLAN 标记。

```sh
device		vxlan
```

[vxlan(4)](https://man.freebsd.org/cgi/man.cgi?query=vxlan&apropos=0&sektion=4) 设备将根据 RFC7348 实现以太网帧在 UDP 数据包中的 VXLAN 封装。

```sh
device		wlan
options 	IEEE80211_DEBUG		# 启用调试信息
options 	IEEE80211_DEBUG_REFCNT
options 	IEEE80211_SUPPORT_MESH	# 启用 802.11s D3.0
options 	IEEE80211_SUPPORT_TDMA	# 启用 TDMA 
```

[wlan(4)](https://man.freebsd.org/cgi/man.cgi?query=wlan&apropos=0&sektion=4) 设备提供了支持 802.11 驱动的通用代码，包括主机 AP 模式；对于 wi 和 ath 驱动来说，`wlan` 是 **必需的**，并且最终将成为所有 802.11 驱动的必需项。

```sh
device		wlan_wep # 支持 WEP 加密协议
device		wlan_tkip # 支持 TKIP 加密协议
device		wlan_ccmp # 支持 AES-CCMP 加密协议
device		wlan_gcmp # 支持 AES-GCMP 加密协议
```

可选设备，依赖 802.11 `wlan` 模块。

```sh
device		wlan_xauth
```

`wlan_xauth` 设备提供了对外部（即用户态）认证器的支持，用于依赖 `wlan` 模块并支持 802.1x 和/或 WPA 安全协议的 802.11 驱动。

```sh
device		wlan_acl
device		wlan_amrr
```

- `wlan_acl` 设备提供了基于 MAC 的访问控制机制，用于在 AP 模式下运行并使用 `wlan` 模块的 802.11 驱动。
- `wlan_amrr` 设备提供了 AMRR 传输速率控制算法。

```sh
device		bpf
```

`bpf` 设备将启用伯克利数据包过滤器（Berkeley Packet Filter）。启用此选项时需注意法律和管理上的相关后果。DHCP 依赖 bpf。

```sh
device		netmap
```

`netmap` 设备可实现从用户态对网络设备的内存映射访问，即使在 10Gbit/s 速率下也能实现线速数据包捕获和生成。需要设备驱动支持。支持的驱动有 ixgbe、e1000、re。

```sh
device		disc
```

`disc` 设备实现了一个最简网络接口，会丢弃所有发送的数据包，且永远不会接收任何数据包。它用于测试和基准性能评估。

```sh
device		epair
```

`epair` 设备实现了一对虚拟的背靠背连接的以太网接口。


```sh
device		edsc
```

`edsc` 设备实现了一个最简以太网接口，会丢弃所有发送的数据包，且不接收任何数据包。

```sh
device		tuntap
```

`tuntap` 设备实现了 (用户态) PPP、[nos-tun(8)](https://man.freebsd.org/cgi/man.cgi?query=nos-tun&sektion=8) 以及类似 pty 的虚拟以太网接口。

```sh
device		gif
device		gre
device		me
options 	XBONEHACK
```

- `gif` 设备实现了 IPv6 over IPv4 隧道、IPv4 over IPv6 隧道、IPv4 over IPv4 隧道以及 IPv6 over IPv6 隧道。
- `gre` 设备实现了 GRE（通用路由封装）隧道，遵循 RFC 2784 和 RFC 2890 规范。
- `me` 设备实现了 IPv4 内的最小封装（Minimal Encapsulation），遵循 RFC 2004 规范。
- `XBONEHACK` 选项可在多个 `gif` 接口上配置相同的地址对。

```sh
device		stf
```

`stf` 设备实现了 6to4 封装。


```sh
device		pf
device		pflog
device		pfsync
```

PF 数据包过滤器由三款设备组成：

- `pf` 设备提供了 `/dev/pf` 以及防火墙代码本身。
- `pflog` 设备提供了 `pflog0` 接口，用于记录数据包。
- `pfsync` 设备提供了 `pfsync0` 接口，用于防火墙状态表的同步（通过网络）。

```sh
device		if_bridge
```

桥接接口。

```sh
device		carp
```

通用地址冗余协议（CARP）。更多详情参见 [carp(4)](https://man.freebsd.org/cgi/man.cgi?carp(4))。

```sh
device		enc
```

IPsec 接口。

```sh
device		lagg
```

LAGG 链路聚合接口。

```sh
device		wg
```

WireGuard 接口。

```sh
device		dummymbuf
```

dummymbuf —— mbuf 修改的 pfil 钩子。

#### 互联网协议族

```sh
options 	MROUTING		# 多播路由 ①
options 	IPFIREWALL		# IP 防火墙 ②
options 	IPFIREWALL_VERBOSE	# 启用日志记录到 syslogd(8) ③
options 	IPFIREWALL_VERBOSE_LIMIT=100	# 限制日志详细程度 ④
options 	IPFIREWALL_DEFAULT_TO_ACCEPT	# 默认放行所有流量 ⑤
options 	IPFIREWALL_NAT		# 为 ipfw 内核 NAT 提供支持，需要 LIBALIAS
options 	IPFIREWALL_NAT64	# 为 ipfw 内核 NAT64 提供支持
options 	IPFIREWALL_NPTV6	# 为 ipfw 内核 NPTv6 提供支持
options 	IPDIVERT		# 转发套接字。启用 divert IP 套接字，用于 `ipfw divert`。如果要编译进内核，则依赖 IPFIREWALL
options 	IPFILTER		# ipfilter 支持
options 	IPFILTER_LOG		# ipfilter 日志
options 	IPFILTER_LOOKUP		# ipfilter 池
options 	IPFILTER_DEFAULT_BLOCK	# 默认阻止所有数据包
options 	IPSTEALTH		# 支持隐形转发（即转发数据包而不修改 TTL），这对于隐藏防火墙免受 traceroute 等工具探测很有用
options 	PF_DEFAULT_TO_DROP	# 默认丢弃所有数据包，使 pf(4) 默认规则拒绝所有流量。
options 	TCP_BLACKBOX # 启用增强的 TCP 事件日志功能
options 	TCP_HHOOK # 启用 TCP 栈的 hhook(9) 框架钩子
options		SOCKET_HHOOK # 启用套接字操作的 hhook(9) 框架钩子
options 	ROUTE_MPATH # 提供了多路径路由支持
```

- ①：`MROUTING` 将启用内核多播数据包转发功能，可与 mrouted 和 XORP 一起使用。
- ②：`IPFIREWALL` 需要配合程序 `ipfw` 使用。
- ③：`IPFIREWALL_VERBOSE` 会将记录的数据包发送到系统日志。
- ④：`IPFIREWALL_VERBOSE_LIMIT` 限制匹配条目的日志记录次数。

>**警告**：
>
>IPFIREWALL 默认策略为 `deny ip from any to any`，如果在启动时未添加放行访问的规则，**你将把自己关在门外**。建议首次启用此功能时，在 `/etc/rc.conf` 中将 `firewall_type` 设置为 `open`，然后在确认新内核功能正常工作后，再在 `/etc/rc.firewall` 中完善防火墙规则。

- ⑤：`IPFIREWALL_DEFAULT_TO_ACCEPT` 会使默认规则（启动时）放行所有流量。请谨慎使用，如果攻击者能入侵你的防火墙机器，他们可能访问你的受保护机器。但如果只是作为按需过滤特定问题的工具，这可能适合你。将默认策略改为 `allow` 可以避免内核与 /sbin/ipfw 二进制不同步时被卡住。

`IPFIREWALL_PMOD` 支持协议修改模块。目前仅支持 TCP MSS 修改。

>**注意**
>
>`IPFIREWALL_PMOD` 这里有问题。原文缺失此条目，应为上游文档缺失。
>
>>**思考题**
>>
>>读者可能希望进一步研究这里的缺失条目 `IPFIREWALL_PMOD`，请仔细查阅源代码及 [Add ipfw protocol modification module ipfw_pmod](https://reviews.freebsd.org/D10150) 等相关提及，并提交 PR 到 FreeBSD src。


```sh
options 	MBUF_STRESS_TEST
options 	MBUF_PROFILING
```

`MBUF_STRESS_TEST` 选项用于启用与 mbuf 函数相关的各种随机故障或极端情况测试。可参见 [mbuf(9)](https://man.freebsd.org/mbuf(9)) 获取可用测试用例列表。

`MBUF_PROFILING` 启用对系统输出的 mbuf 链（通过相应接口）进行分析的代码，并返回监控参数的对数直方图（例如数据包大小、浪费空间、链中 mbuf 数量）。

```sh
options 	ACCEPT_FILTER_DATA	# 数据连接接收过滤器
options 	ACCEPT_FILTER_DNS	# DNS 请求接收过滤器
options 	ACCEPT_FILTER_HTTP	# HTTP 请求接收过滤器
options		ACCEPT_FILTER_TLS	# TLS 握手接收过滤器
```

静态链接接收过滤器（accept filters）。

```sh
options 	TCP_SIGNATURE		# 支持 RFC 2385
```

`TCP_SIGNATURE` 为 RFC 2385（TCP-MD5）摘要提供了支持。这些摘要通过 TCP 选项 19 携带。该选项通常用于保护 TCP 会话（例如 BGP），适用于无法或不希望使用 IPsec 的情况。

此功能可以按套接字启用，通过 TCP_MD5SIG 套接字选项实现。

启用此功能需要使用 `device crypto`，并且需要启用 `options IPSEC` 或 `options IPSEC_SUPPORT`。

```sh
options 	DUMMYNET
```

`DUMMYNET` 将启用带宽限制器 “dummynet”。此功能还需要 `IPFIREWALL`。更多信息请参见 [dummynet(4)](https://man.freebsd.org/dummynet(4)) 和 [ipfw(8)](https://man.freebsd.org/cgi/man.cgi?ipfw(8))。在运行 DUMMYNET 时，HZ/kern.hz 应至少为 1000，以确保响应足够及时。


```sh
options 	DEBUGNET
```

`DEBUGNET` 选项将启用基础调试/内核 panic 时的网络 API。NETDUMP 和 NETGDB 需要使用 `DEBUGNET`。

```sh
options 	NETDUMP
```

`NETDUMP` 选项将在内核中启用对 [netdump(4)](https://man.freebsd.org/netdump(4)) 客户端支持。它可在内核 panic 时将内核转储发送到远程主机。


```sh
options 	NETGDB
```

`NETGDB` 选项在内核中启用对 [netgdb(4)](https://man.freebsd.org/cgi/man.cgi?query=netgdb&sektion=4&format=html) 的支持。它能通过网络将 panic 的内核作为 GDB 远程调试目标。

### 文件系统

只有根文件系统需要静态编译或预先加载为模块；其他文件系统可在挂载时自动加载。不过，有些人也倾向于静态编译其他文件系统。

>**注意**
>
>UNION 文件系统曾存在缺陷。现在得到了积极维护，尽管仍有一些问题需要解决。

```sh
options 	FFS			# 快速文件系统（Fast Filesystem），即 UFS
options 	NFSCL			# 网络文件系统客户端（NFS client）
```

以上选项中，至少选择一项。

```sh
options 	AUTOFS			# 自动挂载文件系统
options 	CD9660			# ISO 9660 文件系统
options 	FDESCFS			# 文件描述符文件系统
options 	FUSEFS			# FUSEFS 支持模块
options 	MSDOSFS			# MS DOS 文件系统（FAT、FAT32）
options 	NFSLOCKD		# 网络锁管理器
options 	NFSD			# 网络文件系统服务器
options 	KGSSAPI			# 内核 GSSAPI 实现

options 	NULLFS			# NULL 文件系统
options 	PROCFS			# 进程文件系统（需要 PSEUDOFS）
options 	PSEUDOFS		# 虚拟文件系统框架
options 	PSEUDOFS_TRACE		# PSEUDOFS 调试支持
options 	SMBFS			# SMB/CIFS 文件系统
options 	TMPFS			# 高效内存文件系统
options 	UDF			# 通用光盘格式（Universal Disk Format）
options 	UNIONFS			# Union 文件系统
```

以上选项，均为可选。

```sh
options 	NFS_ROOT
```

将 NFS 用作根文件系统（root device）的支持。

```sh
options 	SOFTUPDATES
```

软更新（Soft Updates）是一种提高文件系统速度并降低突然关机风险的技术。

```sh
options 	UFS_EXTATTR # ①
options 	UFS_EXTATTR_AUTOSTART # ②
```

UFS 扩展属性（Extended Attributes）可将附加数据与文件关联，用于 ACL、Capabilities 和 MAC 标签。更多信息请参见 `src/sys/ufs/ufs/README.extattr`。

- ①：`UFS_EXTATTR`：扩展属性可将附加的任意元数据与文件和目录关联，这些元数据既可以从用户态分配和读取，也可以在内核内部操作；参见 extattrctl(8)。
- ②：如果定义了选项 `UFS_EXTATTR_AUTOSTART`，UFS 会在挂载操作期间搜索文件系统根目录下的 `.attribute` 子目录。如果找到了该目录，将自动为该文件系统启用扩展属性支持。

参见 [ffs(7)](https://man.freebsd.org/cgi/man.cgi?ffs(7))。

```sh
options 	UFS_ACL
```

对 UFS 文件系统的访问控制列表（ACL）的支持。当前的 ACL 实现依赖底层文件系统的扩展属性支持（UFS_EXTATTR）。更多信息请参见 `src/sys/ufs/ufs/README.acls`。

```sh
options 	UFS_DIRHASH
```

UFS 目录哈希（Directory Hashing）可通过消耗一些内存来提高对非常大目录的操作速度。

```sh
options 	UFS_GJOURNAL
```

基于 [gjournal(8)](https://man.freebsd.org/gjournal(8)) 的 UFS 日志支持。

```sh
options 	MD_ROOT_SIZE=10
```

在内核中为基于 md 设备的根文件系统预留空间。此处定义需为文件系统保留的千字节（KB）数。

该定义现为可选项。

- 若未定义，通过 `MFS_IMAGE` 编译选项传入的根文件系统将在链接阶段自动嵌入内核，其实际大小将完全占用内核空间。
- 若已定义，则会采用旧版内核嵌入文件系统的方式：即先在内核中分配 `MD_ROOT_SIZE` 千字节（KB）的固定空间，后续若通过 `MFS_IMAGE` 编译选项传入的文件系统镜像尺寸匹配，将通过 `dd` 命令将其写入预留区域。

```sh
options 	MD_ROOT
```

将 md 设备配置为潜在根设备，支持预加载的 mfs_root 和 md_root 类型镜像。

```sh
options 	MD_ROOT_READONLY
```

对该 md 根设备启用写保护，以防止其被以可写的方式进行挂载。

```sh
options 	MD_ROOT_MEM
```

允许从外部内存区域读取 md 镜像。

```sh
options 	QUOTA			# 启用磁盘配额
```

启用此选项即可支持磁盘配额功能。

```sh
options 	SUIDDIR
```

若您的设备是仅作为面向 PC 和 Mac 用户的文件服务器（使用 Samba 服务），建议启用此选项，并在支持挂载选项 `suiddir` 的文件系统上设置用户目录。该设置会使新建文件自动继承目录的属主权限（类似于群组权限）。

>**注意**
>
>若允许这些用户执行程序，将存在安全风险，因此请仅限在纯文件服务器环境中使用（此举可有效避免诸多管理难题）。root 用户拥有的目录不受此限制，且执行权限位会被自动清除。

>**注意**
>
>必须同时为目录设置权限位 `suid` （详见 chmod(1) 手册）。由于 PC 用户无法查看/设置文件属主，常导致权限冲突。在启用此功能后，相关文件系统会符合用户直觉——"既然是我的目录，那么创建的文件自然归我所有"，从而显著减少技术支持需求。

```sh
options 	NFS_MINATTRTIMO=3	# VREG 属性缓存超时时间（秒）
options 	NFS_MAXATTRTIMO=60
options 	NFS_MINDIRATTRTIMO=30	# VDIR 属性缓存超时时间（秒）
options 	NFS_MAXDIRATTRTIMO=60
options 	NFS_DEBUG		# 启用 NFS 调试
```

若干 NFS 选项。


```sh
options 	EXT2FS
```

新增对著名的 Linux 文件系统 EXT2 的支持。使用此功能需格外谨慎—— ext2 的代码往往滞后于内核更新且缺乏充分测试，因此以读写模式挂载可能存在风险（哪怕以只读模式挂载也可能导致系统崩溃）。

```sh
device		mem
```

系统内存设备：`/dev/mem`、`/dev/kmem`

```sh
device		ksyms
```

内核符号表设备：`/dev/ksyms`。

```sh
options 	CD9660_ICONV
options 	MSDOSFS_ICONV
options 	UDF_ICONV
```

可选的字符编码转换支持，需配合 `LIBICONV` 实现。每个选项都需要其基础文件系统及 `LIBICONV` 库的支持。

### POSIX P1003.1B

```sh
options 	_KPOSIX_PRIORITY_SCHEDULING
```

1993 年 POSIX 标准新增的实时扩展 `_KPOSIX_PRIORITY_SCHEDULING` 内置了对 `_POSIX_PRIORITY_SCHEDULING` 的支持。


```sh
options 	P1003_1B_SEMAPHORES
```

`p1003_1b_semaphores` 功能仍处于高度实验阶段，若出现问题，用户需协助参与调试工作。

```sh
options 	P1003_1B_MQUEUE
```

POSIX 消息队列。


### 安全策略参数


```sh
options 	AUDIT
```


BSM 审计。

```sh
options 	MAC
options 	MAC_BIBA
options 	MAC_BSDEXTENDED
options 	MAC_DDB
options 	MAC_DO
options 	MAC_IFOFF
options 	MAC_IPACL
options 	MAC_LOMAC
options 	MAC_MLS
options 	MAC_NONE
options 	MAC_NTPD
options 	MAC_PARTITION
options 	MAC_PORTACL
options 	MAC_PRIORITY
options 	MAC_SEEOTHERUIDS
options 	MAC_STUB
options 	MAC_TEST
options 	MAC_VERIEXEC
options 	MAC_VERIEXEC_SHA1
options 	MAC_VERIEXEC_SHA256
options 	MAC_VERIEXEC_SHA384
options 	MAC_VERIEXEC_SHA512
device		mac_veriexec_parser
```

强制访问控制（MAC）。

```sh
options 	CAPABILITIES	# 文件描述符的细粒度权限控制
options 	CAPABILITY_MODE	# 沙盒环境（无法访问全局命名空间）
```

Capsicum 技术。

### 时钟

```sh
options 	HZ=100
```

操作粒度由内核选项 `HZ` 控制（默认频率为 1000 Hz，即调用间隔周期为 1 毫秒）。虚拟机客户系统通常采用数值 `100`。较低的数值可能会以调度精度为代价来降低系统开销，但自适应定时器代码能减少这种开销。

```sh
options 	PPS_SYNC
```

启用内核 PLL 以使用外部 PPS 信号的功能，该功能在 [x]ntpd(8) 的监管下运行。更多信息请参阅 ntpd 文档：<http://www.eecis.udel.edu/~ntp>

```sh
options 	FFCLOCK
```

启用内核中对通用前馈时钟的支持。前馈时钟支持是面向反馈的 ntpd/系统时钟方法的替代方案，需与前馈同步算法（例如 RADclock）配合使用。更多信息请参阅：<http://www.synclab.org/radclock>

### SCSI 设备

```sh
envvar		hint.scbus.0.at="ahc0"
envvar		hint.scbus.1.at="ahc1"
envvar		hint.scbus.1.bus="0"
envvar		hint.scbus.3.at="ahc2"
envvar		hint.scbus.3.bus="0"
envvar		hint.scbus.2.at="ahc2"
envvar		hint.scbus.2.bus="1"
envvar		hint.da.0.at="scbus0"
envvar		hint.da.0.target="0"
envvar		hint.da.0.unit="0"
envvar		hint.da.1.at="scbus3"
envvar		hint.da.1.target="1"
envvar		hint.da.2.at="scbus2"
envvar		hint.da.2.target="3"
envvar		hint.sa.1.at="scbus1"
envvar		hint.sa.1.target="6"
```

SCSI 设备配置。

SCSI 子系统由 SCSI 核心代码、多个高层 SCSI 设备“类型”驱动程序，以及底层主机适配器设备驱动程序组成。主机适配器列表请参阅下文中的 ISA 和 PCI 设备配置章节。

系统可固定 SCSI 设备配置，确保特定总线、目标和 LUN 始终对应同一设备单元。在早期版本中，设备单元号按照 SCSI 总线上探测到的顺序分配。这意味着若移除某磁盘驱动器，可能需重写文件 `/etc/fstab`；同时新增磁盘时也需谨慎，因为可能会提前探测到新设备，从而窜改原有设备的配置。

系统默认保持此传统行为。设备单元分配将从该设备类型首个非固定单元开始。例如，若将某磁盘固定为 `da3`，则首个非固定磁盘将被分配为 `da4`。

设备固定配置语法如上所述。

```sh
device		scbus		# SCSI 核心代码
device		ch		# SCSI 介质转换器
device		da		# SCSI 直接存取（“磁盘”）与光学介质（“WORM”）设备
device		sa		# SCSI 磁带
device		cd		# SCSI 只读直接存取（“光盘”）
device		ses		# 机箱服务（SES 与 SAF-TE）
device		pt		# SCSI 处理器
device		targ		# SCSI 目标模式代码
device		targbh		# SCSI 目标模式黑洞设备
device		pass		# CAM 直通驱动
device		sg		# Linux SCSI 直通
device		ctl		# CAM 目标层
```

未明确指定“单元”（SCSI 逻辑单元号）的设备将默认按 LUN 0 处理。

所有 SCSI 设备会根据实际需求分配相应数量的单元。

- `ch` 驱动程序用于驱动 SCSI 介质转换器（“自动光盘机”）设备。
- `da` 驱动程序用于驱动 SCSI 直接存取（“磁盘”）与光学介质（“WORM”）设备。
- `sa` 驱动程序用于驱动 SCSI 顺序存取（“磁带”）设备。
- `cd` 驱动程序用于驱动 SCSI 只读直接存取（“光盘”）设备。
- `ses` 驱动程序用于驱动 SCSI 环境服务（“ses”）及 SAF-TE（“SCSI 可访问容错机箱”）设备。
- `pt` 驱动程序用于驱动 SCSI 处理器设备。
- `sg` 驱动程序提供与 Linux SG 驱动兼容的直通 API，可与 Linux 模拟器协同运行 Linux SG 应用程序，也可独立运行为应用移植至 FreeBSD 提供源码级 API 兼容性。

目标模式支持在此部分实现，但仍需 SIM（SCSI 主机适配器驱动程序）提供相应支持。

- `targ` 驱动程序以处理器类型设备的形式提供了目标模式支持，其存在旨在提供响应查询命令所需的最小上下文环境。`/usr/share/examples/scsi_target` 目录下提供了展示其余命令支持实现方式的用户应用程序示例。
- `targbh` 驱动程序提供了目标模式支持，专门用于响应未分配逻辑单元的传入命令。
- `pass` 驱动程序提供了访问 CAM 子系统的直通 API。

### CAM

参见 [cam(4)](https://man.freebsd.org/cgi/man.cgi?query=CAM&sektion=4&n=1)

#### CAM 调试相关

```sh
options 	CAMDEBUG
```

编译所有调试功能。

```sh
options 	CAM_DEBUG_COMPILE=-1
```

要编译进去的调试等级。

```sh
options 	CAM_DEBUG_FLAGS=(CAM_DEBUG_INFO|CAM_DEBUG_PROBE|CAM_DEBUG_PERIPH)
```

在启动时启用的调试等级。

```sh
options 	CAM_DEBUG_BUS=-1
```

将调试限制在指定的 bus 上。

```sh
options 	CAM_DEBUG_TARGET=-1
```

将调试限制在指定的 target 上。

```sh
options 	CAM_DEBUG_LUN=-1
```

将调试限制在指定的 lun 上。

```sh
options 	CAM_DEBUG_DELAY=1
```

在打印每一行调试信息后延迟的时间（微秒）。

```sh
options 	CAM_MAX_HIGHPOWER=4
```

并发高功率（start unit）命令的最大数量.

```sh
options 	SCSI_NO_SENSE_STRINGS
```

定义后禁用 sense 描述.

```sh
options 	SCSI_NO_OP_STRINGS
```

定义后禁用 opcode 描述.

```sh
options 	SCSI_DELAY=5000	# 对 Joe SCSI 设备持保守态度
```

`SCSI_DELAY`: 在总线重置后冻结 SIM（SCSI 适配器）队列的毫秒数，以及在总线设备重置后冻结设备队列的毫秒数。可通过可调参数 sysctl `kern.cam.scsi_delay` 在启动时和运行时更改该值。

```sh
options 	CAM_IOSCHED_DYNAMIC
```

根据提示和存储设备的当前性能，在 I/O 调度器中启用动态决策功能。

```sh
options 	CAM_IO_STATS
```

通过 sysctl 显示额外的 CAM 设备统计数据.

```sh
options 	CAM_TEST_FAILURE
```

启用模拟 I/O 故障的功能。


#### CAM CDROM 只读直接存取（“光盘”）设备

```sh
options 	CHANGER_MIN_BUSY_SECONDS=2
```

为 changer LUN 保证的最小时间片。

该变量编译默认值为 2 秒。可通过 sysctl `kern.cam.cd.changer.min_busy_seconds` 进行调整。

```sh
options 	CHANGER_MAX_BUSY_SECONDS=10
```

每个 changer LUN 的最大时间片，仅在有 I/O 等待其他 LUN 时生效。

该变量编译默认值为 10 秒。可通过 sysctl `kern.cam.cd.changer.max_busy_seconds` 进行调整。

#### CAM 顺序访问（“磁带”）设备

```sh
options 	SA_IO_TIMEOUT=4
```

读/写/WFM 操作的超时时间，单位为分钟。

```sh
options 	SA_SPACE_TIMEOUT=60
```

空间操作的超时时间，单位为分钟。

```sh
options 	SA_REWIND_TIMEOUT=(2*60)
```

回带操作的超时时间，单位为分钟。

```sh
options 	SA_ERASE_TIMEOUT=(4*60)
```

擦除操作的超时时间，单位为分钟。

```sh
options 	SA_1FM_AT_EOD
```

默认针对仅在磁带末端（EOT）存在单个文件标记的型号。

#### CAM 处理器目标（pt）设备

```sh
options 	SCSI_PT_DEFAULT_TIMEOUT=60
```

CAM 处理器目标（pt）设备的超时时间（可选），单位为秒。默认值为 60 秒。

#### 在其他设备（例如磁盘）上进行 SES 直通操作

```sh
options 	SES_ENABLE_PASSTHROUGH
```

通常禁用此功能，是因为许多新型SCSI磁盘会报告自身具备 SES（SCSI Enclosure Services）功能，但这可能导致在构建拓扑时与磁盘所在机箱的 SES 设备产生冲突。

#### iSCSI

```sh
device		cfiscsi		# CAM 目标层 iSCSI target 前端
device		iscsi		# iSCSI initiator 发起端
device		iser		# iSCSI RDMA 扩展（iSER）发起端
```

iSCSI 可通过网络连接（例如通过 TCP/IP 套接字）访问 SCSI 外设。

### 杂项设备和选项

```sh
device		pty
```

BSD 风格兼容的伪 tty。

```sh
device		nmdm
```

背靠背（back-to-back）tty 设备。


```sh
device		md
```

基于内存（通过 malloc 分配）的磁盘设备。

```sh
device		snp
```

Snoop 设备 —— 用于查看 pty / vty 等等。


```sh
device		ccd
```

级联磁盘（Concatenated disk）驱动程序


```sh
device		firmware
```

[firmware(9)](https://man.freebsd.org/firmware(9)) 支持，firmware 映像的加载与管理。

```sh
options 	LIBICONV
```

内核端 iconv 库，参见 [iconv(3)](https://man.freebsd.org/cgi/man.cgi?query=iconv&sektion=3)。


```sh
options 	MSGBUF_SIZE=40960
```

内核消息缓冲区的大小。应为 **N × pagesize（内存页大小）**。

### 硬件总线配置

```sh
device		pci
options 	PCI_HP			# PCIe 原生热插拔
options 	PCI_IOV			# PCI SR-IOV 支持
```

PCI 总线与 PCI。


### 硬件设备配置

对于 ISA，总线所需的提示已列出。PCI、CardBus 和 SD/MMC 是自识别总线，因此不需要提示。

#### 必需设备

```sh
options 	KBD_DISABLE_KEYMAP_LOAD	# 拒绝加载键盘布局
options 	KBD_INSTALL_CDEV	# 在 /dev 中生成 CDEV 条目
```

这些选项同样适用于其他键盘驱动程序。

```sh
options 	KBD_DELAY1=200		# 定义初始按键延迟
options 	KBD_DELAY2=15		# 定义按键延迟
```

定义键盘延迟（对于响应迅速的交互式控制台，可尝试 `200`、`15`）。

```sh
device		kbdmux			# 键盘多路复用器
options 	KBDMUX_DFLT_KEYMAP	# 指定内置键盘布局
makeoptions	KBDMUX_DFLT_KEYMAP=it.iso  # 设置默认键盘布局为 ISO 意大利
```

```sh
options 	FB_DEBUG
```

帧缓冲调试。

```sh
options 	TEKEN_CONS25		# cons25 风格终端仿真
options 	TEKEN_UTF8		# UTF-8 输出处理
```

启用 syscons 终端仿真器（teken）的实验性功能。


```sh
device		vt
options 	VT_ALT_TO_ESC_HACK=1	# 在 ALT 键前添加 ESC 序列
options 	VT_MAXWINDOWS=16	# 虚拟控制台数量
options 	VT_TWOBUTTON_MOUSE	# 使用右键粘贴
```

vt 视频控制台驱动程序。

```sh
options 	VT_FB_MAX_HEIGHT=480  # 高度
options 	VT_FB_MAX_WIDTH=640  # 宽度
```

以上选项用于设置最大帧缓冲区大小。

```sh
options 	TERMINAL_NORM_ATTR=(FG_GREEN|BG_BLACK)  # 设置普通终端文本的颜色：前景色为绿色，背景色为黑色
options 	TERMINAL_KERN_ATTR=(FG_LIGHTRED|BG_BLACK)  # 设置内核消息文本的颜色：前景色为亮红色，背景色为黑色
```

以上选项能让你自定义默认 vt 终端的颜色。

### 可选设备

#### SCSI 主机适配器

```sh
device		aacraid
```

PMC 的 Adaptec RAID 控制器，第 6/7/8 系列及即将推出的型号。容器接口，需要 CAM。

```
device		ahc
```

Adaptec 274x/284x/2910/293x/294x/394x/3950x/3960x/398X/4944/19160x/29160x，aic7770/aic78xx 系列

```
device		ahd
```

Adaptec 29320/39320 控制器

```sh
device		isp
```

- Qlogic ISP 1020、1040 和 1040B PCI SCSI 主机适配器
- ISP 1240 双 Ultra SCSI，ISP 1080 和 1280（双）Ultra2
- ISP 12160 Ultra3 SCSI
- Qlogic ISP 2100 和 ISP 2200 1Gb 光纤通道主机适配器
- Qlogic ISP 2300 和 ISP 2312 2Gb 光纤通道主机适配器
- Qlogic ISP 2322 和 ISP 6322 2Gb 光纤通道主机适配器

```sh
envvar		hint.isp.0.disable="1"
envvar		hint.isp.0.role="3"
envvar		hint.isp.0.prefer_iomap="1"
envvar		hint.isp.0.prefer_memmap="1"
envvar		hint.isp.0.fwload_disable="1"
envvar		hint.isp.0.ignore_nvram="1"
envvar		hint.isp.0.fullduplex="1"
envvar		hint.isp.0.topology="lport"
envvar		hint.isp.0.topology="nport"
envvar		hint.isp.0.topology="lport-only"
envvar		hint.isp.0.topology="nport-only"
```

isp 相关 hint。

```sh
envvar		hint.isp.0.portwnn="w50000000aaaa0000"
envvar		hint.isp.0.nodewnn="w50000000aaaa0001"
```

isp 相关 hint。

我们无法获取 `u_int64_t` 类型，也无法获取以 `0x` 开头的字符串，因此使用了这个笨拙的变通方法。

```sh
device		ispfw
```

Qlogic 主机适配器的固件模块。

```sh
#device		mpi3mr
```

第 4 代 LSI-Logic MPT/Fusion（仅适用于 aarch64 和 amd64）。

```sh
device		mpr
```

第 3 代 LSI-Logic MPT/Fusion（仅适用于 aarch64 和 amd64）。 

```sh
device		mps
```

第 2 代 LSI-Logic MPT/Fusion（仅适用于 aarch64 和 amd64）。 

```sh
device		mpt
```

LSI-Logic MPT/Fusion 53c1020、53c1030 Ultra4、FC9x9 光纤通道主机适配器。

```sh
device		sym
```

Symbios/Logic 53C8XX 系列 PCI-SCSI I/O 处理器（仅适用于 aarch64 和 amd64）：

- 53C810
- 53C810A
- 53C815
- 53C825
- 53C825A
- 53C860
- 53C875
- 53C876
- 53C885
- 53C895
- 53C895A
- 53C896
- 53C897
- 53C1510D
- 53C1010-33
- 53C1010-66

```sh
options 	AHC_ALLOW_MEMIO
```

只有在设置了此选项时，aic7xxx 驱动程序才会尝试对所有配置了内存映射 I/O 的 PCI 控制器使用内存映射 I/O。不幸的是，这在某些主板上无法工作，因此不能作为默认设置。

```sh
options 	AHC_DUMP_EEPROM
```

转储 ahc 控制器配置 PROM 的内容。

```sh
options 	AHC_TMODE_ENABLE
```

启用 [ahc(4)](https://man.freebsd.org/cgi/man.cgi?query=ahc&sektion=4) target mode 操作的单元位图。

```sh
options 	AHC_DEBUG
```

编译 Aic7xxx 调试代码。

```sh
options 	AHC_DEBUG_OPTS
```

Aic7xxx 驱动调试选项。参见 [sys/dev/aic7xxx/aic7xxx.h](https://github.com/freebsd/freebsd-src/blob/main/sys/dev/aic7xxx/aic7xxx.h)。

```sh
options 	AHC_REG_PRETTY_PRINT
```

在调试输出中打印寄存器位字段。会使驱动增加约 128KB 的大小。参见 [ahc(4)](https://man.freebsd.org/cgi/man.cgi?query=ahc&sektion=4)。

```sh
options 	AHD_DEBUG
```

编译 aic79xx 调试代码。

```sh
options 	AHD_DEBUG_OPTS=0xFFFFFFFF
```

Aic79xx 驱动调试选项。会使驱动增加约 215KB。参见 [ahd(4)](https://man.freebsd.org/ahd(4))。

```sh
options 	AHD_REG_PRETTY_PRINT
```

在调试时打印可读的寄存器定义。

```sh
options 	AHD_TMODE_ENABLE
```

启用 [ahd(4)](https://man.freebsd.org/ahd(4)) target mode 操作的单元位图。
