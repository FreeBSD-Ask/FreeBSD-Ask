# 22.16 FreeBSD 内核配置选项

## 内核配置选项路径

- amd64 内核配置选项位于 [freebsd-src/main/sys/amd64/conf](https://github.com/freebsd/freebsd-src/tree/main/sys/amd64/conf)。
- Arm64 内核配置选项位于 [freebsd-src/main/sys/arm64/conf](https://github.com/freebsd/freebsd-src/tree/main/sys/arm64/conf)。
- RISC-V 内核配置选项位于 [freebsd-src/main/sys/riscv/conf](https://github.com/freebsd/freebsd-src/tree/main/sys/riscv/conf)

## amd64 内核配置文件

介绍  [freebsd-src/main/sys/amd64/conf](https://github.com/freebsd/freebsd-src/tree/main/sys/amd64/conf)：

- `DEFAULTS`：FreeBSD/amd64 的默认内核配置文件，只有不到 30 行
- `FIRECRACKER`：面向 [Firecracker](https://firecracker-microvm.github.io/) VM 的内核配置文件，参见 [amd64: Add FIRECRACKER kernel configuration](https://reviews.freebsd.org/D36672)
- `GENERIC`：FreeBSD/amd64 通用内核配置文件，所有 amd64 镜像默认基于此。350 余行。
- `GENERIC-KASAN`：调试开发用。参见 [amd64: Add MD bits for KASAN](https://reviews.freebsd.org/D29455)。用于 KASAN（Kernel Address SANitizer，内核地址清理器），参见 [kasan(9)](https://man.freebsd.org/cgi/man.cgi?query=kasan&sektion=9&format=html)，只有不到十行
- `GENERIC-KCSAN`：调试开发用。KCSAN（Kernel Concurrency Sanitizer，内核并发清理器）。30 余行，参见 [Port the NetBSD KCSAN runtime to FreeBSD](https://reviews.freebsd.org/D22315)
- `GENERIC-KMSAN`：调试开发用。不到十行。KMSAN（Kernel Memory SANitizer，内核内存清理器）参见 [KMSAN(9)](https://man.freebsd.org/cgi/man.cgi?query=kmsan&sektion=9&format=html)
- `GENERIC-MMCCAM`：调试开发用。使用 MMCCAM 代替 MMC 栈。不到二十行。参见 [MMC stack on top of CAM framework](https://reviews.freebsd.org/D4761)。
- `GENERIC-NODEBUG`：[CURRENT 系统会启用](https://github.com/freebsd/freebsd-src/blob/main/UPDATING)，用于调试开发。三十余行。基于 GENERIC 配置文件，但是删掉了 [WITNESS (4)](https://man.freebsd.org/cgi/man.cgi?witness(4))（跟踪每个线程获取和释放的锁）和 [INVARIANTS (9)](https://man.freebsd.org/cgi/man.cgi?KASSERT(9))（内核表达式验证宏）。
- `GENERIC.hints`：一些 [hints](https://man.freebsd.org/device.hints) 参数。二十余行。用于设置驱动的参数。
- `LINT`：LINT 文件，参见 [Eliminate building LINT makefiles](https://reviews.freebsd.org/D26540)，用于验证代码风格格式等。不到五行。
- `LINT-NOINET`：LINT 文件，不到五行，禁用了 [INET(4)](https://man.freebsd.org/cgi/man.cgi?query=inet&sektion=4&man)（IPv4）。LINT 文件，参见 [Eliminate building LINT makefiles](https://reviews.freebsd.org/D26540)。
- `LINT-NOINET6`：LINT 文件，不到五行，禁用了 [INET(6)](https://man.freebsd.org/cgi/man.cgi?query=inet6&sektion=4&man)（IPv6）。LINT 文件，参见 [Eliminate building LINT makefiles](https://reviews.freebsd.org/D26540)。
- `LINT-NOIP`：LINT 文件，不到三十行，禁用了 IP 协议相关（IPv4、IPv6、TLS 等）。LINT 文件，参见 [Eliminate building LINT makefiles](https://reviews.freebsd.org/D26540)。
- `LINT-NOVIMAGE`：调试开发用。LINT 文件，不到五行，禁用了 [VIMAGE (9)](https://man.freebsd.org/cgi/man.cgi?query=vimage&sektion=9&manpath=freebsd-release-ports)（实际上是 VNET(9) 的别名，网络子系统虚拟化基础设施）。参见 [sys: add LINT-NOVIMAGE](https://reviews.freebsd.org/D50780)
- `MINIMAL`：FreeBSD/amd64 中最常用的最简内核配置选项。160 余行。
- `MINIMAL-NODEBUG`：等同于 GENERIC-NODEBUG，只不过是 `MINIMAL` 版本的。不到 15 行。

## 内核说明文件

- [freebsd-src/main/sys/amd64/conf/NOTES](https://github.com/freebsd/freebsd-src/blob/main/sys/amd64/conf/NOTES)：amd64 机器相关的内核配置说明文件。不到 200 行。
- [freebsd-src/main/sys/x86/conf/NOTES](https://github.com/freebsd/freebsd-src/blob/main/sys/x86/conf/NOTES)：i386 和 amd64 共用的机器相关配置。650 余行。
- [freebsd-src/main/sys/conf/NOTES](https://github.com/freebsd/freebsd-src/blob/main//sys/conf/NOTES)：机器无关的说明，近 2900 行。

## amd64 机器相关的内核配置说明文件

原文：[freebsd-src/main/sys/amd64/conf/NOTES](https://github.com/freebsd/freebsd-src/blob/main/sys/amd64/conf/NOTES)，版本 [mpi3mr: Broadcom's MPT-Fusion version 4 is amd64 and aarch64 only](https://github.com/freebsd/freebsd-src/commit/2f721943bf20e53b0ba7b5032a2900d0beb67413)。

>**技巧**
>
>可直接剪切/粘贴内核和 hints 条目到内核配置文件中。


### GCOV (生成覆盖率信息) 

```ini
options 	LINDEBUGFS # ①
options 	GCOV # ②
```

- ① 用于调试的 Linux 文件系统，参见 [lindebugfs(5)](https://man.freebsd.org/cgi/man.cgi?query=lindebugfs&sektion=5)
- ② GCOV 实际上是 llvm-cov，参见 [gcov(1)](https://man.freebsd.org/cgi/man.cgi?query=gcov&sektion=1)


### SMP 

可选设备：

```ini
device		atpic			# 可选兼容 pic 可编程中断控制器，ISA 相关
device		mptable			# 可选的 MPSPEC 多处理器表①
```

- ①：显示多处理器配置表，参见 [mptable(1)](https://man.freebsd.org/cgi/man.cgi?query=mptable&sektion=1)



### CPU

>**技巧**
>
>你必须至少指定一款 CPU（即你打算运行的那款 CPU）；删除那些你不打算使用的 CPU 的配置可能会让系统中的某些部分运行得更快。

```ini
cpu		HAMMER			# HAMMER 是 AMD K8 研发代号，即 Opteron（皓龙）& Athlon64（速龙）
```

### 硬件设备配置


可选设备：

```ini
device		vt_efifb	# EFI framebuffer（帧缓冲）①
```

- ① vt(4) 驱动。参见 [vt(4)](https://man.freebsd.org/cgi/man.cgi?query=vt%284%29&apropos=0&sektion=5)


```ini
device		tdfx			# 启用 3Dfx Voodoo
```

3Dfx Voodoo Graphics、Voodoo II 的 /dev/3dfx 字符设备支持（1990 年代的产品）。将创建设备 `/dev/3dfx0` ，以便与 Glide 实现一起使用。该设备应链接到 `/dev/3dfx` 和 `/dev/voodoo`。请注意，这与 XFree86 的 tdfx DRI 模块不同，完全无关。


#### RAID 适配器

```ini
#device	pst
```

Promise Supertrak SX6000 的设备驱动程序

```ini
device		smartpqi
```

Microsemi smartpqi 控制器。这些控制器有类似 SCSI 的接口，并且需要 CAM 基础设施。


```ini
device		mpi3mr			# LSI-Logic MPT-Fusion 4
```

Broadcom MPT Fusion，第 4 版，仅支持 64 位。

#### 网络接口

```ini
device		axp	    # AMD EPYC 集成网卡，依赖 miibus 模块
device		ixl	    # Intel 700 Series Physical Function，依赖 ice_ddp 模块
device		iavf 	  # Intel Adaptive Virtual Function
device		ice		  # Intel 800 Series Physical Function
device		ice_ddp	# Intel 800 Series DDP Package
device		irdma		# Intel 800 Series RDMA 驱动，依赖 ice 模块
device		qlxgb		# QLogic 3200/8200 10Gb 以太网 & CNA 适配器
device		qlxgbe	# QLogic 8300 10Gb 以太网 & CNA 适配器
device		qlxge		# QLogic 8100 系列 10Gb 以太网 & CNA 适配器
device		qlnxe		# QLogic 41000/45000 以太网系列 10/25/40/100 GbE 以太网与 CNA 适配器
device		sfxge		# Solarflare SFC9000 系列 10Gb 以太网
```

#### 其他硬件

```ini
device		ioat		# Intel I/OAT DMA 引擎
```

Intel I/O 加速技术支持

```ini
options 	EFIRT
```

EFI 运行时服务支持

```ini
device		efidev
```

EFI 伪设备

```ini
device		efirtc
```

EFI RTC（实时时钟）

```ini
device		qat_c2xxx
```

带 OpenCrypto 支持的 Intel QuickAssist 驱动，仅支持 Atom C2XXX 芯片组。

```ini
options 	XENHVM		# Xen HVM 内核基础设施
device		xenefi		# Xen EFI 定时器驱动
device 		xenpci		# Xen HVM Hypervisor 服务驱动
device		xentimer	# Xen x86 PV 定时器驱动
```

Xen HVM 虚拟机优化。

### ABI 仿真

```ini
options 	COMPAT_FREEBSD32
```

启用 FreeBSD / i386 二进制文件的 32-bit 运行时支持。

```ini
options 	COMPAT_AOUT
```

启用 （32-bit） a.out 二进制文件支持。


### ZFS

>**注意**
>
>这取决于 crypto、cryptodev 和 ZSTDIO。

```ini
options 	ZFS
```

### VM

```ini
options 	NKPT=31
```

用于早期引导的初始内核页表页数量。这个数量应包含足够的页，以映射内核以及加载器随内核加载的任何模块或其他数据。每个页表页映射 2 MB。

```ini
options 	KSTACK_PAGES=5
```

KSTACK_PAGES 是为每个线程的内核栈分配的内存页数量。


```ini
options 	PV_STATS
```

启用 PV entry 分配器的详细记账功能。

### 内核清理器（sanitizers）

```ini
#options	COVERAGE	# 通用内核覆盖率。KCOV 会依赖此选项
#options	KCOV			# 内核覆盖率清理器
#options	KUBSAN		# 内核未定义行为清理器 ①
#options	KCSAN			# 内核并发清理器
#options	KASAN			# 内核地址清理器
#options	KCSAN			# 内核并发清理器
#options	KMSAN			# 内核内存清理器
```

- ① 警告：KUBSAN 可能会导致内核过大，以至于 loader 无法加载。

