# 第22.4节 C/C++ 环境的配置

## 在 vim 下那些配置

安装 C/C++ 环境的包

此处作一说明，FreeBSD 自带 clang 编译器，但并不含 llvm 中其它组件如 clangd，clang-format 。所以要安装 llvm ，这里各版本的 llvm 都可用，不过至少不应比系统自带的 clang 版本低，在 FreeBSD 13.1 中 clang 版本为 13 。下文使用 llvm15 ，安装后对应的 程序名为 clang15 clang++15 clangd15 clang-format15 。而系统自带的 clang ，程序名为clang 。如果使用不同版本请注意对照。  

```
# pkg install llvm15 cmake git-lite
```

### 安装 vim

```
# pkg install vim
```

先来个 vim 插件管理器 vim-plug, 用其它插件管理器的，请自行调整

```
$ curl -fLo ~/.vim/autoload/plug.vim --create-dirs \
    https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim
```

如果没有 curl 可以

```
$ mkdir -p ~/.vim/autoload
$ fetch -o ~/.vim/autoload/plug.vim \
   https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim
```

也可以用 gitee 加速,自行思考

### coc.nvim 加 clangd 补全

安装 coc.nvim 依赖

```
# pkg install npm
```

其中 node 作为依赖自动安装

在 ~/.vimrc 中写入

```
call plug#begin('~/.vim/plugged')
Plug 'neoclide/coc.nvim',{'branch':'release'}
call plug#end()
```

进入 vim 

```
:PlugInstall
```

插件安装完成，仍在 vim 中,安装 json clangd cmake 补全插件

```
:CocInstall coc-json coc-clangd coc-cmake
```

配置 clangd 补全,在 vim 中

```
:CocConfig
```

打开配置文件后,输入并保存

```
{
	"clangd.path":"clangd15"
}
```

此时已经可以使用 coc 进来补全了

对简单的小程序，在源文件目录下新建 compile_flags.txt 文件,输入

```
-I/usr/local/include 
```

如此可在 coc 可以用 /usr/local/include 下的头文件可以补全。

对于复杂的项目，使用 compile_commands.json 文件设置补全。 clangd 会在你文件的父目录中查找，也会在名为 build/ 的子目录中查找。例如，正在编辑 $SRC/gui/window.cpp, 会查找 $SRC/gui/, $SRC/gui/build/, $SRC/, $SRC/build/,等

以基于CMake的项目为例,在项目文件夹下

项目结构如下所示

![](../.gitbook/assets/ccenv1.png)

```
$ mkdir build
$ cd build
$ cmake -DCMAKE_EXPORT_COMPILE_COMMANDS=1 ..
```

或者在 CMakeLists.txt 中

```
set(CMAKE_EXPORT_COMPILE_COMMANDS ON)
```

可自动生成 compile_commands.json 文件,有了这个文件再编辑源文件时就可以使用补全功能了。

cmake 默认使用的是 系统自带的 clang (FreeBSD 13.1 自带 clang13 ），可以用

```
$ export CC=clang15
$ export CXX=clang++15
```

以上在 sh/bash/zsh 中使用，csh/tcsh 请作相应改动

再执行 cmake 以使用 clang15 

![](../.gitbook/assets/ccenv2.png)

此时已生成 compile_commands.json 文件，可以在 vim 中进行补全

![](../.gitbook/assets/ccenv3.png)

### clang-format 代码美化

~/.vimrc 中加入

```
Plug 'rhysd/vim-clang-format'
```

并在 ~/.vimrci 中设置

```
let g:clang_format#code_style="google"
let g:clang_format#command="clang-format15"
let g:clang_format#auto_format=1
let g:clang_format#auto_format_on_insert_leave=1
```

安装插件后可以使用

```
:PlugInstall
```

如

![](../.gitbook/assets/ccenv4.png)

退出插入模式

![](../.gitbook/assets/ccenv5.png)

### asynctasks.vim 构建任务系统

参考 

* https://github.com/skywind3000/asynctasks.vim/blob/master/README-cn.md

简单易用

最后可以开心编译了

```
$ cd build
$ cmake ..
$ src/test
```

![](../.gitbook/assets/ccenv6.png)

