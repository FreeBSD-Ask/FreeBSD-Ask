# 24.1 FreeBSD 内核选项概述

## 内核配置选项路径

- amd64 内核配置选项位于 [sys/amd64/conf](https://github.com/freebsd/freebsd-src/tree/main/sys/amd64/conf)。
- Arm64 内核配置选项位于 [sys/arm64/conf](https://github.com/freebsd/freebsd-src/tree/main/sys/arm64/conf)。
- RISC-V 内核配置选项位于 [sys/riscv/conf](https://github.com/freebsd/freebsd-src/tree/main/sys/riscv/conf)

## 内核配置文件说明（基于 amd64）

介绍  [freebsd-src/main/sys/amd64/conf](https://github.com/freebsd/freebsd-src/tree/main/sys/amd64/conf)：

- `DEFAULTS`：FreeBSD/amd64 的默认内核配置文件，只有不到 30 行
- `FIRECRACKER`：面向 [Firecracker](https://firecracker-microvm.github.io/) VM 的内核配置文件，参见 [amd64: Add FIRECRACKER kernel configuration](https://reviews.freebsd.org/D36672)
- `GENERIC`：FreeBSD/amd64 通用内核配置文件，所有 amd64 镜像默认基于此。350 余行。
- `GENERIC-KASAN`：调试开发用。参见 [amd64: Add MD bits for KASAN](https://reviews.freebsd.org/D29455)。用于 KASAN（Kernel Address SANitizer，内核地址清理器），参见 [kasan(9)](https://man.freebsd.org/cgi/man.cgi?query=kasan&sektion=9&format=html)，只有不到十行
- `GENERIC-KCSAN`：调试开发用。KCSAN（Kernel Concurrency Sanitizer，内核并发清理器）。30 余行，参见 [Port the NetBSD KCSAN runtime to FreeBSD](https://reviews.freebsd.org/D22315)
- `GENERIC-KMSAN`：调试开发用。不到十行。KMSAN（Kernel Memory SANitizer，内核内存清理器）参见 [KMSAN(9)](https://man.freebsd.org/cgi/man.cgi?query=kmsan&sektion=9&format=html)
- `GENERIC-MMCCAM`：调试开发用。使用 MMCCAM 代替 MMC 栈。不到二十行。参见 [MMC stack on top of CAM framework](https://reviews.freebsd.org/D4761)。
- `GENERIC-NODEBUG`：该文件仅在 [main](https://github.com/freebsd/freebsd-src/blob/main) 分支中存在，用于基准测试。三十余行。基于 GENERIC 配置文件，但是删掉了 [WITNESS (4)](https://man.freebsd.org/cgi/man.cgi?witness(4))（跟踪每个线程获取和释放的锁）和 [INVARIANTS(9)](https://man.freebsd.org/cgi/man.cgi?KASSERT(9))（内核表达式验证宏）。因为 CURRENT 的 GENERIC [默认启用](https://github.com/freebsd/freebsd-src/blob/main/UPDATING) 了上述调试功能，而它们会对系统性能产生影响——通过 `include "std.debug"` 引入，参见 [sys/amd64/conf: unify MINIMAL and GENERIC debug](https://github.com/freebsd/freebsd-src/pull/1124)、[sys/conf/std.debug](https://github.com/freebsd/freebsd-src/blob/main/sys/conf/std.debug)。
- `GENERIC.hints`：一些 [hints](https://man.freebsd.org/device.hints) 参数。二十余行。用于设置驱动的参数。
- `LINT`：LINT 文件，参见 [Eliminate building LINT makefiles](https://reviews.freebsd.org/D26540)，用于验证代码风格格式等。不到五行。
- `LINT-NOINET`：LINT 文件，不到五行，禁用了 [INET(4)](https://man.freebsd.org/cgi/man.cgi?query=inet&sektion=4&man)（IPv4）。LINT 文件，参见 [Eliminate building LINT makefiles](https://reviews.freebsd.org/D26540)。
- `LINT-NOINET6`：LINT 文件，不到五行，禁用了 [INET(6)](https://man.freebsd.org/cgi/man.cgi?query=inet6&sektion=4&man)（IPv6）。LINT 文件，参见 [Eliminate building LINT makefiles](https://reviews.freebsd.org/D26540)。
- `LINT-NOIP`：LINT 文件，不到三十行，禁用了 IP 协议相关（IPv4、IPv6、TLS 等）。LINT 文件，参见 [Eliminate building LINT makefiles](https://reviews.freebsd.org/D26540)。
- `LINT-NOVIMAGE`：调试开发用。LINT 文件，不到五行，禁用了 [VIMAGE (9)](https://man.freebsd.org/cgi/man.cgi?query=vimage&sektion=9)（实际上是 VNET(9) 的别名，网络子系统虚拟化基础设施）。参见 [sys: add LINT-NOVIMAGE](https://reviews.freebsd.org/D50780)
- `MINIMAL`：FreeBSD/amd64 中最常用的最简内核配置选项。160 余行。
- `MINIMAL-NODEBUG`：等同于 GENERIC-NODEBUG，只不过是 `MINIMAL` 版本的。不到 15 行。

## 内核选项说明文件

- [sys/amd64/conf/NOTES](https://github.com/freebsd/freebsd-src/blob/main/sys/amd64/conf/NOTES)：amd64 机器相关的内核配置说明文件。不到 200 行。
- [sys/x86/conf/NOTES](https://github.com/freebsd/freebsd-src/blob/main/sys/x86/conf/NOTES)：i386 和 amd64 共用的机器相关配置。650 余行。
- [sys/arm64/conf/NOTES](https://github.com/freebsd/freebsd-src/blob/main/sys/arm64/conf/NOTES)：arm64（aarch64）机器相关的内核配置说明文件。不到 270 行。
- [sys/arm/conf/NOTES](https://github.com/freebsd/freebsd-src/blob/main/sys/arm/conf/NOTES)：armv7/32 位 arm 机器相关的内核配置说明文件。不到 100 行。
- [sys/riscv/conf/NOTES](https://github.com/freebsd/freebsd-src/blob/main/sys/riscv/conf/NOTES)：riscv64（64 位 RISC-V）机器相关的内核配置说明文件。100 行。
- [sys/powerpc/conf/NOTES](https://github.com/freebsd/freebsd-src/blob/main/sys/powerpc/conf/NOTES)：powerpc/powerpc64/powerpc64le 机器相关的内核配置说明文件。不到 100 行。
- [sys/conf/NOTES](https://github.com/freebsd/freebsd-src/blob/main/sys/conf/NOTES)：机器无关的说明，近 2900 行。

## 附录：man [config(5)](https://man.freebsd.org/cgi/man.cgi?config(5)) 中文

man [config(5)](https://man.freebsd.org/cgi/man.cgi?config(5)) 页面提供了许多关键信息，我们将其全文整理引用如下：

### 名称

**config** — 内核配置文件格式

### 说明

内核配置文件指定 FreeBSD 内核的配置。它由 `config(8)` 处理，用于创建一个构建环境，在该环境中可使用 `make(1)` 构建内核。

### 词法结构

内核配置文件由一系列规范指令组成：

- 规范指令以行首关键字开始，后跟附加参数。
- 规范指令可以以分号 `;` 或换行符结束。长输入行可通过在第二行及之后的行首添加空白字符来拆分。
- 大小写敏感，例如 `"machine"` 和 `"MACHINE"` 是不同标记。
- 双引号字符 `"` 用于开始引用字符串。直到下一个引号的所有字符构成引用字符串的值。可通过 `\"` 在引用字符串中插入 `"`.
- 数字使用 C 风格语法表示。
- `#` 字符表示注释，从 `#` 到当前行末的所有字符被忽略。
- 标记之间的空白被忽略，但引用字符串内部除外。注释行后的空白也将被忽略。

### 配置指令

内核配置指令可在配置文件中任意顺序出现，按出现顺序处理，后面的指令将覆盖之前的效果。

### 核心指令

- **cpu CPU类型**
  
  指定内核将运行的 CPU。配置文件中可出现多个 `cpu` 指令。允许的 CPU 名称列表依赖于架构，定义在 `sys/conf/options.<架构>`。

- **device 名称 [, 名称 [...]]**  
- **devices 名称 [, 名称 [...]]**
  
  配置指定设备包含到内核映像中。通用设备定义在 `sys/conf/files`，架构特定设备定义在 `sys/conf/files.<架构>`。

- **env 文件名**
    
  指定包含内核环境定义的文件。内核会将此环境与 boot 时由 `loader(8)` 准备的环境合并。loader 环境优先于文件中的变量，动态环境优先于两者。

  - 可在静态环境中指定 `loader_env.disabled=1` 禁用 loader 环境。
  - 可在 loader 环境中指定 `static_env.disabled=1` 禁用静态环境（不可与 `loader_env.disabled` 同时使用）。
  - 所有 `env` 和 `envvar` 指令按出现顺序逆序处理，后指定变量覆盖前变量。

- **envvar 设置**
   
  指定单个环境设置加入内核编译环境，格式 `"名称=值"`，可选引号。

- **files 文件名**
  
  指定包含该内核配置文件特定文件列表的文件（类似 `文件.<架构>`）。

- **hints filename**
  
  指定从静态设备配置文件加载设备配置。FreeBSD 5.0 起，内核启动时读取系统设备配置 (`device.hints(5)`)。
  - 静态配置中的 hints 按遇到顺序覆盖。
  - 编译环境中的 hints 优先于编译文件 hints。
  - loader 环境准备的 hints 优先于编译环境 hints。
  - 可通过 `static_hints.disabled=1` 禁用 hints 文件。

- **ident name**
  
  设置内核名称。至少需要一条 `ident` 指令。

- **include 文件名**
  
  读取“文件名”的后续文本，处理完成后返回当前文件。

- **includeoptions 文件名**
  
  指定包含附加选项的文件，常用于自定义构建环境，通常与 `makeoption` 指令结合使用。

- **machine arch [CPU架构]**
  
  指定内核编译的机器架构。合法值：
  
```sh
arm64  — 64 位 ARM 架构
arm    — ARM 架构
amd64  — AMD x86-64 架构
i386   — Intel x86 架构
powerpc — IBM PowerPC 架构
riscv  — RISC-V 架构
```

如指定 `CPU架构`，指向 CPU 架构；未指定则假定与 arch 相同。arch 对应 `MACHINE`， `CPU架构` 对应 `MACHINE_ARCH`。

配置文件只能有一条 machine 指令，除非第二条与第一条参数完全匹配。

- **makeoption options**  
- **makeoptions options**

将选项加入生成的 Makefile。options 为逗号分隔的一个或多个选项：

```sh
MakeVariableName[=值]
MakeVariableName+=值
```

如果仅指定变量名，则值为空字符串。CFLAGS 不可直接修改，可通过 `CONF_CFLAGS` 添加自定义编译器标志。
示例：

```sh
makeoptions MYMAKEOPTION="foo"
makeoptions MYMAKEOPTION+="bar"
makeoptions MYNULLMAKEOPTION
makeoptions CONF_CFLAGS+="-DSOME_CONTROLLING_MACRO"
```

- **maxusers 数值**
  
配置内核某些数据结构大小，`数值` 可为 `0`（自动根据物理内存）或 ≥2。可通过 loader(8) 在启动时进行设置。

- **nocpu CPU类型**
   
移除之前选择的 CPU，用于取消 include 文件中 cpu 指令效果。

- **nodevice 名称 [, 名称 [...]]**  
- **nodevices 名称 [, 名称 [...]]**  
移除之前选择的设备，用于取消 include 文件中 device 或 devices 指令效果。

- **nomakeoption 名称**  
- **nomakeoptions 名称**
  
移除内核构建中先前定义的 make 选项。

- **nooption 名称 [, 名称 [...]]**  
- **nooptions 名称 [, 名称 [...]]**
  
移除先前定义的内核选项。

- **option optionspec [, optionspec [...]]**  
- **options optionspec [, optionspec [...]]**  
添加编译时内核选项，格式：

```sh
名称[=值]
```

未指定 value 则假定为 NULL。通用选项在 `sys/conf/options`，架构特定选项在 `sys/conf/options.<架构>`。

### 文件

- `sys/compile/NAME` — 根据内核配置创建的编译目录  
- `sys/conf/Makefile.arch` — 架构 arch 的 Makefile 片段  
- `sys/conf/files` — 所有架构通用设备  
- `sys/conf/files.arch` — 架构 arch 设备  
- `sys/conf/options` — 所有架构通用选项  
- `sys/conf/options.arch` — 架构 arch 选项  

### 参见

`kenv(1)`, `make(1)`, `device.hints(5)`, `loader.conf(5)`, `config(8)`, `kldload(8)`, `loader(8)`  

Samuel J. Leffler 和 Michael J. Karels, *Building 4.4BSD Kernels with Config*

### 历史

`config(8)` 最早出现在 4.1BSD，随后在 4.4BSD 进行了修订。 FreeBSD 4.0 和 5.0 中内核配置机制得到了进一步改进，支持动态内核配置。

*FreeBSD ports 15.0* — June 13, 2025 — CONFIG(5)

