# 12.2 使用 bhyve 及 vm-bhyve 工具安装 Windows 11

本节基于 FreeBSD 14.2 RELEASE 版本和 Windows 11 IoT Enterprise LTSC。

## 安装固件与所需软件

### 准备 Windows 镜像

Windows 11 IoT Enterprise LTSC，版本 24H2 (x64) - DVD (英文) 系统下载链接（来自 [itellyou](https://next.itellyou.cn/)）：

IoT 版本取消了 TPM、内存大小等安装限制。

SHA256:4F59662A96FC1DA48C1B415D6C369D08AF55DDD64E8F1C84E0166D9E50405D7A

`magnet:?xt=urn:btih:7352bd2db48c3381dffa783763dc75aa4a6f1cff&dn=en-us_windows_11_iot_enterprise_ltsc_2024_x64_dvd_f6b14814.iso&xl=5144817664`

### 准备所需软件

加载内核模块：

>**技巧**
>
>只需执行一次，之后 vm-bhyve 会自动加载该模块。

```sh
# kldload vmm	# 加载 FreeBSD 虚拟机管理模块（vmm）
```

查看已加载的 vmm 相关内核模块：

```sh
# kldstat | grep vmm
 7    1 0xffffffff83320000     44b0 vmmemctl.ko
10    1 0xffffffff83400000   33e438 vmm.ko
```

---

首先，安装 UEFI 固件、VNC 与 vm-bhyve。

- 使用 pkg 安装：

```sh
# pkg install bhyve-firmware vm-bhyve tigervnc-viewer
```

- 或者使用 Ports 安装：

```sh
# 安装 bhyve 固件
# cd /usr/ports/sysutils/bhyve-firmware && make install clean

# 安装 vm-bhyve 管理工具
# cd /usr/ports/sysutils/vm-bhyve && make install clean

# 安装 TigerVNC Viewer
# cd /usr/ports/net/tigervnc-viewer && make install clean
```

---

在 `/etc/rc.conf` 中指定启动 vm 与虚拟机的位置：

```sh
# 启用 vm-bhyve 服务
vm_enable="YES"

# 指定虚拟机存放目录，后续操作均使用此路径
vm_dir="/home/ykla/vm"
```

创建模板路径：

```sh
# mkdir -p /home/ykla/vm/.templates
```

复制模板到虚拟机模板位置：

```sh
# cp /usr/local/share/examples/vm-bhyve/* /home/ykla/vm/.templates
```

`public` 为模板中指定的虚拟交换机名称，`ue0` 为当前宿主机的网卡名称，请根据实际网卡修改（可通过命令 `ifconfig` 查看），否则创建将失败，虚拟机会报错 `exit with error 4`：

```sh
# 创建名为 public 的虚拟交换机
# vm switch create public

# 将物理网卡 ue0 添加到 public 虚拟交换机
# vm switch add public ue0
```

创建后查看新增的 `vm-public`：

```sh
# ifconfig

………省略一部分……

vm-public: flags=1008843<UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST,LOWER_UP> metric 0 mtu 1500
	options=0
	ether 62:bc:e8:9f:f7:e1
	id 00:00:00:00:00:00 priority 32768 hellotime 2 fwddelay 15
	maxage 20 holdcnt 6 proto rstp maxaddr 2000 timeout 1200
	root id 00:00:00:00:00:00 priority 32768 ifcost 0 port 0
	member: ue0 flags=143<LEARNING,DISCOVER,AUTOEDGE,AUTOPTP>
	        ifmaxaddr 0 port 1 priority 128 path cost 20000
	groups: bridge vm-switch viid-4c918@
	nd6 options=9<PERFORMNUD,IFDISABLED>
```

>**技巧**
>
> 如果创建错误，可以将其删除：
>
> ```sh
> # vm switch destroy public
> ```

查看分配的虚拟交换机：

```sh
# vm switch list
NAME    TYPE      IFACE      ADDRESS  PRIVATE  MTU  VLAN  PORTS
public  standard  vm-public  -        no       -    -     ue0
```

为了在 FreeBSD 13.0 及更高版本的宿主机中正确使用 xHCI 鼠标，应加载 hms(4) 驱动，请在 `/boot/loader.conf` 中添加：

```sh
# 启用 USB HID 支持
hw.usb.usbhid.enable=1

# 开机自动加载 usbhid 内核模块
usbhid_load="YES"
```

## 配置虚拟机模板

>**技巧**
>
>如果运行的是 Windows 10 之前的版本，或在 Windows 系统上安装 Microsoft SQL Server 时，需要使用参数 `disk0_opts="sectorsize=512"` 将磁盘扇区大小设置为 512。


根据模板创建 windows 虚拟机，磁盘占用 40GB：

```sh
# vm create -t windows -s 40G winguest
```

>**技巧**
>
> 销毁虚拟机的命令：
>
> ```sh
> # vm  destroy winguest
>
> Are you sure you want to completely remove this virtual machine (y/n)?	# 在这里输入 y，再按回车键即可删除
> ```

但是注意该模板是有问题的，需要进行修改如下，文件路径是 `/home/ykla/vm/winguest/winguest.conf`：

> **注意**
>
> 旧版 FreeBSD 中（FreeBSD 14.0 以前），`/home/` 是被软连接到 `/usr/home/` 的，是一样的。
>
> FreeBSD 14 以降，不再是软连接，而是直接使用 `/home/`。

```ini
# 设置虚拟机使用 UEFI 启动，不支持 UEFI 的 Windows 无法启动（如 Windows XP），Windows 7 支持
loader="uefi"

# 启用图形界面，虚拟机启动时暂停，直到 VNC 客户端连接
graphics="yes"

# 启用 USB 3.0 鼠标支持
xhci_mouse="yes"

# 分配 CPU 数量，建议根据宿主机性能适当调整
cpu=2

# 分配内存大小
memory=4G

# 单个 AHCI 控制器最多挂载 8 块磁盘
# 否则添加磁盘会导致后续网络设备号变化，Windows 会识别为新网卡
ahci_device_limit="8"

# 网络配置
# 建议改为 virtio-net 并在 guest 安装驱动，e1000 开箱即用
network0_type="e1000"
network0_switch="public"

# 磁盘配置
disk0_type="ahci-hd"
disk0_name="disk0.img"

# Windows 默认使用本地时间而非 UTC
utctime="no"

# VNC 显示分辨率
graphics_res="1920x1080"

# 虚拟机唯一标识符
uuid="af86e094-56da-11ed-958f-208984999cc9"

# 网络 MAC 地址
network0_mac="58:9c:fc:0c:5e:bb"
```


## 安装系统

指定 Windows ISO 文件以开始安装。在安装模式下运行时，`vm-bhyve` 会等待，直到 VNC 客户端连接后才启动虚拟机，从而可以捕捉到 Windows 可能显示的提示“Press any key to boot from a CD/DVD”。你能在 `vm list` 中看到，在此时，虚拟机将显示为锁定：

```sh
# vm install winguest /home/ykla/en-us_windows_11_iot_enterprise_ltsc_2024_x64_dvd_f6b14814.iso # 替换成你自己的路径
Starting winguest
  * found guest in /home/ykla/vm/winguest
  * booting...
```

### 从 VNC 访问 Win11


![](../.gitbook/assets/win1.png)

当出现 `Press any key to boot from a CD/DVD` 时，请快速地按几次回车键。

>**技巧**
>
>如果你忘记按了退回到了 UEFI shell，请停止虚拟机，重新执行上面的安装步骤。
>
>![UEFI shell](../.gitbook/assets/win4.png)

![](../.gitbook/assets/win2.png)

![](../.gitbook/assets/win3.png)

![](../.gitbook/assets/win5.png)

请注意将第二项改为“Chinese (Simplified, Mainland China)”

![](../.gitbook/assets/win6.png)

我们选择“Chinese (Simplified, Mainland China)”

![](../.gitbook/assets/win7.png)

开始安装。在安装中会断开若干次 VNC 连接，重新连接即可。

在 tigervnc-viewer 中输入 `localhost`，点击连接，然后按任意键进入安装过程。

>技巧
>
>终止虚拟机：若虚拟机卡死导致命令无效，请使用 `kill -9` 强制终止，以避免影响宿主机关机；若阻碍物理机关机，可在 tty 中按 `Ctrl`+ `C` 跳过等待并强制关机。
>
>```sh
># vm list
>NAME      DATASTORE  LOADER  CPU  MEMORY  VNC           AUTO  STATE
>winguest  default    uefi    2    4G      0.0.0.0:5900  No    Running (2072)
># vm stop winguest
>Sending ACPI shutdown to winguest
>```
>
>如果无效：
>
>```sh
># ps -el
>UID  PID PPID C PRI NI     VSZ    RSS MWCHAN STAT TT     TIME COMMAND
>  0 1858    1 1  68  0   16388      4 wait   IW    3  0:00.00 () /bin/sh /usr/local/sbin/vm _run winguest /home/ykla/zh-cn_windows_11_business_editions_version_24h2_x64_dvd
># kill -9 1858
>```

### 安装后配置

![](../.gitbook/assets/win8.png)

选择“China”。

安装后开机虚拟机：

```sh
# vm start winguest
```

打开 VNC 连接即可。

![](../.gitbook/assets/win9.png)

输入用户名

![](../.gitbook/assets/win10.png)

输入密码

![](../.gitbook/assets/win11.png)

重复输入密码

![](../.gitbook/assets/win12.png)

输入安全问题，会重复三次要求你设置三个不同问题。

![](../.gitbook/assets/win13.png)

隐私设置。可随意调整，然后点击“Accept”

![](../.gitbook/assets/win14.png)

系统在安装过程中会进行更新，可能存在一些方法可跳过（经测试 `oobe\bypassnro` 无效），请读者根据需要自行探索。

![](../.gitbook/assets/win15.png)

![](../.gitbook/assets/win16.png)

汉化系统：

![](../.gitbook/assets/win17.png)

![](../.gitbook/assets/win18.png)

![](../.gitbook/assets/win19.png)

![](../.gitbook/assets/win20.png)

![](../.gitbook/assets/win21.png)

![](../.gitbook/assets/win22.png)

### 故障排除与未竟事宜

如遇问题，请先重启宿主机；若问题仍然存在，可通过 `ifconfig` 检查是否存在多余网卡，并将其删除。

如果虚拟机一直是 stopped 的状态，检查一下你的网络。

查看网络配置（虚拟机关闭状态）：

```sh
# ifconfig
alc0: flags=8802<BROADCAST,SIMPLEX,MULTICAST> metric 0 mtu 1500
        options=c319a<TXCSUM,VLAN_MTU,VLAN_HWTAGGING,VLAN_HWCSUM,TSO4,WOL_MCAST,WOL_MAGIC,VLAN_HWTSO,LINKSTATE>
        ether 20:89:82:94:7c:c9
        media: Ethernet autoselect
        nd6 options=29<PERFORMNUD,IFDISABLED,AUTO_LINKLOCAL>
lo0: flags=8049<UP,LOOPBACK,RUNNING,MULTICAST> metric 0 mtu 16384
        options=680003<RXCSUM,TXCSUM,LINKSTATE,RXCSUM_IPV6,TXCSUM_IPV6>
        inet6 ::1 prefixlen 128
        inet6 fe80::1%lo0 prefixlen 64 scopeid 0x2
        inet 127.0.0.1 netmask 0xff000000
        groups: lo
        nd6 options=21<PERFORMNUD,AUTO_LINKLOCAL>
ue0: flags=8943<UP,BROADCAST,RUNNING,PROMISC,SIMPLEX,MULTICAST> metric 0 mtu 1500
        options=8000b<RXCSUM,TXCSUM,VLAN_MTU,LINKSTATE>
        ether f8:e2:3b:3f:ea:4c
        inet 192.168.31.169 netmask 0xffffff00 broadcast 192.168.31.255
        media: Ethernet autoselect (1000baseT <full-duplex>)
        status: active
        nd6 options=29<PERFORMNUD,IFDISABLED,AUTO_LINKLOCAL>
vm-public: flags=8843<UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST> metric 0 mtu 1500
        ether 3a:e1:fa:98:33:b4
        id 00:00:00:00:00:00 priority 32768 hellotime 2 fwddelay 15
        maxage 20 holdcnt 6 proto rstp maxaddr 2000 timeout 1200
        root id 00:00:00:00:00:00 priority 32768 ifcost 0 port 0
        member: ue0 flags=143<LEARNING,DISCOVER,AUTOEDGE,AUTOPTP>
                ifmaxaddr 0 port 3 priority 128 path cost 20000
        groups: bridge vm-switch viid-4c918@
        nd6 options=9<PERFORMNUD,IFDISABLED>
```

查看网络配置（虚拟机开启状态），此时会多出一个网络接口 `tap0`：

```sh
tap0: flags=8943<UP,BROADCAST,RUNNING,PROMISC,SIMPLEX,MULTICAST> metric 0 mtu 1500
        description: vmnet/winguest/0/public
        options=80000<LINKSTATE>
        ether 58:9c:fc:10:ff:d6
        groups: tap vm-port
        media: Ethernet autoselect
        status: active
        nd6 options=29<PERFORMNUD,IFDISABLED,AUTO_LINKLOCAL>
        Opened by PID 2519
```



## 可选配置

- 查看所有虚拟机状态：


```sh
# vm list
NAME      DATASTORE  LOADER  CPU  MEMORY  VNC  AUTO  STATE
winguest  default    uefi    2    4G      -    No    Stopped
```

- 查看指定的虚拟机状态：

```sh
# vm info winguest
------------------------
Virtual Machine: winguest
------------------------
  state: stopped
  datastore: default
  loader: uefi
  uuid: af86e094-56da-11ed-958f-208984999cc9
  cpu: 2
  memory: 4G

  network-interface
    number: 0
    emulation: e1000
    virtual-switch: public
    fixed-mac-address: 58:9c:fc:0c:5e:bb
    fixed-device: -

  virtual-disk
    number: 0
    device-type: file
    emulation: ahci-hd
    options: -
    system-path: /home/ykla/vm/winguest/disk0.img
    bytes-size: 42949672960 (40.000G)
    bytes-used: 23557898240 (21.940G)
```


## 参考资料

- [vm-bhyve/wiki/Running-Windows](https://github.com/churchers/vm-bhyve/wiki/Running-Windows)，教程主要参考此处。中文版本在 [vm-bhyve Wiki](https://book.bsdcn.org/wen-zhang/wen-zhang/vm-bhyve)
- [The win11 release ISO requires the install-time regedit TPM workaround](https://twitter.com/bhyve_dev/status/1446404943020056581)
- [windows 11 on bhyve](https://forums.freebsd.org/threads/windows-11-on-bhyve.82371/)
- [FreeBSD, bhyve и Windows 11](https://dadv.livejournal.com/209650.html)
- [iki/bhyve/Windows](https://wiki.freebsd.org/bhyve/Windows)
- [churchers/vm-bhyve/wiki](https://github.com/churchers/vm-bhyve/wiki)
- [Using Windows on FreeBSD's vm-bhyve](https://srobb.net/vm-bhyve.html)


