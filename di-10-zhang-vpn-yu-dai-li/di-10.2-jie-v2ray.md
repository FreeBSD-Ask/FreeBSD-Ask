# 10.2 V2Ray

## 安装 V2Ray

V2Ray、Xray-core 配置基本相同，配置文档可以在各自的官方文档找到，Xray 完全可以参考 V2Ray 的配置方法。

### 安装 V2Ray

- 使用 pkg 安装 V2Ray：

```sh
# pkg install v2ray
```

- 或者使用 Ports 安装 V2Ray：

```
# cd /usr/ports/net/v2ray/
# make install clean
```

### 安装 Xray-core

- 也可使用 pkg 安装 Xray-core：

```sh
# pkg install xray-core
```

- 或者使用 Ports 安装 Xray-core：

```sh
# cd /usr/ports/security/xray-core/ 
# make install clean
```


## 启动代理软件

如果事先已有代理客户端，可以将客户端节点配置导出并复制到 FreeBSD 系统中，假设导出的文件名为 `config.json`，然后执行以下命令：

- 如果用 V2Ray 可执行：

```sh
$ v2ray -c config.json
```


- 如果用 Xray-core 可执行：

```sh
$ xray -c config.json
```

此时，代理软件应已成功启动。

## 配置代理参数

此时可打开 `config.json`，找到对应的 `inbounds` 属性。`inbounds` 是一个数组，其中的每个元素表示一项入站接口配置，包括监听地址、端口号和代理协议类型。在需要使用代理的软件中，将代理服务器地址和端口号设置为此处对应的值。

例如，其中一个入站接口的 `protocol` 为 `http`，`listen` 为 `127.0.0.1`，`port` 为 `10809`。若需要让 Firefox 浏览器（Firefox）使用该代理，可在浏览器设置中找到“网络 → 代理服务器”，将 HTTP 代理地址设置为 `127.0.0.1`，端口设置为 `10809`。同理，SOCKS 代理的设置方法也可参考上述步骤。

不同软件的代理设置方式差异较大，整体较为分散。对于桌面软件，通常需要在各自的设置界面中手动配置对应的代理服务器。对于终端命令行程序，如需使用代理，配置过程相对简单。大多数终端命令会读取 `HTTP_PROXY`、`HTTPS_PROXY` 和 `ALL_PROXY` 这三个环境变量，并根据其取值自动使用相应的代理。

下面的命令适用于 sh、bash、zsh：

```sh
$ export HTTP_PROXY="http://127.0.0.1:10809" # 设置 http 代理
$ export HTTPS_PROXY="http://127.0.0.1:10809" # 设置 https 代理
$ export ALL_PROXY="socks5://127.0.0.1:10808" # 设置 socks 代理
```

设置完成后，可在 Firefox 浏览器中访问网页，并观察 V2Ray 输出的日志，即可确认浏览器流量已通过代理转发。终端命令同样会通过代理访问网络，但部分命令对环境变量的支持方式不同，请根据具体软件查阅其代理配置方法。

## 代理流量分流

部分网址并不需要通过代理服务器访问，例如境内网站或本地网络资源。此时需要对网络流量进行分流处理，使一部分流量通过代理转发，另一部分流量采用直连方式访问。

打开 `config.json` 文件，找到对应的 `routing` 属性，其中的 `rules` 子属性用于配置 V2Ray 的流量分流规则。在 `rules` 中可以配置多条分流规则，每条规则通常包含 `ip` 或 `domain` 等匹配条件。代理流量通常包含域名和 IP 地址信息。当 IP 或域名匹配到某条规则时，V2Ray 会根据 `outboundTag` 属性，将流量转发到对应的 `outbounds` 出站配置中，例如标签为 proxy（代理）、direct（直连）或 block 的出站。因此，只需将需要分流处理的域名或 IP 地址配置到相应的规则中即可。相关配置细节可参考 V2Ray 官方文档。实际上，在 V2Ray 客户端中导出配置文件时，通常已包含默认的流量分流规则。

V2Ray 还预置了 `geosite.dat` 和 `geoip.dat` 两个资源文件，其中 `geosite.dat` 按分类保存各类域名信息，`geoip.dat` 按分类保存各类 IP 地址信息。资源文件路径可通过设置环境变量 `V2RAY_LOCATION_ASSET` 指定，V2Ray 会自动在该路径下查找 `geosite.dat` 和 `geoip.dat` 文件。对于 Xray，则使用 `XRAY_LOCATION_ASSET` 环境变量来指定资源文件路径。

例如，在直连规则中可以配置 geosite 中的 cn 域名走直连：

```json
      {
        "domain": [
          "geosite:cn"
        ],
        "outboundTag": "direct",
        "type": "field"
      },
```

V2Ray 社区提供的 cn 域名直连规则覆盖范围有限，分类也相对较少。可自行在 GitHub 上查找由社区维护的 geosite 和 geoip 文件，其中通常对“白名单模式”和“黑名单模式”的配置方式也有较为详细的说明。
