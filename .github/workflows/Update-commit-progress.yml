name: 更新提交进度

# 自动触发与手动触发
on:
  push:
    branches:
      - main
  workflow_dispatch:   # 手动触发

jobs:
  更新进度:
    runs-on: ubuntu-latest
    steps:
      - name: 检出仓库
        uses: actions/checkout@v5
        with:
          fetch-depth: 0   # 获取完整 commit 历史

      - name: 更新提交进度并推送
        run: |
          README="README.md"
          MARKER_START="<!-- commit-progress-start -->"
          MARKER_END="<!-- commit-progress-end -->"
          PER=3533   # 每个版本 commit 数

          # 获取总提交数
          commits=$(git rev-list --count HEAD)

          # 计算当前版本号和进度
          version=$(( commits / PER ))
          progress_commits=$(( commits % PER ))
          percent=$(awk "BEGIN {printf \"%.1f\", $progress_commits*100/$PER}")
          # 四舍五入到 0.5%
          percent_rounded=$(awk "BEGIN {printf \"%.1f\", ($progress_commits*100/$PER+0.25)/0.5*0.5}")
          to_next=$(( PER - progress_commits ))

          # 根据百分比动态选择颜色
          if (( $(echo "$percent_rounded < 30" | bc -l) )); then
            color="red"
          elif (( $(echo "$percent_rounded < 70" | bc -l) )); then
            color="yellow"
          else
            color="brightgreen"
          fi

          # shields.io 徽章 URL
          badge_url="https://img.shields.io/badge/进度-${percent_rounded}%25-${color}?style=for-the-badge"

          # 构造替换内容
          replacement="${MARKER_START}
\*\*版本:\*\* v${version}  （草稿提交数: ${progress_commits}）  
![第三版进度徽章](${badge_url})  
距离下一版还需提交: ${to_next} 次
${MARKER_END}"

          # 替换 README 中标记内容
          awk -v start="$MARKER_START" -v end="$MARKER_END" -v repl="$replacement" '
            BEGIN {inside=0}
            {
              if(index($0,start)==1){ print repl; inside=1; next }
              if(inside==1 && index($0,end)==1){ inside=0; next }
              if(inside==0) print $0
            }
          ' "$README" > "${README}.tmp"

          # 检查是否有变化
          if cmp -s "$README" "${README}.tmp"; then
            echo "无变化（进度 <0.5%），无需提交。"
            rm "${README}.tmp"
            exit 0
          fi

          mv "${README}.tmp" "$README"
          echo "README 已更新：版本 ${version}，进度 ${percent_rounded}%"

          # 自动提交并推送
          if [ -n "$(git status --porcelain)" ]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add "$README"
            git commit -m "CI: 更新提交进度徽章"
            git push
          fi
