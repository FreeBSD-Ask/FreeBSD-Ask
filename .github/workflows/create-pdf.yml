name: ğŸ”— PDF ç”Ÿæˆ

on:
  schedule:
    - cron: '0 0 */5 * *'  # æ¯5å¤©è‡ªåŠ¨è¿è¡Œ
  workflow_dispatch:        # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  release:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # ================= åŸºç¡€ç¯å¢ƒé…ç½® =================
      - name: æ£€å‡ºå­—ä½“ä»“åº“
        uses: actions/checkout@v4
        with:
          repository: ykla/ttf-mswin11-zh-deb
          path: .fonts-repo

      - name: å®‰è£…ä¸­æ–‡å­—ä½“
        run: |
          cd .fonts-repo
          sudo apt-get install -y xfonts-utils
          sudo dpkg -i --force-all ttf-ms-win11-*.deb
          fc-cache -fv  # åˆ·æ–°å­—ä½“ç¼“å­˜

      # ================= ä»£ç ä»“åº“å‡†å¤‡ =================
      - name: æ£€å‡ºä¸»ä»“åº“
        uses: actions/checkout@v4
        with:
          path: main-repo
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: æ£€å‡ºPDFç”Ÿæˆå™¨
        uses: actions/checkout@v4
        with:
          repository: FreeBSD-Ask/gitbook-pdf-export
          path: pdf-toolkit

      # ================= æ ‡ç­¾ç®¡ç†ç³»ç»Ÿ =================
      - name: åˆå§‹åŒ–æ ‡ç­¾
        working-directory: main-repo
        run: |
          if ! git describe --tags --abbrev=0 &>/dev/null; then
            git config --global user.name "Auto Publisher"
            git config --global user.email "auto@example.com"
            git tag -a v0.0.0 -m "åˆå§‹ç‰ˆæœ¬"
            git push origin v0.0.0
          fi

      - name: è®¾ç½®å‘å¸ƒæ—¥æœŸ
        id: date_tag
        run: |
          RELEASE_DATE=$(date -u +"%Y.%m.%d")
          echo "RELEASE_TAG=release/$RELEASE_DATE" >> $GITHUB_ENV

      - name: è·å–å†å²æ ‡ç­¾
        working-directory: main-repo
        run: |
          git fetch --tags --force
          PREV_TAG=$(git describe --tags --abbrev=0)
          echo "PREV_TAG=$PREV_TAG" >> $GITHUB_ENV

      # ================= æ–‡æ¡£ç”Ÿæˆé˜¶æ®µ =================
      - name: é…ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: å®‰è£…ä¾èµ–é¡¹
        run: |
          sudo apt-get install -y \
            libpango-1.0-0 \
            libharfbuzz-dev \
            libcairo2-dev
          pip install weasyprint==60.2 \
                    mistune==3.1.0 \
                    pygments==2.18.0

      - name: ç”ŸæˆPDFæ–‡æ¡£
        run: |
          cd pdf-toolkit
          python mdconv.py ../main-repo
        env:
          PYTHONPATH: ${{ github.workspace }}/pdf-toolkit

      # ================= å˜æ›´æ—¥å¿—ç”Ÿæˆ =================
      - name: ç”Ÿæˆæ™ºèƒ½å˜æ›´æ—¥å¿—
        uses: janheinrichmerker/action-github-changelog-generator@v2.4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          futureRelease: ${{ env.RELEASE_TAG }}
          sinceTag: ${{ env.PREV_TAG }}
          excludeTags: "draft,test,temp"
          excludeTagsRegex: ".*-beta|.*-rc[0-9]+"
          dueTag: ${{ env.RELEASE_TAG }}
          user: FreeBSD-Ask
          repo: FreeBSD-Ask
          output: CHANGELOG.md
          configureSections: |
            breaking=âš ï¸ é‡å¤§å˜æ›´
            feat=âœ¨ æ–°åŠŸèƒ½
            fix=ğŸ› é—®é¢˜ä¿®å¤
            perf=âš¡ï¸ æ€§èƒ½ä¼˜åŒ–
            docs=ğŸ“š æ–‡æ¡£æ›´æ–°
          breakingLabels: "breaking-change"
          enhancementLabels: "feat"
          bugLabels: "fix"
          compareLink: true
          verbose: true

      # ================= å‘å¸ƒæµç¨‹ =================
      - name: åˆ›å»ºç‰ˆæœ¬æ ‡ç­¾
        working-directory: main-repo
        run: |
          git config --global user.name "Release Bot"
          git config --global user.email "release@example.com"
          git tag -a ${{ env.RELEASE_TAG }} -m "ç‰ˆæœ¬æ›´æ–° ${{ env.RELEASE_TAG }}"
          git push origin ${{ env.RELEASE_TAG }}

      - name: å‘å¸ƒç‰ˆæœ¬
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: "Release ${{ env.RELEASE_TAG }}"
          body_path: CHANGELOG.md
          files: |
            pdf-toolkit/build/final.pdf
          draft: false
          prerelease: ${{ contains(env.RELEASE_TAG, '-beta') }}

      - name: æ¸…ç†æ—§ç‰ˆæœ¬
        if: ${{ !contains(env.RELEASE_TAG, '-beta') }}
        uses: dev-drprasad/delete-older-releases@v1
        with:
          keep_latest: 5
          repo: FreeBSD-Ask/FreeBSD-Ask
          delete_tag_pattern: "release/*"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
