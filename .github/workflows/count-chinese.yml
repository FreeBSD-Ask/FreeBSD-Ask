name: ğŸ“Š æ›´æ–°æ–‡æ¡£å­—æ•°ç»Ÿè®¡

on:
  schedule:
    - cron: '20 5 * * 0'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-doc-stats:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ssh-key: ${{ secrets.DEPLOY_KEY }}

      - uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      - name: ç»Ÿè®¡å­—æ•°å¹¶æ›´æ–° README
        run: |
          python << 'EOF'
          import re
          import subprocess
          from pathlib import Path
          from datetime import datetime, timezone, timedelta

          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # ç»Ÿè®¡è§„åˆ™
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

          COUNT_PATTERN = re.compile(
              r'[\u4e00-\u9fff'
              r'\u3400-\u4dbf'
              r'\U00020000-\U0002a6df'
              r'ï¼Œã€‚ï¼ï¼Ÿï¼›ï¼šã€â€œâ€â€˜â€™ï¼ˆï¼‰ã€Šã€‹ã€ã€‘â€”â€¦Â·'
              r'A-Za-z0-9]'
          )

          CODE_BLOCK_PATTERN = re.compile(
              r'```[\s\S]*?```',
              re.MULTILINE
          )

          COMMIT_TOTAL_PATTERN = re.compile(
              r'^CI: æ›´æ–°æ–‡æ¡£å­—æ•°ç»Ÿè®¡.*total=(\d+)$'
          )

          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # å·¥å…·å‡½æ•°
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

          def count_publish_chars(text: str) -> int:
              text = CODE_BLOCK_PATTERN.sub('', text)
              return len(COUNT_PATTERN.findall(text))

          def format_total(count: int) -> str:
              if count < 10_000:
                  return f"{count} å­—"
              wan = count / 10_000
              if wan.is_integer():
                  return f"{int(wan)} ä¸‡å­—"
              return f"{wan:.2f} ä¸‡å­—"

          def diff_info(current, past):
              if past is None or past == 0:
                  return "æ•°æ®æš‚ç¼º"
              delta = current - past
              percent = delta / past * 100
              sign = "+" if delta >= 0 else "âˆ’"
              return f"{sign}{format_total(abs(delta))}ï¼ˆ{sign}{abs(percent):.2f}%ï¼‰"

          def get_ci_totals():
              log = subprocess.check_output(
                  ["git", "log", "--pretty=%ct %s"],
                  text=True
              )
              results = []
              for line in log.splitlines():
                  try:
                      ts_str, subject = line.split(" ", 1)
                      ts = int(ts_str)
                  except ValueError:
                      continue
                  m = COMMIT_TOTAL_PATTERN.search(subject)
                  if m:
                      results.append((ts, int(m.group(1))))
              return results

          def find_total_before(ci_totals, seconds_ago):
              now_ts = int(datetime.now(timezone.utc).timestamp())
              target = now_ts - seconds_ago
              for ts, total in ci_totals:
                  if ts <= target:
                      return total
              return None

          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # ä¸»é€»è¾‘
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

          total = 0
          for md in Path(".").rglob("*.md"):
              if md.name == "README.md":
                  continue
              try:
                  total += count_publish_chars(
                      md.read_text(encoding="utf-8")
                  )
              except Exception:
                  pass

          ci_totals = get_ci_totals()
          last_total = ci_totals[0][1] if ci_totals else None

          week_total = find_total_before(ci_totals, 7 * 86400)
          month_total = find_total_before(ci_totals, 30 * 86400)

          if last_total == total:
              Path("/tmp/skip_commit").write_text("1")
          else:
              Path("/tmp/skip_commit").write_text("0")

          now = datetime.now(
              timezone(timedelta(hours=8))
          ).strftime("%Y-%m-%d %H:%M:%S")

          block = (
              "<!-- CHINESE_CHAR_COUNT_START -->\n"
              f"æ–‡æ¡£æ€»å­—æ•°ï¼š{format_total(total)}ï¼›\n\n"
              f"ç»Ÿè®¡æ—¶é—´ï¼š{now}ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰\n\n"
              f"ä¸ä¸Šå‘¨ç›¸æ¯”ï¼š{diff_info(total, week_total)}\n\n"
              f"ä¸ä¸Šæœˆç›¸æ¯”ï¼š{diff_info(total, month_total)}\n\n"
              "<!-- CHINESE_CHAR_COUNT_END -->"
          )

          readme = Path("README.md")
          content = readme.read_text(encoding="utf-8")
          content = re.sub(
              r"<!-- CHINESE_CHAR_COUNT_START -->[\s\S]*?<!-- CHINESE_CHAR_COUNT_END -->",
              block,
              content,
              flags=re.DOTALL
          )
          readme.write_text(content, encoding="utf-8")

          Path("/tmp/total.txt").write_text(str(total))
          EOF

      - name: Commit and push changes
        run: |
          if [ "$(cat /tmp/skip_commit)" = "1" ]; then
            echo "ğŸ“ å­—æ•°æœªå˜åŒ–ï¼Œè·³è¿‡æäº¤"
            exit 0
          fi

          TOTAL=$(cat /tmp/total.txt)
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          git commit -m "CI: æ›´æ–°æ–‡æ¡£å­—æ•°ç»Ÿè®¡ | total=${TOTAL}"
          git push