name: ğŸ“Š æ›´æ–°æ–‡æ¡£å­—æ•°ç»Ÿè®¡

on:
  schedule:
    - cron: '0 1 * * *'  # æ¯å¤©UTC 0ç‚¹è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´8ç‚¹ï¼‰
  workflow_dispatch:

jobs:
  update-chinese-count:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ssh-key: ${{ secrets.DEPLOY_KEY }}
          fetch-depth: 0
          
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.14'
          
      - name: ç»Ÿè®¡ä¸­æ–‡å­—æ•°å¹¶æ›´æ–°README
        run: |
          # ç›´æ¥å†…è” Python è„šæœ¬
          python3 << 'EOF'
          import os
          import re
          from pathlib import Path
          from datetime import datetime
          
          def count_chinese_outside_code_blocks(text):
              # ç§»é™¤ä»£ç å—
              text = re.sub(r'```[\s\S]*?```', '', text)
              # ç»Ÿè®¡ä¸­æ–‡æ±‰å­—
              chinese_chars = re.findall(r'[\u4e00-\u9fff\u3400-\u4dbf\U00020000-\U0002a6df]', text)
              return len(chinese_chars)
          
          def format_count(count):
              if count < 10000:
                  return f"{count}å­—"
              else:
                  wan = count / 10000
                  if abs(wan - int(wan)) < 0.001:
                      return f"{int(wan)}ä¸‡å­—"
                  else:
                      return f"{wan:.2f}ä¸‡å­—"
          
          def update_readme():
              readme_path = Path("README.md")
              if not readme_path.exists():
                  print("âŒ README.md ä¸å­˜åœ¨")
                  return False
              
              # ç»Ÿè®¡æ‰€æœ‰ .md æ–‡ä»¶
              total_count = 0
              for md_file in Path('.').rglob('*.md'):
                  if md_file.name == 'README.md':
                      continue
                  try:
                      with open(md_file, 'r', encoding='utf-8') as f:
                          total_count += count_chinese_outside_code_blocks(f.read())
                  except:
                      continue
              
              formatted = format_count(total_count)
              current_time = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
              
              # æ„å»ºæ–°çš„ç»Ÿè®¡åŒºå—
              new_block = f"""<!-- CHINESE_CHAR_COUNT_START -->
æ–‡æ¡£æ€»å­—æ•°: {formatted} (ç»Ÿè®¡æ—¶é—´: {current_time})
<!-- CHINESE_CHAR_COUNT_END -->"""
              
              # è¯»å–å¹¶æ›´æ–° README
              with open(readme_path, 'r', encoding='utf-8') as f:
                  content = f.read()
              
              start_marker = "<!-- CHINESE_CHAR_COUNT_START -->"
              end_marker = "<!-- CHINESE_CHAR_COUNT_END -->"
              
              if start_marker in content and end_marker in content:
                  pattern = re.compile(f"{re.escape(start_marker)}.*?{re.escape(end_marker)}", re.DOTALL)
                  new_content = pattern.sub(new_block, content)
              else:
                  new_content = content.rstrip() + "\\n\\n" + new_block + "\\n"
              
              with open(readme_path, 'w', encoding='utf-8') as f:
                  f.write(new_content)
              
              print(f"âœ… ç»Ÿè®¡å®Œæˆ: {total_count} æ±‰å­— -> {formatted}")
              return True
          
          update_readme()
          EOF
          
      - name: æäº¤å¹¶æ¨é€æ›´æ”¹
        run: |
          if [ -n "$(git status --porcelain "README.md")" ]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add "README.md"
            git commit -m "CI: æ›´æ–°æ–‡æ¡£å­—æ•°ç»Ÿè®¡ [$(date +%Y-%m-%d)]"
            git push origin main
            echo "âœ… å·²æäº¤å¹¶æ¨é€æ›´æ”¹"
          else
            echo "ğŸ“ æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
          fi