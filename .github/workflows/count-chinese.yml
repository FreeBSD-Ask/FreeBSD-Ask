name: ğŸ“Š æ›´æ–°æ–‡æ¡£å­—æ•°ç»Ÿè®¡

on:
  schedule:
    - cron: '0 1 * * *'   # æ¯å¤© UTC 1 ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´ 9 ç‚¹ï¼‰
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-chinese-count:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          ssh-key: ${{ secrets.DEPLOY_KEY }}
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      - name: ç»Ÿè®¡å­—æ•°å¹¶æ›´æ–° README
        run: |
          python << 'EOF'
          import re
          from pathlib import Path
          from datetime import datetime, timezone, timedelta

          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # å‡ºç‰ˆç‰©å¸¸ç”¨å­—æ•°ç»Ÿè®¡å£å¾„ï¼š
          #   âœ” æ±‰å­—
          #   âœ” ä¸­æ–‡å…¨è§’æ ‡ç‚¹
          #   âœ” è‹±æ–‡å­—æ¯ï¼ˆé€å­—ç¬¦ï¼‰
          #   âœ” æ•°å­—
          #   âœ˜ ç©ºæ ¼ / æ¢è¡Œ / åˆ¶è¡¨ç¬¦
          #   âœ˜ Markdown ä»£ç å—
          #
          # ä¸‡å­—æŠ˜ç®—è§„åˆ™ï¼ˆä¿æŒä¸å˜ï¼‰ï¼š
          #   < 10000  â†’ xxx å­—
          #   â‰¥ 10000  â†’ x.xx ä¸‡å­— / x ä¸‡å­—
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

          COUNT_PATTERN = re.compile(
              r'[\u4e00-\u9fff'          # æ±‰å­—
              r'\u3400-\u4dbf'
              r'\U00020000-\U0002a6df'
              r'ï¼Œã€‚ï¼ï¼Ÿï¼›ï¼šã€â€œâ€â€˜â€™ï¼ˆï¼‰ã€Šã€‹ã€ã€‘â€”â€¦Â·'  # ä¸­æ–‡æ ‡ç‚¹
              r'A-Za-z0-9]'              # è‹±æ–‡ä¸æ•°å­—
          )

          CODE_BLOCK_PATTERN = re.compile(
              r'```[\s\S]*?```',
              re.MULTILINE
          )

          def count_publish_chars(text: str) -> int:
              text = CODE_BLOCK_PATTERN.sub('', text)
              return len(COUNT_PATTERN.findall(text))

          def format_count(count: int) -> str:
              if count < 10_000:
                  return f"{count} å­—"
              wan = count / 10_000
              return f"{int(wan)} ä¸‡å­—" if wan.is_integer() else f"{wan:.2f} ä¸‡å­—"

          def update_readme() -> None:
              readme = Path("README.md")
              if not readme.exists():
                  print("âŒ README.md ä¸å­˜åœ¨")
                  return

              total = 0
              for md in Path(".").rglob("*.md"):
                  if md.name == "README.md":
                      continue
                  try:
                      total += count_publish_chars(
                          md.read_text(encoding="utf-8")
                      )
                  except Exception:
                      pass

              formatted = format_count(total)

              # UTC+8ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
              now = datetime.now(
                  timezone(timedelta(hours=8))
              ).strftime("%Y-%m-%d %H:%M:%S")

              block = (
                  "<!-- CHINESE_CHAR_COUNT_START -->\n"
                  f"æ–‡æ¡£æ€»å­—æ•°ï¼š{formatted}ï¼ˆç»Ÿè®¡æ—¶é—´ï¼š{now}ï¼ŒUTC+8ï¼‰\n"
                  "<!-- CHINESE_CHAR_COUNT_END -->"
              )

              content = readme.read_text(encoding="utf-8")
              start = "<!-- CHINESE_CHAR_COUNT_START -->"
              end = "<!-- CHINESE_CHAR_COUNT_END -->"

              if start in content and end in content:
                  content = re.sub(
                      f"{re.escape(start)}.*?{re.escape(end)}",
                      block,
                      content,
                      flags=re.DOTALL
                  )
              else:
                  content = content.rstrip() + "\n\n" + block + "\n"

              readme.write_text(content, encoding="utf-8")
              print(f"âœ… ç»Ÿè®¡å®Œæˆï¼š{total} å­— â†’ {formatted}")

          update_readme()
          EOF

      - name: Commit and push changes
        run: |
          if ! git diff --quiet README.md; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add README.md
            git commit -m "CI: æ›´æ–°æ–‡æ¡£å­—æ•°ç»Ÿè®¡ [$(date +%Y-%m-%d)]"
            git push
            echo "âœ… å·²æäº¤å¹¶æ¨é€æ›´æ”¹"
          else
            echo "ğŸ“ æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
          fi