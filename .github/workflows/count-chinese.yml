name: ğŸ“Š æ›´æ–°æ–‡æ¡£å­—æ•°ç»Ÿè®¡

on:
  schedule:
    - cron: '0 1 * * *'  # æ¯å¤©
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-chinese-count:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          ssh-key: ${{ secrets.DEPLOY_KEY }}
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      - name: ç»Ÿè®¡ä¸­æ–‡å­—æ•°å¹¶æ›´æ–° README
        run: |
          python << 'EOF'
          import re
          from pathlib import Path
          from datetime import datetime

          def count_chinese_outside_code_blocks(text):
              # ç§»é™¤ Markdown ä»£ç å—
              text = re.sub(r'```[\s\S]*?```', '', text)
              # ç»Ÿè®¡ä¸­æ–‡æ±‰å­—
              chars = re.findall(
                  r'[\u4e00-\u9fff\u3400-\u4dbf\U00020000-\U0002a6df]',
                  text
              )
              return len(chars)

          def format_count(count):
              if count < 10_000:
                  return f"{count}å­—"
              wan = count / 10_000
              return f"{int(wan)}ä¸‡å­—" if wan.is_integer() else f"{wan:.2f}ä¸‡å­—"

          def update_readme():
              readme = Path("README.md")
              if not readme.exists():
                  print("âŒ README.md ä¸å­˜åœ¨")
                  return False

              total = 0
              for md in Path(".").rglob("*.md"):
                  if md.name == "README.md":
                      continue
                  try:
                      total += count_chinese_outside_code_blocks(
                          md.read_text(encoding="utf-8")
                      )
                  except Exception:
                      pass

              formatted = format_count(total)
              now = datetime.now().strftime("%Y-%m-%d %H:%M:%S")

              block = (
                  "<!-- CHINESE_CHAR_COUNT_START -->\n"
                  f"æ–‡æ¡£æ€»å­—æ•°: {formatted} (ç»Ÿè®¡æ—¶é—´: {now})\n"
                  "<!-- CHINESE_CHAR_COUNT_END -->"
              )

              content = readme.read_text(encoding="utf-8")
              start = "<!-- CHINESE_CHAR_COUNT_START -->"
              end = "<!-- CHINESE_CHAR_COUNT_END -->"

              if start in content and end in content:
                  content = re.sub(
                      f"{re.escape(start)}.*?{re.escape(end)}",
                      block,
                      content,
                      flags=re.DOTALL
                  )
              else:
                  content = content.rstrip() + "\n\n" + block + "\n"

              readme.write_text(content, encoding="utf-8")
              print(f"âœ… ç»Ÿè®¡å®Œæˆ: {total} æ±‰å­— â†’ {formatted}")
              return True

          update_readme()
          EOF

      - name: æäº¤å¹¶æ¨é€æ›´æ”¹
        run: |
          if ! git diff --quiet README.md; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add README.md
            git commit -m "CI: æ›´æ–°æ–‡æ¡£å­—æ•°ç»Ÿè®¡ [$(date +%Y-%m-%d)]"
            git push
            echo "âœ… å·²æäº¤å¹¶æ¨é€æ›´æ”¹"
          else
            echo "ğŸ“ æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
          fi