name: ğŸ“Š æ›´æ–°æ–‡æ¡£å­—æ•°ç»Ÿè®¡

on:
  schedule:
    - cron: '0 1 * * *'   # æ¯å¤© UTC 1 ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´ 9 ç‚¹ï¼‰
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-doc-stats:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          ssh-key: ${{ secrets.DEPLOY_KEY }}
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      - name: ç»Ÿè®¡å­—æ•°å¹¶æ›´æ–° README
        run: |
          python << 'EOF'
          import re
          import subprocess
          from pathlib import Path
          from datetime import datetime, timezone, timedelta

          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # ç»Ÿè®¡è§„åˆ™ï¼ˆæ™®é€šå‡ºç‰ˆç‰©å£å¾„ï¼‰
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

          COUNT_PATTERN = re.compile(
              r'[\u4e00-\u9fff'
              r'\u3400-\u4dbf'
              r'\U00020000-\U0002a6df'
              r'ï¼Œã€‚ï¼ï¼Ÿï¼›ï¼šã€â€œâ€â€˜â€™ï¼ˆï¼‰ã€Šã€‹ã€ã€‘â€”â€¦Â·'
              r'A-Za-z0-9]'
          )

          CODE_BLOCK_PATTERN = re.compile(
              r'```[\s\S]*?```',
              re.MULTILINE
          )

          # ä»…åŒ¹é… CI ç»Ÿè®¡æäº¤çš„ commit subject
          COMMIT_TOTAL_PATTERN = re.compile(
              r'^CI: æ›´æ–°æ–‡æ¡£å­—æ•°ç»Ÿè®¡.*total=(\d+)$'
          )

          def count_publish_chars(text: str) -> int:
              text = CODE_BLOCK_PATTERN.sub('', text)
              return len(COUNT_PATTERN.findall(text))

          def format_count(count: int) -> str:
              if count < 10_000:
                  return f"{count} å­—"
              wan = count / 10_000
              return f"{int(wan)} ä¸‡å­—" if wan.is_integer() else f"{wan:.2f} ä¸‡å­—"

          def get_historical_total(days_ago: int):
              since = f"--since={days_ago} days ago"
              try:
                  log = subprocess.check_output(
                      ["git", "log", since, "--pretty=%s"],
                      text=True
                  )
              except subprocess.CalledProcessError:
                  return None

              for line in log.splitlines():
                  m = COMMIT_TOTAL_PATTERN.search(line)
                  if m:
                      return int(m.group(1))
              return None

          def get_last_committed_total():
              try:
                  log = subprocess.check_output(
                      ["git", "log", "-1", "--pretty=%s"],
                      text=True
                  )
              except subprocess.CalledProcessError:
                  return None

              m = COMMIT_TOTAL_PATTERN.search(log.strip())
              if m:
                  return int(m.group(1))
              return None

          def diff_info(current, past):
              if past is None or past == 0:
                  return "æš‚æ— å¯å¯¹æ¯”æ•°æ®"
              delta = current - past
              percent = (delta / past) * 100
              sign = "+" if delta >= 0 else "âˆ’"
              return f"{sign}{abs(delta)} å­—ï¼ˆ{sign}{abs(percent):.2f}%ï¼‰"

          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # ä¸»é€»è¾‘
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

          readme = Path("README.md")
          if not readme.exists():
              print("âŒ README.md ä¸å­˜åœ¨")
              raise SystemExit(1)

          total = 0
          for md in Path(".").rglob("*.md"):
              if md.name == "README.md":
                  continue
              try:
                  total += count_publish_chars(
                      md.read_text(encoding="utf-8")
                  )
              except (UnicodeDecodeError, OSError) as e:
                  print(f"Skipping {md} due to read error: {e}")

          last_total = get_last_committed_total()
          week_total = get_historical_total(7)
          month_total = get_historical_total(30)

          week_diff = diff_info(total, week_total)
          month_diff = diff_info(total, month_total)

          now = datetime.now(
              timezone(timedelta(hours=8))
          ).strftime("%Y-%m-%d %H:%M:%S")

          block = (
              "<!-- CHINESE_CHAR_COUNT_START -->\n"
              f"æ–‡æ¡£æ€»å­—æ•°ï¼š{format_count(total)}\n"
              f"ç»Ÿè®¡æ—¶é—´ï¼š{now}ï¼ˆUTC+8ï¼ŒåŒ—äº¬æ—¶é—´ï¼‰\n\n"
              f"ä¸ä¸Šå‘¨ç›¸æ¯”ï¼š{week_diff}\n"
              f"ä¸ä¸Šæœˆç›¸æ¯”ï¼š{month_diff}\n"
              "<!-- CHINESE_CHAR_COUNT_END -->"
          )

          content = readme.read_text(encoding="utf-8")
          start = "<!-- CHINESE_CHAR_COUNT_START -->"
          end = "<!-- CHINESE_CHAR_COUNT_END -->"

          if start in content and end in content:
              content = re.sub(
                  f"{re.escape(start)}.*?{re.escape(end)}",
                  block,
                  content,
                  flags=re.DOTALL
              )
          else:
              content = content.rstrip() + "\n\n" + block + "\n"

          readme.write_text(content, encoding="utf-8")

          Path("/tmp/total.txt").write_text(str(total))

          if last_total == total:
              Path("/tmp/skip_commit").write_text("1")
              print("ğŸ“ å­—æ•°ä¸ä¸Šæ¬¡ç»Ÿè®¡ä¸€è‡´ï¼Œè·³è¿‡æäº¤")
          else:
              Path("/tmp/skip_commit").write_text("0")
              print(f"âœ… å­—æ•°å˜åŒ–ï¼š{last_total} â†’ {total}")

          EOF

      - name: Commit and push changes
        run: |
          SKIP=$(cat /tmp/skip_commit)

          if [ "$SKIP" = "1" ]; then
            echo "ğŸ“ å­—æ•°æœªå˜åŒ–ï¼Œä¸æäº¤"
            exit 0
          fi

          TOTAL=$(cat /tmp/total.txt)

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          git commit -m "CI: æ›´æ–°æ–‡æ¡£å­—æ•°ç»Ÿè®¡ | total=${TOTAL}"
          git push

          echo "âœ… å·²æäº¤å¹¶æ¨é€æ›´æ”¹"