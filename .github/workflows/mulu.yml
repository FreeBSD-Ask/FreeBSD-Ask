name: ðŸ”— ä»Ž SUMMARY.md æ›´æ–°ç›®å½•

on:
  push:
    paths:
      - 'SUMMARY.md'
  workflow_dispatch:

jobs:
  update-mu-lu:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository with Deploy Key
        uses: actions/checkout@v6
        with:
          ssh-key: ${{ secrets.DEPLOY_KEY }}
          fetch-depth: 0

      - name: Copy and modify SUMMARY.md to mu-lu.md
        run: |
          # åˆ é™¤æ—§æ–‡ä»¶
          if [ -f mu-lu.md ]; then
            rm mu-lu.md
          fi
          # å¤åˆ¶ SUMMARY.md
          cp SUMMARY.md mu-lu.md
          # æ›¿æ¢ç¬¬ä¸€è¡Œ
          sed -i '1s/^# Table of contents$/# ç›®å½•/' mu-lu.md
          echo "mu-lu.md updated with first line replaced"

      - name: Check if mu-lu.md changed (excluding first line)
        id: check_diff
        run: |
          # åŽ»æŽ‰ç¬¬ä¸€è¡Œå¹¶ç»Ÿä¸€æ¢è¡Œç¬¦ï¼Œé¿å… diff è¯¯åˆ¤
          tail -n +2 SUMMARY.md | sed 's/\r$//' > /tmp/summary_tail.txt
          tail -n +2 mu-lu.md   | sed 's/\r$//' > /tmp/mulu_tail.txt
          # è¾“å‡º diff ç»“æžœæ–¹ä¾¿è°ƒè¯•
          diff /tmp/summary_tail.txt /tmp/mulu_tail.txt || true
          # åˆ¤æ–­æ˜¯å¦æœ‰å˜åŒ–
          if ! diff -q /tmp/summary_tail.txt /tmp/mulu_tail.txt >/dev/null; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push changes
        if: steps.check_diff.outputs.changed == 'true'
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          commit_message: "ä»Ž SUMMARY.md æ›´æ–° mu-lu.md [skip ci]"
          file_pattern: "mu-lu.md"
