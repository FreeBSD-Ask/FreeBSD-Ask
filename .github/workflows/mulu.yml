name: 🔗 从 SUMMARY.md 更新目录

on:
  push:
    paths:
      - 'SUMMARY.md'
  workflow_dispatch:

jobs:
  update-mu-lu:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository with Deploy Key
        uses: actions/checkout@v5
        with:
          ssh-key: ${{ secrets.DEPLOY_KEY }}
          fetch-depth: 0

      - name: Copy and modify SUMMARY.md to mu-lu.md
        run: |
          # 删除旧文件
          if [ -f mu-lu.md ]; then
            rm mu-lu.md
          fi
          # 复制 SUMMARY.md
          cp SUMMARY.md mu-lu.md
          # 替换第一行
          sed -i '1s/^# Table of contents$/# 目录/' mu-lu.md
          echo "mu-lu.md updated with first line replaced"

      - name: Check if mu-lu.md changed (excluding first line)
        id: check_diff
        run: |
          # 生成临时文件去掉第一行
          tail -n +2 SUMMARY.md > /tmp/summary_tail.txt
          tail -n +2 mu-lu.md > /tmp/mulu_tail.txt
          # 比较内容
          if ! diff -q /tmp/summary_tail.txt /tmp/mulu_tail.txt >/dev/null; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push changes
        if: steps.check_diff.outputs.changed == 'true'
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          commit_message: "从 SUMMARY.md 更新 mu-lu.md [skip ci]"
          file_pattern: "mu-lu.md"
