name: ðŸ”— ä»Ž SUMMARY.md æ›´æ–°ç›®å½•

on:
  push:
    paths:
      - 'SUMMARY.md'
  workflow_dispatch:

jobs:
  update-mu-lu:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          ssh-key: ${{ secrets.DEPLOY_KEY }}
          fetch-depth: 0

      - name: Process mu-lu.md
        id: process
        run: |
          set -e

          # å¦‚æžœ mu-lu.md ä¸å­˜åœ¨ï¼Œç›´æŽ¥ç”Ÿæˆ
          if [ ! -f mu-lu.md ]; then
            cp SUMMARY.md mu-lu.md
            sed -i '1s/^# Table of contents$/# ç›®å½•/' mu-lu.md
            echo "mu-lu.md created from SUMMARY.md"
            echo "changed=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # mu-lu.md å­˜åœ¨æ—¶ï¼Œå…ˆç”Ÿæˆ mu-lu-2.md
          cp mu-lu.md mu-lu-2.md
          sed -i '1s/^# ç›®å½•$/# Table of contents/' mu-lu-2.md

          # åŽ»æŽ‰ç¬¬ä¸€è¡Œæ¯”è¾ƒå†…å®¹
          tail -n +2 SUMMARY.md > /tmp/summary_tail.txt
          tail -n +2 mu-lu-2.md > /tmp/mulu2_tail.txt

          if diff -q /tmp/summary_tail.txt /tmp/mulu2_tail.txt >/dev/null; then
            echo "No changes detected, mu-lu.md is up-to-date."
            rm mu-lu-2.md
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "Changes detected, updating mu-lu.md..."
            rm mu-lu.md mu-lu-2.md
            cp SUMMARY.md mu-lu.md
            sed -i '1s/^# Table of contents$/# ç›®å½•/' mu-lu.md
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push changes
        if: steps.process.outputs.changed == 'true'
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          commit_message: "ä»Ž SUMMARY.md æ›´æ–° mu-lu.md [skip ci]"
          file_pattern: "mu-lu.md"
