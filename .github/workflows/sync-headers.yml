name: ğŸ”— ä» SUMMARY.md æ›´æ–°ä¸€çº§æ ‡é¢˜

on:
  push:
  workflow_run:
    workflows: [ğŸ”— ä» SUMMARY.md æ›´æ–°ç›®å½•]   # è¿™é‡Œè¦å†™ mulu.yml ä¸­å®šä¹‰çš„ workflow åå­—ï¼Œè€Œä¸æ˜¯æ–‡ä»¶å
    types:
      - completed
  workflow_dispatch:

jobs:
  verify-and-sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Sync headers
        id: sync
        run: |
          # è®¾ç½®ä¿®æ”¹æ ‡å¿—
          CHANGED="false"

          # ä½¿ç”¨è¿›ç¨‹æ›¿æ¢ï¼Œé¿å…ç®¡é“å¯¼è‡´å­ Shell ä¸­ä¿®æ”¹å˜é‡
          while IFS= read -r line; do
            # æå–æ ‡é¢˜å’Œæ–‡ä»¶è·¯å¾„
            title=$(sed -n 's/.*\[\([^]]*\)\].*/\1/p' <<< "$line")
            path=$(sed -n 's/.*](\([^)]*\)).*/\1/p' <<< "$line")

            # è·³è¿‡æ— æ•ˆæ¡ç›®
            [ -z "$title" ] || [ ! -f "$path" ] && continue

            # è·å–æ–‡ä»¶ç¬¬ä¸€è¡Œå¹¶æ¸…ç†æ ¼å¼
            first_line=$(head -n 1 "$path" | sed 's/^#*//; s/^[[:space:]]*//; s/[[:space:]]*$//')
            clean_title=$(sed 's/^[[:space:]]*//; s/[[:space:]]*$//' <<< "$title")

            # æ¯”è¾ƒæ ‡é¢˜å¹¶æ›´æ–°æ–‡ä»¶
            if [ "$first_line" != "$clean_title" ]; then
              echo "Updating $path: '$first_line' -> '$clean_title'"
              
              # ä½¿ç”¨ä¸´æ—¶æ–‡ä»¶è¿›è¡Œå®‰å…¨æ›¿æ¢
              temp_file=$(mktemp)
              echo "# $clean_title" > "$temp_file"
              tail -n +2 "$path" >> "$temp_file"
              mv -f "$temp_file" "$path"

              git add "$path"
              CHANGED="true"
            fi
          done < <(grep -E '^\* \[' SUMMARY.md)

          # è¾“å‡ºä¿®æ”¹çŠ¶æ€
          echo "changed=$CHANGED" >> $GITHUB_OUTPUT

      - name: Commit changes
        if: steps.sync.outputs.changed == 'true'
        run: |
          git config --global user.name "ykla"
          git config --global user.email "yklaxds@gmail.com"
          git commit -m "chore: sync headers with SUMMARY.md"
          git push
