name: "æ£€æŸ¥ Markdown å›¾ç‰‡å¼•ç”¨"
on:
  push:
    paths:
      - '.gitbook/assets/**'
  workflow_dispatch:

jobs:
  scan-images:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Scan images and create issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs')
            const path = require('path')
            // é‡å‘½å requireï¼Œé¿å…ä¸æ³¨å…¥çš„ glob å†²çª
            const { sync: globSync } = require('glob')

            // è·å–æ‰€æœ‰ Markdown å’Œ assets ä¸­çš„æ–‡ä»¶
            const mdFiles = globSync('**/*.md')
            const assetFiles = globSync('.gitbook/assets/**/*.*')

            const referenced = new Set()
            const imgRegex = /!\[[^\]]*?\]\((\.gitbook\/assets\/[^\)]+)\)/g
            for (const file of mdFiles) {
              const content = fs.readFileSync(file, 'utf8')
              let m
              while ((m = imgRegex.exec(content)) !== null) {
                referenced.add(m[1])
              }
            }

            const missing = [...referenced].filter(p => !fs.existsSync(p))
            const unused  = assetFiles.filter(p => !referenced.has(p.replace(/\\/g,'/')))

            if (missing.length || unused.length) {
              let body = []
              if (missing.length) {
                body.push('### âŒ å¼•ç”¨ä½†ä¸å­˜åœ¨çš„å›¾ç‰‡ï¼š')
                missing.forEach(p => body.push(`- \`${p}\``))
              }
              if (unused.length) {
                body.push('### ğŸ†• æœªè¢«å¼•ç”¨çš„å›¾ç‰‡ï¼š')
                unused.forEach(p => body.push(`- \`${p}\``))
              }
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo:  context.repo.repo,
                title: `ğŸ–¼ï¸ å›¾ç‰‡å¼•ç”¨æ£€æŸ¥ï¼š${missing.length} ç¼ºå¤±ï¼Œ${unused.length} æœªä½¿ç”¨`,
                body:  body.join('\n'),
              })
            } else {
              console.log('All images are consistent.')
            }
