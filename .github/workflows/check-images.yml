name: "检查 Markdown 图片引用"
on:
  push:
    paths:
      - '.gitbook/assets/**'
  workflow_dispatch:


jobs:
  check-images:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Find and check images
        id: image-check
        run: |
          #!/usr/bin/env bash
          set -euo pipefail

          REPO_ROOT="$PWD"
          ASSETS_DIR=".gitbook/assets"
          REPORT_FILE="image-report.md"

          used=$(mktemp)
          exist=$(mktemp)

          # collect used images
          find "$REPO_ROOT" -type f -iname "*.md" | while read md; do
            grep -Po '!\[.*?\]\(\s*\K[^\)\s]+' "$md" \
              | grep -vE '^(https?:)?//' \
              | while read img; do
                  # resolve relative/absolute
                  dir=$(dirname "$md")
                  abs=$(realpath -m "$dir/$img")
                  rel=$(realpath --relative-to="$REPO_ROOT" "$abs" 2>/dev/null || true)
                  [[ -n "$rel" ]] && echo "$rel" >>"$used"
              done
          done

          # only if assets dir exists
          if [ -d "$ASSETS_DIR" ]; then
            find "$ASSETS_DIR" -type f \( -iname "*.png" -o -iname "*.jpg" -o -iname "*.svg" \) \
              | sed "s|^$REPO_ROOT/||" >>"$exist"
          fi

          sort -u "$used" -o "$used"
          sort -u "$exist" -o "$exist"

          miss=$(comm -23 "$used" "$exist")
          unused=$(comm -13 "$used" "$exist")

          {
            echo "# Image Reference Check Report"
            [[ -n "$miss" ]] && {
              echo "## ❌ Missing Images"; printf '%s\n' "$miss" | sed 's/^/- `/' | sed 's/$/`/'
            }
            [[ -n "$unused" ]] && {
              echo "## ⚠️ Unused Images"; printf '%s\n' "$unused" | sed 's/^/- `/' | sed 's/$/`/'
            }
          } > "$REPORT_FILE"

          # emit output flag
          if grep -qE '❌|⚠️' "$REPORT_FILE"; then
            echo "report_exists=1" >> $GITHUB_OUTPUT
          else
            echo "report_exists=0" >> $GITHUB_OUTPUT
          fi

      - name: Create Issue if needed
        if: steps.image-check.outputs.report_exists == '1'
        uses: peter-evans/create-issue-from-file@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "Image Reference Report: Missing or Unused Images"
          content-filepath: image-report.md
          labels: |
            report
            automation

