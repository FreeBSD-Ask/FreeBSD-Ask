# ä½¿ç”¨ GitHub Actions å·¥ä½œæµè¯­æ³•ï¼ˆå¿…é¡»å­˜æ”¾äº .github/workflowsï¼‰&#8203;:contentReference[oaicite:0]{index=0}
name: "æ£€æŸ¥ Markdown å›¾ç‰‡å¼•ç”¨"

on:
  # å½“æ¨é€ .md æˆ– assets ä¸‹æ–‡ä»¶æ—¶è§¦å‘
  push:
    paths:
      - '.gitbook/assets/**'
  workflow_dispatch:
jobs:
  scan-images:
    runs-on: ubuntu-latest

    steps:
      # æ£€å‡ºä»“åº“ä»£ç  :contentReference[oaicite:1]{index=1}
      - name: Checkout repository
        uses: actions/checkout@v4

      # è®¾ç½® Node.js ç¯å¢ƒ
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      # ä¸»è„šæœ¬ï¼šæ‰«æ .md å’Œ .gitbook/assetsï¼Œå¹¶åœ¨å‘ç°é—®é¢˜æ—¶åˆ›å»º Issue :contentReference[oaicite:2]{index=2}
      - name: Scan images and create issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');
            const glob = require('glob');

            // æ‰€æœ‰ Markdown æ–‡ä»¶
            const mdFiles = glob.sync('**/*.md');
            // æ‰€æœ‰ assets ä¸‹çš„å›¾ç‰‡ï¼ˆåŒ…æ‹¬å­ç›®å½•ï¼‰
            const assetFiles = glob.sync('.gitbook/assets/**/*.*', { nodir: true });

            // æå– Markdown ä¸­æ‰€æœ‰è¢«å¼•ç”¨çš„å›¾ç‰‡è·¯å¾„
            const referenced = new Set();
            const imgRegex = /!\[[^\]]*?\]\((\.gitbook\/assets\/[^\)]+)\)/g;
            for (const file of mdFiles) {
              const content = fs.readFileSync(file, 'utf8');
              let m;
              while ((m = imgRegex.exec(content)) !== null) {
                referenced.add(m[1]);
              }
            }

            // è®¡ç®—â€œå¼•ç”¨äº†ä½†ä¸å­˜åœ¨â€çš„å›¾ç‰‡
            const missing = [...referenced].filter(p => !fs.existsSync(p));
            // è®¡ç®—â€œå­˜åœ¨ä½†æœªè¢«å¼•ç”¨â€çš„å›¾ç‰‡ï¼ˆç›¸å¯¹è·¯å¾„ï¼‰
            const unused = assetFiles
              .map(f => f.replace(/\\/g,'/'))
              .filter(p => !referenced.has(p));

            if (missing.length === 0 && unused.length === 0) {
              console.log('All images are consistent.');
              return;
            }

            // æ„é€  Issue æ­£æ–‡
            const lines = [];
            if (missing.length) {
              lines.push('### âŒ å¼•ç”¨ä½†ä¸å­˜åœ¨çš„å›¾ç‰‡ï¼š');
              missing.forEach(p => lines.push(`- \`${p}\``));
            }
            if (unused.length) {
              lines.push('### ğŸ†• æœªè¢«å¼•ç”¨çš„å›¾ç‰‡ï¼š');
              unused.forEach(p => lines.push(`- \`${p}\``));
            }
            const body = lines.join('\n');

            // åˆ›å»º Issue :contentReference[oaicite:3]{index=3}
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ–¼ï¸ å›¾ç‰‡å¼•ç”¨æ£€æŸ¥ï¼šå‘ç° ${missing.length} ä¸ªç¼ºå¤±ï¼Œ${unused.length} ä¸ªæœªä½¿ç”¨`,
              body,
            });
