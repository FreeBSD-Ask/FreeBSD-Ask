# 14.1 设置网络

## 手动设置 `resolv.conf` 文件

手动编辑 `/etc/resolv.conf` 后，重启系统会被重置，因为 DHCP 会重写该文件。

为防止 `resolvconf` 服务覆盖 `resolv.conf`，编辑 `/etc/resolvconf.conf`，写入 `resolvconf=NO`。


### 参考文献

- [resolvconf](https://man.freebsd.org/cgi/man.cgi?query=resolvconf)，man 手册
- [8.8.8.8 or 1.1.1.1 if set in etc resolv conf doesn't stay as an entry in the file after a network restart](https://forums.freebsd.org/threads/8-8-8-8-or-1-1-1-1-if-set-in-etc-resolv-conf-doesnt-stay-as-an-entry-in-the-file-after-a-network-restart.85951/)

## `ifconfig`

先使用 `ifconfig` 查看是否存在网卡；如果没有，则不属于本节的讨论范围。

请注意，`lo0` 并不是真实网卡；如果只能看到该接口，说明网卡未被正确驱动。


示例输出：

```sh
# ifconfig
genet0: flags=8843<UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST> metric 0 mtu 1500
	options=68000b<RXCSUM,TXCSUM,VLAN_MTU,LINKSTATE,RXCSUM_IPV6,TXCSUM_IPV6>
	ether dc:a6:1a:2e:f4:4t
	inet 192.168.123.157 netmask 0xffffff00 broadcast 192.168.123.255
	media: Ethernet autoselect (1000baseT <full-duplex>)
	status: active
	nd6 options=29<PERFORMNUD,IFDISABLED,AUTO_LINKLOCAL>
lo0: flags=8049<UP,LOOPBACK,RUNNING,MULTICAST> metric 0 mtu 16384
	options=680003<RXCSUM,TXCSUM,LINKSTATE,RXCSUM_IPV6,TXCSUM_IPV6>
	inet6 ::1 prefixlen 128
	inet6 fe80::1%lo0 prefixlen 64 scopeid 0x2
	inet 127.0.0.1 netmask 0xff000000
	groups: lo
	nd6 options=21<PERFORMNUD,AUTO_LINKLOCAL>
```

## 配置 DNS 文件


编辑 `/etc/resolv.conf` 文件，清空其中的原有内容，然后添加以下内容：

```ini
nameserver 223.5.5.5   # 指定首选 DNS 服务器为阿里公共 DNS
nameserver 223.6.6.6   # 指定备用 DNS 服务器为阿里公共 DNS 备选
nameserver 8.8.8.8     # 指定备用 DNS 服务器（Google 公共 DNS）
```

重新启动网络服务，应用 `/etc/rc.conf` 中的网络配置：

```sh
# /etc/netstart restart
```

尝试使用 `ping` 命令测试与 163.com 的连通性（按下 Ctrl + C 可中断），示例输出如下：


```sh
# ping 163.com
PING 163.com (123.58.180.7): 56 data bytes
64 bytes from 123.58.180.7: icmp_seq=0 ttl=55 time=30.617 ms
64 bytes from 123.58.180.7: icmp_seq=1 ttl=55 time=30.608 ms
64 bytes from 123.58.180.7: icmp_seq=2 ttl=55 time=30.633 ms
**Ctrl** +C
--- 163.com ping statistics ---
3 packets transmitted, 3 packets received, 0.0% packet loss
round-trip min/avg/max/stddev = 30.608/30.619/30.633/0.010 ms
```

网络已连通。

## 混杂模式

启用混杂模式后，网卡会接收网络中经过该接口的所有数据帧，无论目标 MAC 地址是否为本机。适用于网络抓包、安全审计、虚拟化与容器等场景。

为接口 `xxx` 配置 IPv4 地址和子网掩码，并启用混杂模式：

```ini
ifconfig_xxx="inet x.x.x.x netmask x.x.x.x promisc"
```

### 参考文献

- [ifconfig(8)](https://man.freebsd.org/cgi/man.cgi?ifconfig(8))

## `/etc/rc.conf` 相关


`ifconfig` 命令多为一次性配置，不能永久生效，需写入 `/etc/rc.conf` 文件才能持久化。

```ini
hostname="ykla" # 主机名，不能为空，否则无法使用 Xorg
ifconfig_igc0="DHCP" # 让网卡 igc0 使用 DHCP
ifconfig_igc0="inet 192.168.31.77  netmask 255.255.255.0" # 设置网卡 igc0 的 IPv4 为 192.168.31.77，子网掩码为 255.255.255.0（静态 IP）
defaultrouter="192.168.31.1" # 默认网关/默认路由，在家中一般是路由器 IP
ifconfig_igc0_alias0="inet 192.168.1.33 netmask 255.255.255.0" # 设置网卡 igc0 别名 IPv4 192.168.1.33，子网掩码为 255.255.255.0。即拥有额外的 IPv4 地址
static_routes="static1 static2" # 静态路由，需结合下文使用①
route_static1="-net 10.0.10.0/24 10.0.1.1" # 如果要访问 10.0.10.0/24 这个网络（10.0.10.0 到 10.0.10.254），就将数据包发送给 10.0.1.1，由它来转发
route_static2="-net 172.16.30.0/24 172.16.1.254" # 如果要访问 172.16.30.0/24  这个网络（172.16.30.1 到 172.16.30.254），就将数据包发送给 172.16.1.254，由它来转发
```

① 在 `/etc/rc.conf` 中，如果需要一次性写入多个配置项，只能使用 `ABC_XYZ="xxx yyy ccc ddd"` 这种格式。

如果在 `/etc/rc.conf` 中写成以下形式：

```ini
ABC_XYZ="xxx" # 第一行
ABC_XYZ="yyy"
ABC_XYZ="ccc"
ABC_XYZ="ddd"
```

这种形式下，只有第一行会生效，其余 `ABC_XYZ` 配置行不会生效。


## 查看网卡速率

以 2 秒为刷新间隔显示网络接口的实时流量统计：

```sh
# systat -if 2
```

## 查看 FreeBSD 下载流量（bwm-ng）

```sh
# pkg install bwm-ng	# 安装 bwm-ng
# bwm-ng
  bwm-ng v0.6.3 (probing every 0.500s), press 'h' for help
  input: getifaddrs type: rate
  /         iface                   Rx                   Tx                Total
  ==============================================================================
              em0:           2.04 MB/s            6.03 KB/s            2.05 MB/s
              lo0:           0.00  B/s            0.00  B/s            0.00  B/s
        vm-public:           2.04 MB/s            2.05 MB/s            4.09 MB/s
             tap0:           5.49 KB/s            2.04 MB/s            2.04 MB/s
  ------------------------------------------------------------------------------
            total:           4.09 MB/s            4.09 MB/s            8.18 MB/s
```

按字母 `d` 可以切换流量显示格式，按 `h` 可以查阅更多使用方法。

