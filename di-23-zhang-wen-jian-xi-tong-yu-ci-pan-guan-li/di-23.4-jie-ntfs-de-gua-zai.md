# 23.4 Windows 文件系统

## NTFS

### 安装 ntfs-3g

由于 [Bug 206978 - sysutils/fusefs-ntfs: Disable UBLIO as it breaks mkntfs](https://bugs.freebsd.org/bugzilla/show_bug.cgi?id=206978) 和 [Bug 194526 - sysutils/fusefs-ntfs: ntfs-3g with libublio lost files](https://bugs.freebsd.org/bugzilla/show_bug.cgi?id=194526) 的原因，请勿使用 pkg 安装，请使用 Ports：


```sh
# cd /usr/ports/filesystems/ntfs
# make config
```

![FreeBSD 安装 ntfs-3g](../.gitbook/assets/ntfs1.png)

取消勾选 `UBLIO`，再编译安装：

```sh
# make BATCH=yes install clean
```

### 配置 ntfs-3g

将你的 NTFS 格式的硬盘/U 盘插入计算机。这时候你会看到它的设备名，例如 `da0`（见 `/dev/da0`）。

编辑 `/etc/rc.conf` 文件，将 fusefs 内核模块加入系统启动加载列表：


```sh
# sysrc kld_list+="fusefs"
```

### 创建 NTFS 分区

#### MBR 分区表

```sh
# gpart create -s mbr da0   # 在 da0 磁盘上创建 MBR 分区表，如果磁盘已为 MBR 分区表，则可跳过
# gpart add -t ntfs da0     # 在 da0 磁盘上添加 NTFS 类型的分区
```

#### GPT 分区表

```sh
# gpart create -s gpt da0  # 在 da0 磁盘上创建 GPT 分区表，如果磁盘已为 GPT 分区表，则可跳过
# gpart add -t ntfs da0  # 在 da0 磁盘上添加 NTFS 类型的分区
```

### 格式化 NTFS 分区

在 `/dev/da0s1` 分区上创建 NTFS 文件系统：

```sh
# mkntfs -vf /dev/da0s1
```

- `-f` 表示快速格式化。
- `-v` 表示详细输出。


### 参考文献

- [NTFS on FreeBSD](https://www.gridbugs.org/ntfs-on-freebsd/)

### 自动挂载 NTFS

为了开机自动挂载，修改 `/etc/fstab` 文件，加入：

```sh
/dev/da0s1  /media/NTFS ntfs  rw,mount_prog=/usr/local/bin/ntfs-3g,late  0  0
```

将 `/dev/da0s1` 挂载到 `/media/NTFS`。

使用 ntfs-3g 驱动以读写模式挂载，`late` 表示延迟挂载。

### 手动挂载 NTFS

- 使用 ntfs-3g 挂载 `/dev/da0s1` 到 `/media/NTFS`，设置读写权限，并指定文件所有者和权限掩码：

```sh
# ntfs-3g  /dev/da0s1  /media/NTFS   -o  rw,uid=1000,gid=1000,umask=0
```

- 如果不确定哪个磁盘分区是 NTFS，可以使用命令检测 `/dev/da0s1` 分区的文件系统类型：


```sh
# fstyp /dev/da0s1
```

- 如果在挂载过程中出现报错，可尝试删除休眠文件：

```sh
# ntfs-3g  /dev/da0s1 /mnt/NTFS -o remove_hiberfile
```

使用 ntfs-3g 命令将 `/dev/da0s1` 挂载到 `/mnt/NTFS`，并删除休眠文件以解除锁定。


- 如果还是有问题：修复 `/dev/da0s1` 上的 NTFS 文件系统错误（轻量修复，类似 Windows chkdsk）：

```sh
# ntfsfix /dev/da0s1
```

然后重新挂载。

### 参考文献

- [ntfs-3g manpage](https://www.freebsd.org/cgi/man.cgi?query=ntfs-3g&format=html)，ntfs-3g 各种参数。

## FAT32 文件系统

在使用 `gpart show` 命令时，FAT32 文件系统通常被显示为 `ms-basic-data`。

显示 `nda1` 磁盘及其分区的详细信息，包括起始位置、大小和类型：

```sh
# gpart show -p nda1  # 已忽略其他无用输出信息
=>      34  41942973    nda1  GPT  (20G)
  29360128   4194304  nda1p3  ms-basic-data  (2.0G) # 即为 fat32
```

>**注意**
>
>必须显式声明文件系统类型才能挂载

将 `/dev/nda1p3` 分区挂载为 msdosfs 文件系统，并显示挂载过程信息：

```sh
# mount -v -t msdosfs  /dev/nda1p3  /mnt  # 测试挂载。-v 参数用于显示详细信息（Verbose）；-t 参数用于指定文件系统类型
/dev/nda1p3 on /mnt (msdosfs, local, writes: sync 1 async 0, reads: sync 512 async 0, fsid 7d00000032000000, vnodes: count 1 )
# ls /mnt/  # 列出挂载目录下的内容
me	test1	test2
# umount /mnt  # 卸载文件系统
```

