# 23.1 自动挂载文件系统


## automount 自动挂载

>**注意**
>
>`automount` 可能存在权限限制问题；如果需要更精细的权限控制，请使用 DSBMD。

automount 支持的文件系统包括 NTFS、FAT、exFAT、EXT2、EXT3、EXT4、UFS、HFS、XFS 和 ISO9660。

### 安装 automount

- 使用 pkg 安装：

```sh
# pkg install automount
```

- 或者使用 Ports 安装：

```sh
# cd /usr/ports/filesystems/automount/
# make install clean
```

即可。

## DSBMD 自动挂载

DSBMD 是 FreeBSD 的介质/文件系统类型检测守护进程，它允许客户端挂载存储设备。它配置为开箱即用。

### 安装 DSBMD

- 使用 pkg 安装：

```sh
# pkg install dsbmd       # DSBMD 守护进程
# pkg install dsbmc-cli   # DSBMC 命令行客户端
# pkg install dsbmc       # DSBMC Qt 图形界面客户端
```

- 或者使用 Ports 安装：

```sh
# cd /usr/ports/filesystems/dsbmd/ && make install clean        # 编译并安装 dsbmd 守护进程
# cd /usr/ports/filesystems/dsbmc-cli/ && make install clean   # 编译并安装 dsbmc 命令行客户端
# cd /usr/ports/filesystems/dsbmc/ && make install clean       # 编译并安装 dsbmc Qt 图形界面客户端
```

客户端可根据需要选择安装一个即可；在桌面环境下，推荐使用 `dsbmc` 图形界面客户端以获得更方便的操作体验。


### 配置 DSBMD

>**技巧**
>
>使用时分为守护进程和客户端两部分。客户端向 DSBMD 请求挂载、卸载或弹出介质，也可以设置 CD/DVD 的读取速度；守护进程负责执行这些请求。守护进程作为系统进程拥有执行所有操作的权限，而客户端作为普通用户进程受限于权限设置。对于权限不足的用户，其挂载请求将由守护进程根据配置文件中的用户和组设定决定是否允许执行。

守护进程配置文件在 `/usr/local/etc/dsbmd.conf`。

默认情况下，属于 `wheel` 和 `operator` 组的用户被允许挂载设备；如需其他用户挂载，可修改配置文件中的相关设置。

启用守护进程：

```sh
# service dsbmd enable   # 设置 dsbmd 守护进程开机自启
# service dsbmd start    # 启动 dsbmd 守护进程
```

#### Qt 客户端

`dsbmc` 客户端只有在运行时才会向守护进程发送请求，因此需在桌面环境中启动该客户端。

启动 `dsbmc` 后，可在系统托盘区域看到其图标。

![systray](../.gitbook/assets/dsbmd_dsbmc_systray.png)

打开主窗口，`preferences`-> `general settings`, 勾选 `automatically mount devices` 以使用自动挂载

![图形界面](../.gitbook/assets/dsbmd_dsbmc_gui.png)

![设置自动挂载](../.gitbook/assets/dsbmd_dsbmc_options.png)

插入 U 盘后，系统桌面会显示挂载提示信息：

![插入挂载提示](../.gitbook/assets/dsbmd_dsbmc_add_tip.png)

默认情况下挂载点位于 `/media` 目录下，并且挂载点的属主为客户端用户。

![mount 信息](../.gitbook/assets/dsbmd_dsbmc_userperm.png)

##### Xfce 自动启动

点击 `设置` ——> `会话和启动`，配置如下：

![开机自启](../.gitbook/assets/dsbmd_dsbmc_7.png)

#### 命令行客户端

启动 `dsbmc-cli` 命令行客户端：

```sh
$ dsbmc-cli
```

- 常用参数包括：
  - `-e`：弹出设备
  - `-m`：挂载设备
  - `-u`：卸载设备

可以在 shell 启动文件或桌面启动文件（例如 `~/.xinitrc`、`~/.xprofile`）中加入以下命令：


```ini
dsbmc-cli -a &
```

这样可以以后台方式启动 `dsbmc-cli` 并启用自动连接；该方式没有图形界面提示。


### 守护进程配置（配置文件 `/usr/local/etc/dsbmd.conf`）

默认配置通常可以正常工作；如需进行更细致的挂载控制，则需修改守护进程的配置文件，该文件路径为 `/usr/local/etc/dsbmd.conf`。

#### usermount 说明

启用以普通用户身份挂载设备的功能：

```sh
# usermount - Controls whether DSBMD mounts devices as user. This requires the
# sysctl variable vfs.usermount is set to 1.
usermount = true
```

配置文件默认启用了 `usermount` 选项，但要使其生效，还需在系统变量中启用 `vfs.usermount`，可在 `/etc/sysctl.conf` 文件中写入：

```sh
vfs.usermount=1
```

以允许普通用户执行文件系统挂载操作。

- 启用 `usermount` 时，挂载程序将以普通用户身份执行并使挂载点归该用户所有；未启用 `usermount` 时，挂载程序以 `root` 用户身份执行。
- 无论是否开启 `usermount`，挂载点的属主都是客户端用户。

#### 设置允许自动挂载的用户

允许 operator 和 wheel 组的成员连接：

```ini
# allow_users - Comma separated list of users who are allowed to connect.
# allow_users = jondoe, janedoe

# allow_groups - Comma separated list of groups whose members are allowed
# to connect.
allow_groups = operator, wheel
```

通过修改 `allow_users` 和 `allow_groups` 来管理可以使用自动挂载的用户。

#### 修改挂载点及其下文件目录访问权限（示例为 NTFS）

以挂载 NTFS 文件系统为例，修改文件访问权限为 `640`（rw-r-----），目录访问权限为 `750`（rwxr-x---）。

```ini
# …………以上配置内容省略…………

ntfs_mount_cmd = "/usr/local/bin/ntfs-3g -o \"uid=${DSBMD_UID},gid=${DSBMD_GID}\" ${DSBMD_DEVICE} \"${DSBMD_MNTPT}\""

# …………中间配置内容省略…………

ntfs_mount_cmd_usr = "/sbin/mount_fusefs auto \"${DSBMD_MNTPT}\" ntfs-3g ${DSBMD_DEVICE} \"${DSBMD_MNTPT}\""

# …………以下配置内容省略…………
```

有关 NTFS 的挂载配置有两种命令：启用 `usermount` 时使用 `ntfs_mount_cmd_usr`，否则使用 `ntfs_mount_cmd`。示例如下：

```ini
# …………以上配置内容省略…………

# 使用 ntfs-3g 挂载 NTFS 文件系统，设置挂载后文件权限掩码 fmask=137、目录权限掩码 dmask=027，并指定属主 UID 与 GID
ntfs_mount_cmd = "/usr/local/bin/ntfs-3g -o \"uid=${DSBMD_UID},gid=${DSBMD_GID},fmask=137,dmask=027\" ${DSBMD_DEVICE} \"${DSBMD_MNTPT}\""  

# …………中间配置内容省略…………

# 使用 mount_fusefs 以普通用户方式挂载 NTFS 文件系统，设置文件和目录权限掩码 fmask=137、dmask=027
ntfs_mount_cmd_usr = "/sbin/mount_fusefs auto \"${DSBMD_MNTPT}\" ntfs-3g -o fmask=137,dmask=027 ${DSBMD_DEVICE} \"${DSBMD_MNTPT}\""  

# …………以下配置内容省略…………
```

这里为 `ntfs-3g` 指定了挂载选项中的文件权限掩码 `fmask=137` 和目录权限掩码 `dmask=027`，用于控制挂载后文件和目录的权限设置。

![改变挂载权限](../.gitbook/assets/dsbmd_customperm.png)
