# 23.2 Linux 文件系统

本文示例环境：

```sh
# gpart show -p nda1        # 显示设备 nda1 的分区信息
=>      34  41942973    nda1  GPT  (20G)
        34      2014          - free -  (1.0M)
      2048   1339392  nda1p5  linux-data  (654M) # ext2
   1341440  19630080  nda1p1  linux-data  (9.4G) # ext4
  20971520   8388608  nda1p2  linux-data  (4.0G) # btrfs
  29360128   4194304  nda1p3  ms-basic-data  (2.0G) # fat32
  33554432   8386560  nda1p4  linux-data  (4.0G) # xfs
  41940992      2015          - free -  (1.0M)
```

`-p` 参数可显示完整设备路径。

示例分区中预置了一些文件和目录，用于验证挂载结果。

## EXT 系列文件系统

fusefs-ext2 虽然名为 ext2，但它也可以访问 ext3 和 ext4 文件系统。

### 安装 fusefs-ext2

- 使用 pkg 安装：

```sh
# pkg install fusefs-ext2
```

- 或者使用 Ports 安装：

```sh
# cd /usr/ports/filesystems/ext2/ 
# make install clean
```

### 加载模块

将内核模块 ext2fs 添加到开机加载列表：

```sh
# sysrc kld_list+="ext2fs"
```

### 挂载磁盘

- 创建挂载目录 `/home/ykla/test`：

```sh
$ mkdir -p /home/ykla/test # 创建示例挂载目录，请根据实际路径调整，下同
```

- 将 `nda1p1` 分区挂载到 `/home/ykla/test`
  
```sh
# fuse-ext2 /dev/nda1p1 /home/ykla/test # 挂载分区，默认只读
Mounting /dev/nda1p1 Read-Only.
Use 'force' or 'rw+' options to enable Read-Write mode
# ls /home/ykla/test/ # 列出挂载目录内容
lost+found	test		test.pdf
```

- 将 `nda1p1` 分区以读写模式挂载到 `/home/ykla/test`：

```sh
# fuse-ext2 -o rw+ /dev/nda1p1 /home/ykla/test # 挂载磁盘分区为可写
# ls /home/ykla/test/ # 查看挂载目录内容
lost+found	test		test.pdf
# cd /home/ykla/test/ # 切换到挂载路径
root@ykla:/home/ykla/test # touch my.txt # 创建测试文件以验证写入
root@ykla:/home/ykla/test # ls # 列出挂载目录内容
lost+found	my.txt		test		test.pdf
```

## Btrfs、XFS 和 Ext4 文件系统

### 安装 fusefs-lkl

- 使用 pkg 安装：

```sh
# pkg install fusefs-lkl
```

- 或者使用 Ports 安装：

```sh
# cd /usr/ports/filesystems/lkl/ 
# make install clean
```

### 将 FUSE 内核模块加入开机加载列表

将 fusefs 内核模块添加到开机加载列表：

```sh
# sysrc kld_list+="fusefs"
```

### 测试挂载 Btrfs 分区

使用 `lklfuse` 将 Btrfs 分区 `nda1p2` 挂载到 `/home/ykla/btrfs`：

```sh
# mkdir -p /home/ykla/btrfs # 创建挂载目录
# lklfuse -o type=btrfs /dev/nda1p2 /home/ykla/btrfs # 挂载磁盘分区
# ls /home/ykla/btrfs # 查看挂载目录内容
test1	test2	test3	test4
```

### 测试挂载 XFS 分区

使用 `lklfuse` 将 XFS 分区 `nda1p4` 挂载到 `/home/ykla/xfs`：

```sh
# mkdir -p /home/ykla/xfs # 创建挂载目录
# lklfuse -o type=xfs  /dev/nda1p4 /home/ykla/xfs # 挂载磁盘分区
# ls /home/ykla/xfs # 查看挂载目录内容
cfc	test1	test2
```

## 故障排除与未竟事宜

### 如何卸载文件系统

待完善内容。

### 如何持久化挂载

即如何将挂载写入 `/etc/fstab`。

待解决。

## 参考文献

- [mount linux ext4 drives on Freebsd](https://forums.freebsd.org/threads/mount-linux-ext4-drives-on-freebsd.74414/)（FreeBSD 论坛讨论文章）
- [XFS support](https://forums.freebsd.org/threads/xfs-support.61449/)（FreeBSD 论坛 XFS 支持讨论）
