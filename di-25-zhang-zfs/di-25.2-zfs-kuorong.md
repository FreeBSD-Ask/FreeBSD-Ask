# 25.2 ZFS 磁盘扩容

## 磁盘扩容

>**警告**
>
>ZFS 文件系统只能扩展，不能缩小。因此无法撤销更改。

>**注意**
>
>此方法仅适用于向后扩展，如果 freebsd-zfs 分区前方有空闲空间，则无法使用此方法进行扩展。

显示当前磁盘分区表和分区信息：

```sh
# gpart show
=>       40  167772087  nda0  GPT  (80G)
         40     532480     1  efi  (260M)
     532520       1024     2  freebsd-boot  (512K)
     533544        984        - free -  (492K)
     534528    4194304     3  freebsd-swap  (2.0G)
    4728832  142071775     4  freebsd-zfs  (68G)
  146800607   20971520        - free -  (10G)
```

可以看到，`free` 空闲空间是 10GB。

选择对第 4 个分区进行扩容：

```sh
# gpart resize -i 4 nda0	# 调整 nda0 磁盘上第 4 个分区的大小
nda0p4 resized
```

再显示当前磁盘分区表和分区信息：

```sh
# gpart show
=>       40  167772087  nda0  GPT  (80G)
         40     532480     1  efi  (260M)
     532520       1024     2  freebsd-boot  (512K)
     533544        984        - free -  (492K)
     534528    4194304     3  freebsd-swap  (2.0G)
    4728832  163043295     4  freebsd-zfs  (78G)
```

列出系统中所有 ZFS 池及其状态信息：

```sh
# zpool list
NAME    SIZE  ALLOC   FREE  CKPOINT  EXPANDSZ   FRAG    CAP  DEDUP    HEALTH  ALTROOT
zroot  67.5G  2.20G  65.3G        -         -     2%     3%  1.00x    ONLINE  -	# 可以观察到容量仍为 67.5G，尚未扩展
```

显示 ZFS 池的详细状态信息，包括健康状况和错误信息：

```sh
# zpool status
  pool: zroot
 state: ONLINE
status: Some supported and requested features are not enabled on the pool.
	The pool can still be used, but some features are unavailable.
action: Enable all features using 'zpool upgrade'. Once this is done,
	the pool may no longer be accessible by software that does not support
	the features. See zpool-features(7) for details.
config:

	NAME        STATE     READ WRITE CKSUM
	zroot       ONLINE       0     0     0	# 池名为默认的 zroot
	  nda0p4    ONLINE       0     0     0	# 对应分区为 nda0p4

errors: No known data errors
```

扩展 ZFS 池：

```sh
# zpool online -e zroot nda0p4	# 对 ZFS 池 zroot 中的 nda0p4 分区进行在线扩展
```

查看扩容后的所有 ZFS 池及其容量、使用情况和健康状态：

```sh
# zpool list
NAME    SIZE  ALLOC   FREE  CKPOINT  EXPANDSZ   FRAG    CAP  DEDUP    HEALTH  ALTROOT
zroot  77.5G  2.20G  75.3G        -         -     2%     2%  1.00x    ONLINE  -	# 扩容完成后显示的可用容量为 75.3G，符合预期
```

已经扩展完成。

### 参考文献

- [Solved-extend ZFS partition](https://forums.freebsd.org/threads/extend-zfs-partition.55964/)

## 附录

可以通过 `gpart show` 命令获取分区编号，也可以使用参数 `-p` 以完整路径显示所有磁盘及分区信息

```sh
# gpart show -p
=>       40  244277168    mmcsd0  GPT  (116G)
         40     532480  mmcsd0p1  efi  (260M)
     532520       2008            - free -  (1.0M)
     534528  243740672  mmcsd0p2  freebsd-zfs  (116G)
  244275200       2008            - free -  (1.0M)

=>       34  976773101    nda0  GPT  (466G)
         34          6          - free -  (3.0K)
         40     567256  nda0p1  efi  (277M)
     567296  419436064  nda0p2  ms-basic-data  (200G)
  420003360  310592132  nda0p3  ms-basic-data  (148G)
  730595492          4          - free -  (2.0K)
  730595496  177626968  nda0p4  ms-basic-data  (85G)
  908222464   67100672  nda0p5  freebsd-swap  (32G)
  975323136    1445937  nda0p6  ms-recovery  (706M)
  976769073       4062          - free -  (2.0M)
```

- 打印分区类型 GUID（适用于 GPT）或原始分区类型（适用于 MBR）

以可重现和完整路径形式显示磁盘及分区信息：

```sh
# gpart show -rp
=>       40  244277168    mmcsd0  GPT  (116G)
         40     532480  mmcsd0p1  c12a7328-f81f-11d2-ba4b-00a0c93ec93b  (260M)
     532520       2008            - free -  (1.0M)
     534528  243740672  mmcsd0p2  516e7cba-6ecf-11d6-8ff8-00022d09712b  (116G)
  244275200       2008            - free -  (1.0M)

=>       34  976773101    nda0  GPT  (466G)
         34          6          - free -  (3.0K)
         40     567256  nda0p1  c12a7328-f81f-11d2-ba4b-00a0c93ec93b  (277M)
     567296  419436064  nda0p2  ebd0a0a2-b9e5-4433-87c0-68b6b72699c7  (200G)
  420003360  310592132  nda0p3  ebd0a0a2-b9e5-4433-87c0-68b6b72699c7  (148G)
  730595492          4          - free -  (2.0K)
  730595496  177626968  nda0p4  ebd0a0a2-b9e5-4433-87c0-68b6b72699c7  (85G)
  908222464   67100672  nda0p5  516e7cb5-6ecf-11d6-8ff8-00022d09712b  (32G)
  975323136    1445937  nda0p6  de94bba4-06d1-4d40-a16a-bfd50179d6ac  (706M)
  976769073       4062          - free -  (2.0M)
```

- 显示磁盘 `mmcsd0` 的详细分区信息：

```sh
# gpart list mmcsd0
```

### 参考文献

- [GPT 分区详解](https://www.jinbuguo.com/storage/gpt.html)，GPT 基础知识
- [如何轻松改变分区类型 ID？试试这 2 种方法！](https://www.disktool.cn/content-center/change-partition-type-id-2111.html)，分不清分区类型 ID 和分区 UUID 的可以参考此文。~~旧时，安装过黑苹果的人应该都设置过分区类型 ID。~~

## 故障排除

### ZFS 无法向前扩展

**错误示例方法**

>**警告**
>
>此方法不正确，请勿在生产环境中尝试。

如果使用 ZFS 作为 `/` 根文件系统：

```sh
# gpart add -t freebsd-zfs -a 4k -s 210751598 -l add100G diskid/DISK-FXS690MQ233011234   # 在指定磁盘上添加 FreeBSD ZFS 分区，4K 对齐，大小为 210751598 个扇区，标签为 add100G
# zpool add root /dev/gpt/add100G	# 将新分区添加到 root ZFS 池
```

重启后，启动加载器会报错 `ZFS: i/o error - all block copies unavailable`。

待探索其他方案。

#### 参考文献

- [FreeBSD root on ZFS 千古奇坑](https://dieken.gitlab.io/posts/bsd-as-desktop-system/)，不知道有无关联，但是报错是相同的
- [10.1 doesn't boot anymore from zroot after applying p25](https://forums.freebsd.org/threads/10-1-doesnt-boot-anymore-from-zroot-after-applying-p25.54422/#post-308876)，论坛的反馈
