# 26.3 配置 OpenBSD

## 初次进入系统后获取驱动

第一次进入系统后，OpenBSD 会自动检测 WiFi、显卡和声卡，并下载相关驱动。请静待几分钟，待其自动更新。由于境外网站连接可能不稳定，如果等待时间过长，可按 `Ctrl` + `C` 取消（安装系统过程中请不要执行此操作，建议断开网络），系统启动后可运行 `fw_update` 重新获取驱动。

由于各种原因，新版本在下载驱动时可能会遇到超时错误，可多次尝试下载。运行 `fw_update` 后，如有驱动下载失败，可记录其名称，然后直接访问 [OpenBSD 官方固件网站](http://firmware.openbsd.org/firmware/) 手动获取，并注意匹配版本。解压驱动包，将内部驱动文件复制到 `/etc/firmware/` 目录下，然后重启系统。

例如，`inteldrm-firmware-xxx.tgz` 是 Intel 显卡驱动，解压后在驱动的 firmware 目录下会看到 i915 目录，可执行以下操作：

```sh
# mkdir -p /etc/firmware/i915                         # 创建 i915 固件存放目录
# cp -r inteldrm-firmware-xxx/firmware/i915/* /etc/firmware/i915/  # 复制 Intel i915 DRM 固件文件到系统目录
```

同理，`amdgpu-firmware-xxx.tgz` 是 AMD 显卡驱动，解压后在驱动的 firmware 目录下会看到 amdgpu 目录，可执行以下操作：

```sh
# mkdir -p /etc/firmware/amdgpu                         # 创建 amdgpu 固件存放目录
# cp -r amdgpu-firmware-xxx/firmware/amdgpu/* /etc/firmware/amdgpu/  # 复制 AMD GPU 固件文件到系统目录
```

其他驱动的操作方法与此类似。

## 配置 doas 以使用管理员权限

首先以 root 账号登录系统。执行命令将 doas 示例配置文件复制到 `/etc` 目录：

```sh
# cp /etc/examples/doas.conf /etc/
```

从模板复制的 `/etc/doas.conf` 文件默认应包含 `permit keepenv :wheel` 这一行（要求用户属于 wheel 组才能使用 doas 命令，`keepenv` 表示保留当前用户的环境变量）。


如需 doas 免密码，应修改为 `permit nopass keepenv :wheel`。

若希望仅让单个用户免密码使用 doas，可使用 `permit nopass keepenv 用户名 as root`，其中将“用户名”替换为实际用户名。

## 更新与升级

获取并应用 OpenBSD 官方发布的安全补丁：

```sh
# syspatch
```

执行 OpenBSD 系统升级操作：

```sh
# sysupgrade
```

下载并更新系统固件文件：

```sh
# fw_update
```

更新系统中已安装的软件包到最新版本：

```sh
# pkg_add -u
```

将指定用户的默认登录 shell 修改为 bash：

```sh
# chsh -s /usr/local/bin/bash 用户名
```

## 挂载可移动磁盘

### 新建挂载点

创建多个 U 盘挂载目录，如目录不存在则一并创建:

```sh
# mkdir -p /media/usb1 /media/usb2 /media/usb3 /media/usb4
```

### 查看盘符

使用 `dmesg` 命令来查看新插入的盘符，如格式为 fat32 的 U 盘，可能在 OpenBSD 系统里盘符为 `sd1`。

### 检查分区

如果插入的盘符为 `sd1`，则输入 `disklabel sd1` 查看 `sd1` 磁盘的分区信息，结果如下：


```sh
# disklabel sd1
                size           offset  fstype [fsize bsize   cpg]
 c:         60062500                0  unused
 i:         60062244              256   MSDOS
```

### 挂载

由上则可知分区为 `i`，使用以下命令将 `sd1i` 分区挂载到目录 `/media/usb1`：

```sh
# mount /dev/sd1i /media/usb1
```

### 其它文件系统

OpenBSD 可以挂载的外接存储格式包括 NTFS（需安装软件包 `ntfs_3g`）、ext2/ext3 以及 CD-ROM，具体命令如下：

```sh
# mount /dev/sd3i /media/usb1       # 将 FAT32 分区 sd3i 挂载到 /media/usb1
# mount_ntfs /dev/sd2k /media/usb2  # 将 NTFS 分区 sd2k 挂载到 /media/usb2
# mount /dev/sd1l /media/usb3       # 将 ext2/ext3 分区 sd1l 挂载到 /media/usb3
# mount /dev/cd0a /media/usb4       # 将 CD-ROM 设备 cd0a 挂载到 /media/usb4
```

### 卸载磁盘

卸载挂载在 /media/usb1 的文件系统：

```sh
# umount /media/usb1
```

### 挂载安卓设备

新近安卓系统的存储设备通常采用 MTP 协议映射，需要相应的 MTP 软件来管理手机文件。与 Linux 不同，OpenBSD 上可用的软件较少，此处使用 `simple-mtpfs` 完成挂载操作。

安装 `simple-mtpfs` 软件包，用于挂载 MTP 设备：

```sh
# pkg_add simple-mtpfs
```

挂载安卓设备的流程：

```sh
# pkg_add simple-mtpfs                        # 安装 simple-mtpfs，用于挂载 MTP 设备
# mkdir -p /media/mtp                          # 创建 MTP 设备挂载目录
# chmod 755 /media/mtp                          # 设置挂载目录权限，允许用户访问
# simple-mtpfs -o allow_other /media/mtp       # 将 MTP 设备挂载到 /media/mtp，允许其他用户访问
# umount /media/mtp                             # 卸载挂载的 MTP 设备
```

除了安卓手机，安卓电纸书等设备也可以使用上述方法挂载。

## WiFi

在 OpenBSD 中，WiFi 网络的配置文件通常为 `hostname.if`，其中 `if` 为 WiFi 驱动名称加序号。例如，一台笔记本 WiFi 型号为 rtl8188cu，OpenBSD 下的驱动为 rtwn，序号从 0 开始。为了让系统自动连接 WiFi，可编辑 `/etc/hostname.rtwn0` 文件，并添加以下内容：


```ini
dhcp                                # 通过 DHCP 自动获取网络配置
join WiFi名称 wpakey WiFi密码        # 连接指定的 WiFi，无线网络名称为 WiFi名称，密钥为 WiFi密码
```

保存文件后即可生效。

## 加载触摸板

编辑 `/etc/wsconsctl.conf` 文件，添加一行 

```ini
mouse.tp.tapping=1
```

以启用触控板轻点点击（Tap-to-Click）功能。

## 加载多线程

编辑 `/etc/sysctl.conf` 文件，添加一行 `hw.smt=1` 以启用 CPU 超线程（Simultaneous Multithreading，SMT）。

```sh
# sysctl hw.smt=1  # 立刻生效但非永久化设置
hw.smt: 0 -> 1
```

查看当前在线的 CPU 核心数量

```sh
# sysctl hw.ncpuonline
hw.ncpuonline=4
```

## 关机

OpenBSD 系统没有可用的 `poweroff` 命令。

要关闭系统并切断电源，请执行命令：

```sh
# halt -p
```

或者使用命令立即关闭系统并停止所有服务：

```sh
# shutdown -h now
```

## HTTP 代理

设置 HTTP 代理地址和端口：

```sh
$ export http_proxy=http://192.168.X.X:7890
```

>**注意**
>
>此处的环境变量 `http_proxy` 必须为小写，使用大写名称将不会生效。


## 相关资料

- [OpenBSD FAQ](https://www.openbsd.org/faq/)—[中文版在此](https://openbsd-zh-association.github.io/docs-openbsd-zh/)
- *Absolute OpenBSD, 2nd Edition: Unix for the Practical Paranoid*，ISBN 978-1593274764，No Starch Press
- [Installing OpenBSD 7.3 on your laptop is really hard (not)](https://www.k58.uk/openbsd.html)

