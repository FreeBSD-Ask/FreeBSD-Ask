# 26.6 在 RISC-V 开发板上安装 OpenBSD

本文基于 StarFive VisionFive 2 与 OpenBSD 7.4

>**警告**
>
>在阅读本文之前，请读者务必先查阅 [https://doc.rvspace.org/VisionFive2/PDF/VisionFive2\_QSG.pdf](https://doc.rvspace.org/VisionFive2/PDF/VisionFive2_QSG.pdf)，否则可能无法理解本文内容。


![StarFive VisionFive 2](../.gitbook/assets/vf2.png)

## 安装前准备

- 一块支持 OpenBSD 的 RISC-V 开发板，本文以 StarFive VisionFive 2 为例
- 一张 SD 卡，至少 8GB
- 一根 USB TTL 串口线，本文使用 FT232 芯片（推荐使用 CH340 芯片以获得更好兼容性）
- 通过串口线与 StarFive VisionFive 2 交互的计算机
- 一台 tftp 服务器（可以是虚拟机，搭建方法参考前文的 PDF）

RISC-V 的启动方式不同于树莓派（树莓派的启动文件通常位于 EFI 分区），通常需要通过 OpenSBI（Open Source Supervisor Binary Interface，相当于 Android 手机的 fastboot）将设备树（DTB）、SPI 和 U-Boot 刷入开发板的闪存（OpenSBI 也位于闪存中，可自行升级，具体方法见前文 PDF），之后才能启动完整系统。

## OpenBSD 镜像准备

从 OpenBSD 官方网站下载镜像文件 `miniroot74.img`。

从 <https://marc.info/?l=openbsd-misc&m=169046816826966&q=p3> 下载 `jh7110-starfive-visionfive-2-v1.3b.dtb` 并上传到 tftp 服务器。

将 `miniroot.img` 烧录到 SD 卡中。本文使用 [BalenaEtcher](https://etcher.balena.io/) 工具进行操作。

启动 VisionFive 2，并在串口输出显示 `Hit any key to stop autoboot` 时，在电脑的串口软件上按任意键，只有成功中断自动启动（autoboot）才能进入 OpenSBI。

串口输出如下：

```sh
U-Boot SPL 2021.10 (Dec 25 2022 - 20:59:18 +0800)
DDR version: dc2e84f0.
Trying to boot from SPI

OpenSBI v1.0
   ____                    _____ ____ _____
  / __ \                  / ____|  _ \_   _|
 | |  | |_ __   ___ _ __ | (___ | |_) || |
 | |  | | '_ \ / _ \ '_ \ \___ \|  _ < | |
 | |__| | |_) |  __/ | | |____) | |_) || |_
  \____/| .__/ \___|_| |_|_____/|____/_____|
        | |
        |_|

……省略一部分……

Model: StarFive VisionFive V2
Net:   eth0: ethernet@16030000, eth1: ethernet@16040000
switch to partitions #0, OK
mmc1 is current device
found device 1
bootmode flash device 1
Hit any key to stop autoboot:  0  # 在电脑的串口软件上按任意键输入，否则会启动没有准备好的 OpenBSD
StarFive #  # 已经进入 OpenSBI
```

## 通过 U‑Boot 设置 IP 并加载 DTB 文件

在 OpenSBI 环境下执行以下操作：

```sh
# dhcp                                     # 启用 DHCP 获取网络配置
# setenv serverip 192.168.1.169            # 设置 TFTP 服务器 IP（示例，需要替换为实际 IP）
# tftpboot ${fdt_addr_r} jh7110-starfive-visionfive-2-v1.3b.dtb  # 通过 TFTP 加载设备树文件
# load mmc 1:1 ${kernel_addr_r} efi/boot/bootriscv64.efi         # 从 MMC 加载 EFI 内核文件
# bootefi ${kernel_addr_r} ${fdt_addr_r}  # 启动 EFI 内核并加载设备树，引导 OpenBSD
```

该镜像从内存启动，可直接覆盖安装。安装过程与标准 OpenBSD 安装相同，关于安装的详细说明请参见其他章节。

如果重启后出现提示 `root device:`，请重新从 TFTP 服务器下载相关文件。

![OpenBSD 7.4 on StarFive VisionFive 2](../.gitbook/assets/obvf2.png)

## 在 OpenBSD 中启用性能模式

如果不进行设置，系统默认 `hw.cpuspeed` 参数为 750（这意味着 CPU 的默认运行频率为 750 MHz）。

临时设置硬件性能策略为高性能模式：

```sh
# sysctl hw.perfpolicy=high
```

将该设置写入系统配置文件以在开机时生效（如果文件不存在，请自行创建）：

```sh
# echo "hw.perfpolicy=high" >> /etc/sysctl.conf
```

## 参考教程

- [Installing OpenBSD 7.3-current on a VisionFive2](https://gist.github.com/csgordon/74658096f7838382b40bd64e11f6983e)
- [Installing OpenBSD 7.4 on a MilkV Mars](https://mzh.io/installing-openbsd-7-4-on-a-milkv-mars)
- [JH7110 - VF2](https://marc.info/?t=169039246400003&r=1&w=2)
