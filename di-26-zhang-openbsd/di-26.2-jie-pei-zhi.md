# 第 26.2 节 配置

## 初次登录

### 获取驱动

第一次进入系统后，OpenBSD 会自动检测 WIFI、显卡和声卡，并下载相关驱动。静等几分钟，待其自行更新。由于境外网站连接困难，如果等待时间过长，可 `Ctrl` + `C` 取消，待进入系统后运行 `# fw_update` 重新获取驱动。

因诸多问题，新版下载驱动时会遇到超时错误，可多次刷新下载重试。也可在运行 `# fw_update` 后，记住获取失败的驱动名，而后直接访问 [OpenBSD 官方固件网站](http://firmware.openbsd.org/firmware/)来手动获取，注意版本。解压驱动包，将内部驱动文件复制到 `/etc/firmware/` 文件夹内，之后重启。

如`inteldrm-firmware-xxx.tgz`为 intel 的显卡驱动，解压该驱动后，发现驱动 firmware 目录下有 i915 的目录。可执行以下操作：

```shell
# mkdir -p /etc/firmware/i915 # 创建文件夹
# cp -r inteldrm-firmware-xxx/firmware/i915/* /etc/firmware/i915/ #复制驱动
```

同理`amdgpu-firmware-xxx.tgz`为 amd 的显卡驱动，解压该驱动后，发现驱动 firmware 目录下有 amdgpu 的目录。可执行以下操作：

```shell
# mkdir -p /etc/firmware/amdgpu # 创建文件夹
# cp -r amdgpu-firmware-xxx/firmware/amdgpu/* /etc/firmware/amdgpu/ #复制驱动
```

其它驱动与此类同。

### 桌面支持（OpenBSD 7.1 及其版本请忽略此项）

旧版本安装时，可能会遇到是否启用 X （图形化）的选项。若是不小心屏蔽了，我们可以重新开启。打开 `/etc/sysctl.conf`，添加一行 `machdep.allowaperture=2`。

### 修改软件源

打开 `/etc/installurl`，将默认源注释掉，改为 `https://mirrors.bfsu.edu.cn/OpenBSD`。此处我们选择了北外源，用户也可选择 [清华镜像源](https://mirrors.tuna.tsinghua.edu.cn/OpenBSD)、 [阿里镜像源](https://mirrors.aliyun.com/openbsd)、 及[南京大学源](https://mirror.nju.edu.cn/OpenBSD) 等。

## 更新

### 普通账号获取权限

以 root 账号登录系统，而后新建 `/etc/doas.conf` 文本，打开`doas.conf`，添加一行 `permit persist :wheel`

### 更新与升级

内核更新：`# syspatch`

系统更新：`# sysupgrade`

驱动升级：`# fw_update`

软件升级：`# pkg_add -u`

修改 shell： `chsh`

示例：`# chsh -s /usr/local/bin/bash 用户名`

## 软件管理

- 查找软件： `# pkg_info -Q XXX`
- 安装软件： `# pkg_add XXX`
- 升级软件： `# pkg_add -iu XXX`

## 挂载可移动磁盘

### 新建挂载点

```shell
# mkdir -p /media/usb1 /media/usb2 /media/usb3 /media/usb4
```

### 查看盘符

使用 `dmesg` 命令来查看新插入的盘符，如格式为 fat32 的 U 盘，可能在 OpenBSD 系统里盘符为 `sd1`。

### 检查分区

如插入的盘符为 `sd1`，则输入 `disklabel sd1` 查看分区情况。如下

```shell
#                size           offset  fstype [fsize bsize   cpg]
 c:         60062500                0  unused
 i:         60062244              256   MSDOS
```

### 挂载

由上则可知分区为 `i`，使用以下命令挂载：

```shell
# mount /dev/sd1i /media/usb1
```

### 其它格式

OpenBSD 可挂载的外接硬盘格式有 NTFS（需要安装软件包 `ntfs_3g`）、ext2/ext3 以及 CD 等，具体命令可参考如下：

```shell
# mount /dev/sd3i /media/usb1       # fat32
# mount_ntfs /dev/sd2k /media/usb2  # NTFS
# mount /dev/sd1l /media/usb3       # ext2/ext3
# mount /dev/cd0a /media/usb4       # CD
```

### 卸载磁盘

```shell
# umount /media/usb1
```

## 挂载安卓设备

最新的安卓系统磁盘都采用 MTP 方式映射，我们需要对应的 mtp 软件来管理手机文件。和 Linux 不同的是， OpenBSD 系统上可用的对应软件较少，这里我们使用 `simple-mtpfs` 来完成任务。

1. 安装软件：`# pkg_add simple-mtpfs`

2. 新建目录：`# mkidr /media/mtp` （如遇错误，可先创建 `/media` 目录）

3. 修改目录权限：`# chmod 755 /media/mtp`

4. 挂载设备：`# simple-mtpfs -o allow_other /media/mtp`

5. 卸载设备：`# umount /media/mtp`

除安卓手机外，安卓电纸书等设备也可以使用上述方式挂载。

## WIFI

OpenBSD 里的 WIFI 网络，配置文件通常是 `hostname.if`，其中 `if` 为 WIFI 驱动名称+序号。如一台笔记本 WIFI 型号为 rtl8188cu，OpenBSD 下驱动为 rtwn，序号从 0 开始。为了让系统自动连接 WIFI，可打开 `/etc/hostname.rtwn0` 文件，而后添加：

```shell
dhcp
join WIFI名称 wpakey WIFI密码
```

保存后即可。

## 其他

### 加载触摸板

打开 `/etc/wsconsctl.conf`，添加一行 `mouse.tp.tapping=1`。

### 加载多线程

打开 `/etc/sysctl.conf`，添加一行 `hw.smt=1`。


### 关机

OpenBSD 无 poweroff 可用。

```shell
# halt -p
```

### HTTP 代理

**注意一定要是小写！此处大写不生效。**

```shell
export http_proxy=http://192.168.X.X:7800
```
### 相关资料

- [OpenBSD FAQ](https://www.openbsd.org/faq/)—[中文版点这](https://openbsd-zh-association.github.io/docs-openbsd-zh/)
- 《Absolute OpenBSD, 2nd Edition: Unix for the Practical Paranoid》，ISBN 978-1593274764，No Starch Press
- [Installing OpenBSD 7.3 on your laptop is really hard (not)](https://www.k58.uk/openbsd.html)

