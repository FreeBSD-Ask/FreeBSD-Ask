# 总线接口与协议

我们知道 M.2 只是一个物理接口，它本质上是一种迷你的 PCIe 接口，可以直接连接物理引脚而无需额外的芯片。

根据 M.2 规范和 PCIe 规范，M.2 接口最大支持 3.3V 3A，约为 10W。


## 总线、接口与协议

我们首先需要区分三个概念：物理接口、总线协议/总线通道和通道/协议。实际上，这些概念可以简化为两个，因为在本质上，通道/协议等同于总线协议/总线通道和物理总线（例如 PCIe、RJ45、Type-C 之类的物理接口、连接器、连接线等）相加——通道/协议是一个泛指，既可以指二者之和，也可以指二者之一，还可以同时指二者。

- 通道 = 协议；
- 物理总线 = 物理接口；
- 物理接口：代指实际的物理连接和传输介质，例如 M.2、Type-C 口、SATA、以太网线、USB 数据线等；
- 总线协议/总线通道：指的是用于数据传输的规则和标准，例如 PCIe 协议、USB 协议、SATA 协议、TCP/IP 协议；
- 总线/通道：总线/通道 = 物理总线/物理介质 + 总线协议/总线通道。


>**注意**
>
>**总线是指整个数据传输路径，是物理总线（即物理连接和传输介质）和总线协议（即数据传输的规则和标准）的组合。**


>例如，可以使用以太网线来传输 HDMI 数字信号。这展示了物理总线的可复用性。
>
>参考 [绿联（UGREEN）HDMI 延长器 50 米 HDMI 转 RJ45 网传网口转换器 单网线网络高清 1080P 视频传输信号放大器 一对装 90811](https://item.jd.com/100053619301.html)。它使用以太网线来延长 HDMI 信号，其传输的物理介质是以太网线，接头是 RJ45。
>
>从设计上讲，以太网线通常使用以太网协议传输数据，物理介质是以太网线，接头是 RJ45。然而，该产品的存在表明，物理总线可以承载不同的信号类型。以太网线作为物理介质，既可以用于传输以太网协议下的 TCP/IP 数据，也可以通过不同的信号编码和转换器传输 HDMI 的数据。
>
>并且该产品在实际传输 HDMI 数据时，并不是使用以太网协议，而是通过 HDMI 协议下的信号编码（TMDS）传输。
>
>参考文献：
>
>- [将 HDMI 信号通过单条网线传输的方法](https://patents.google.com/patent/CN101572074A/zh)


物理接口在理论上决定了其承载的上限和电气性能，如能够承受的电压、电流和功率，IP 等级，以及尺寸规格如多少 X 多少。常见的物理接口包括 M.2、U.2、SATA、USB（包括 Type-C）、HDMI、DP 和 RJ45。

在大多数情况下，我们通常讨论的是物理接口，但严格来说，将物理接口和其承载的协议混为一谈是不准确的。因为任何物理接口在理论上都可以通过适配器相互转换。

>例如，Type-C 接口可以支持 USB2.0、USB3.0、DP、HDMI、Thunderbolt 和 USB PD 等多种协议。因此，M.2 接口在理论上既可以连接 NVMe 硬盘，也可以连接 SATA 硬盘，还可以连接显卡、声卡以及主板上的 PCIe 设备，而无需任何驱动，但可能需要额外的 12V 电源供应。

总线协议（我们将直接连接到 CPU 的通道称为总线，总线本质上也是通道）。现代 x86 计算机通常只有三种总线：**USB**、**SATA**、**PCIe**。

>例如，现代消费者型号的英特尔处理器通常仅直接支持这三种总线。

SATA 协议或 SATA 硬盘之所以慢，是由于协议设计问题造成的，与 SATA 这个物理接口本身关系不大。并且 SATA 协会已经摆烂了，他们认为与其设计更多不兼容传统 SATA 设备的新协议，去改造 SATA 这个总线协议，还不如让用户去用使用 PCIe 硬盘或者直接将 SATA 硬盘接到 PCIe。SATA 目前也兼容了 PCIe 总线。

因为直接连接到 CPU 的通道我们称之为总线协议，因此其他通道则被称为普通协议或通道。对于现代处理器而言，只有 USB、SATA 和 PCIe 这三种总线直接连接到 CPU。而大多数其他设备，如网卡、显卡、声卡、摄像头通常连接到 PCIe 接口。

>需要注意的是，尽管这些设备连接到了 PCIe 总线，但并非所有设备都是直接连接到了 CPU（通常是通过主板上的 DMI 通道转接的）。

我们需要先来介绍一下 2010 以前的大部分 X86 计算机（即三代酷睿以前）的架构：

- CPU——> 前端总线 FSB—> 北桥—> PCI—> 南桥—> PCI—> 其他设备。

>以上 PCI 也可以替换为 PCIe。

但是在 PCIe 和新一代酷睿大规模使用后北桥在主板上就消失了。曾经的北桥负责高速设备（比如内存、集显），南桥负责低速设备（网卡、声卡、摄像头等）。南北桥之前通过 PCI 总线连接。

>在某种意义上，以前的 PS/2 鼠标、PS/2 键盘相当于直连 CPU（北桥）。
>
>但是现在仍然有直连 CPU 的 USB 总线，一样可以接入键盘和鼠标。所以，用是否直连 CPU 来论证 PS/2 接口的优越性是毫无道理可言的。

在现代 x86 CPU 中，已经在主板上看不见北桥了，但是北桥并未真正消失，他只是被集成到了 CPU 而已，并且由若干 CPU 核心负责处理这些，PCIe 总线也从这些核心上面引出。

我们所说的直连到 CPU 的 PCIe，本质上就是之前直连北桥的 PCI。现代 CPU 通过引脚连接到主板，CPU 和主板之间的 PCIe 被英特尔称为 DMI（Direct Media Interface，直接媒体接口），而 AMD 则称之为 PCIe。DMI 3.0x4 相当于 PCIe 3.0x4。

在主板上的设备要么直连到 CPU，要么通过主板上的 DMI 总线转接到 CPU。

由于北桥已经集成到了 CPU 中，看上去就有了两种方式连接 CPU：

- ① CPU -> PCIe（处理器上的 PCIe） -> 设备（任何设备），我们称之为直连 CPU 的 PCIe；

- ② CPU -> PCIe（DMI，芯片组/PCH 上的 PCIe） -> 主板 -> PCIe（或转换成其他接口，如 SATA、USB、M.2） -> 设备。

因此，理论上要获得最大速度，需要使用 ①，但可能会影响 CPU 和设备的稳定性。

同时需要注意，PCIe 并不是无限多的，这由 CPU 的规格决定，一般情况下，英特尔 CPU 可能只有 20 条 PCIe，例如 PCIe 3.0x20，其中的 3.0 表示 PCIe 的版本号，20 表示通道数。

>因此，DMI 的上限也不是无穷大的，如果在主板上安装了很多 PCIe x16 插槽，由于 DMI 通道的限制，这只是看上去很好，但实际上不能达到预期效果（如果插满，肯定不会符合预期）。

>**除了直连到 CPU 的设备外，所有其他设备都共享主板上的 DMI 总线。**

>其实从根本上说无论是否将北桥进行集成没有任何区别。在本质上都是相同的。这是由冯·诺依曼架构所决定的。但在性能和效率上有所提升。

一般来说，任何设备要进行转换，不仅需要在物理上连接（将线连接在一起），还需要在软件层面（即驱动程序）进行适配。例如，所谓 NVMe 转 USB 的正确说法应该是 USB 3.1 Gen 2 到 PCIe Gen3 x2 桥接控制器。这种转换并不是将 NVMe 转换为 USB，而是将 PCIe 转换为 USB。

>并不是因为不需要安装驱动就意味着设备内部没有芯片，因为大多数这类驱动程序都是内置在操作系统中的。

事实上，总线、接口与协议这三者在严格意义上应该是分开的。因此，当我们谈论 M.2 转换为 PCIe 时，只是物理上将它们连接起来，不需要额外的芯片（因此也不需要驱动程序）。但是，如果要将 M.2 支持 SATA，就需要进行协议转换。

>例如，虽然 M.2 物理接口相同，但如果要连接 SATA 硬盘，就必须通过转换芯片进行连接。

>同样，严格来说并不是 SATA 转换为 M.2，而是 SATA 转换为 PCIe，即使用的是 PCIe Gen3 x1 转 2xSATA 桥接控制器。

因此，当我们提及 M.2 NVMe SSD 时，应该明确它是一种 PCIe 硬盘，NVMe 则是基于 PCIe 的应用层协议。就像英特尔连接主板与 CPU 的通道的 DMI 在本质上也是 PCIe 一样。

首先，任何 M.2 在物理上都完全等于 PCIe。无需任何芯片或电平转换。M.2 接口 = mini PCIe，并且在历史上也的确如此。但是 M.2 没有 12V（U.2 接口支持，可以视为增强型的 M.2）。

标准的 PCIe 接口同时供电 3.3V、12V，最大支持 75W。而标准的 M.2 最高支持 3.3V 3A，即 10W。

总线就是协议的一种，无非总线是公用通道，大家都直接或间接兼容而已。真正存在的东西只有两种，物理的接口和软件的协议。与协议分层实际上无关。只要是硬件就可以随便转（硬件本质也是电压电流，电信号随便转）。
